<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Trading Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/dist/date-fns.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f1f5f9; /* slate-100 */
            --bg-secondary: #ffffff; /* white */
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #64748b; /* slate-500 */
            --border-color: #e2e8f0; /* slate-200 */
            --accent-primary: #0079D3;
            --accent-secondary: #FF4500;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        body { 
            font-family: 'IBM Plex Sans', sans-serif;
            background-color: var(--bg-primary); 
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.7;
        }
        .themed-bg, .stat-card, .modal-content, .alert-modal-content {
             background-color: var(--bg-secondary);
             box-shadow: var(--shadow);
        }
        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out, background-color 0.3s; overscroll-behavior: contain; }
        .stat-card { transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        .btn:active { transform: translateY(0); }
        .btn-primary { background-color: var(--accent-primary); color: white; }
        .btn-secondary { background-color: var(--accent-secondary); color: white; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .loader, .loader-sm { border: 2px solid #f3f3f3; border-top: 2px solid var(--accent-primary); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        .loader { width: 30px; height: 30px; border-width: 4px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .alert-modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .alert-modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .alert-modal-content { padding: 2rem; border-radius: 0.5rem; max-width: 90%; width: 400px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease, background-color 0.3s; }
        .alert-modal-overlay.visible .alert-modal-content { transform: scale(1); }
        .tab-active { border-bottom: 2px solid var(--accent-secondary); color: var(--accent-secondary); }
        .tab-inactive { border-bottom: 2px solid transparent; color: var(--text-secondary); }
        
        #trades-table thead, #nav-history-table thead, #cloud-api-table thead {
            background-color: var(--bg-primary);
            border-bottom: 2px solid var(--border-color);
        }
        #trades-table tbody tr, #nav-history-table tbody tr, #cloud-api-table tbody tr {
            border-bottom: 1px solid var(--border-color);
        }
        #trades-table tbody tr:last-child, #nav-history-table tbody tr:last-child, #cloud-api-table tbody tr:last-child {
            border-bottom: none;
        }

        /* Responsive Table */
        @media (max-width: 1023px) {
            #trades-table thead, #nav-history-table thead, #cloud-api-table thead { display: none; }
            #trades-table, #trades-table tbody, #trades-table tr,
            #nav-history-table, #nav-history-table tbody, #nav-history-table tr,
            #cloud-api-table, #cloud-api-table tbody, #cloud-api-table tr { display: block; width: 100%; }
            #trades-table tbody tr, #nav-history-table tbody tr, #cloud-api-table tbody tr { margin-bottom: 1.5rem; border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1rem; background-color: var(--bg-secondary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
            #trades-table tbody td, #nav-history-table tbody td, #cloud-api-table tbody td { display: flex; justify-content: space-between; align-items: center; text-align: right; padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--border-color); }
            #trades-table tbody td:last-child, #nav-history-table tbody td:last-child, #cloud-api-table tbody td:last-child { border-bottom: none; }
            #trades-table tbody td::before, #nav-history-table tbody td::before, #cloud-api-table tbody td::before { content: attr(data-label); font-weight: 600; text-align: left; padding-right: 1rem; color: var(--text-secondary); }
        }
        
        .input { background-color: #f6f7f8; border: 1px solid #edeff1; color: var(--text-primary); font-size: 1rem; padding: 0.75rem; }
        .input::placeholder { color: #a9a9a9; }
        .btn-cancel { background-color: #edeff1; color: #1c1c1c; }
        .btn-cancel:hover { background-color: #e2e2e2; }
        .prose { color: var(--text-secondary); }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose strong { color: var(--text-primary); }
    </style>
</head>
<body class="antialiased">

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="mb-8 p-4 themed-bg rounded-lg shadow-sm flex justify-between items-center">
            <h1 class="text-3xl sm:text-4xl font-bold" style="color: var(--accent-secondary);">r/TradingJournal</h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <!-- Stat Cards Grid -->
                <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="stat-card p-5 rounded-lg sm:col-span-2"><h3 class="text-sm font-medium text-secondary">Total Assets</h3><p id="total-assets" class="text-3xl font-bold mt-1">$0.00</p></div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Current Cash</h3><p id="current-cash" class="text-2xl font-bold mt-1">$0.00</p></div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Unrealized P/L</h3><p id="unrealized-pl" class="text-2xl font-bold mt-1">$0.00</p></div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Total Open P/L (R)</h3><p id="total-open-r" class="text-2xl font-bold mt-1">0.00R</p></div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Total Open Risk (R)</h3><p id="total-open-risk-card" class="text-2xl font-bold mt-1">0.00R</p></div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Realized P/L</h3><p id="realized-pl" class="text-2xl font-bold mt-1">$0.00</p></div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Win Rate</h3><p id="win-rate" class="text-2xl font-bold mt-1">0%</p></div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Profit Factor</h3><p id="profit-factor" class="text-2xl font-bold mt-1">0.00</p></div>
                </section>

                <!-- NAV Chart -->
                <section class="themed-bg p-6 rounded-lg h-80 sm:h-96">
                    <h2 class="text-2xl font-bold mb-4">Net Asset Value (NAV)</h2>
                    <canvas id="nav-chart"></canvas>
                </section>
            </div>

            <!-- Side Column -->
            <aside class="space-y-8">
                 <!-- Portfolio Allocation Chart -->
                 <section id="portfolio-allocation-section" class="themed-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Portfolio Allocation</h2>
                    <div id="allocation-chart-container" class="h-64 flex items-center justify-center">
                        <canvas id="allocation-chart"></canvas>
                        <p id="allocation-placeholder" class="text-slate-400 text-center hidden"></p>
                    </div>
                </section>
                 <!-- Risk Exposure Dashboard -->
                <section id="risk-exposure-dashboard" class="themed-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Risk Exposure</h2>
                    <div class="space-y-4 text-base">
                        <div class="flex justify-between">
                            <span class="font-medium text-secondary">High-Water Mark</span>
                            <span id="high-water-mark" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-secondary">Current Drawdown</span>
                            <span id="current-drawdown" class="font-semibold">$0.00 (0.00%)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-secondary">Total Open Risk</span>
                            <span id="total-open-risk" class="font-semibold">0.00R</span>
                        </div>
                        <div class="flex justify-between items-center mt-3 pt-3 border-t" style="border-color: var(--border-color);">
                            <span class="font-medium text-secondary">Risk Zone</span>
                            <span id="risk-zone" class="px-3 py-1 text-sm font-bold rounded-full"></span>
                        </div>
                    </div>
                </section>

                <section class="themed-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Data Management</h2>
                    <div class="space-y-4">
                        <button id="btn-import" class="btn w-full btn-primary py-2.5 px-4 rounded-md font-semibold">Import Local Data</button>
                        <input type="file" id="file-input" class="hidden" accept=".json">
                        <button id="btn-load-online" class="btn w-full btn-primary py-2.5 px-4 rounded-md font-semibold">Load Online Data</button>
                        <button id="btn-export" class="btn w-full btn-secondary py-2.5 px-4 rounded-md font-semibold">Export Data</button>
                    </div>
                </section>
                
                <section class="themed-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Actions</h2>
                    <div class="space-y-4">
                        <button id="btn-add-trade" class="btn w-full btn-primary py-2.5 px-4 rounded-md font-semibold">Add New Trade</button>
                        <button id="btn-update-stop" class="btn w-full btn-primary py-2.5 px-4 rounded-md font-semibold">Update Trailing Stop</button>
                        <button id="btn-view-stop-history" class="btn w-full btn-primary py-2.5 px-4 rounded-md font-semibold">View Trailing Stop History</button>
                        <button id="btn-exit-trade" class="btn w-full btn-secondary py-2.5 px-4 rounded-md font-semibold">Exit Trade</button>
                        <button id="btn-refresh" class="btn w-full btn-primary py-2.5 px-4 rounded-md font-semibold flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 12M20 20l-1.5-1.5A9 9 0 003.5 12"></path></svg>
                            Refresh Prices
                        </button>
                    </div>
                </section>
                
                <section class="themed-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Configuration & Analysis</h2>
                    <div class="space-y-4">
                        <button id="btn-settings" class="btn w-full bg-slate-600 text-white py-2.5 px-4 rounded-md font-semibold">Set Capital & Risk</button>
                        <button id="btn-provider-settings" class="btn w-full bg-slate-600 text-white py-2.5 px-4 rounded-md font-semibold">Data Provider Settings</button>
                        <button id="btn-cloud-api-settings" class="btn w-full bg-slate-600 text-white py-2.5 px-4 rounded-md font-semibold">Cloud API Settings</button>
                        <button id="btn-cloud-ai-prompt" class="btn w-full bg-slate-600 text-white py-2.5 px-4 rounded-md font-semibold">Cloud AI Prompts</button>
                        <button id="btn-view-stats" class="btn w-full bg-slate-600 text-white py-2.5 px-4 rounded-md font-semibold">View Advanced Stats</button>
                        <hr style="border-color: var(--border-color);">
                        <button id="btn-gen-summary" class="btn w-full btn-secondary py-2.5 px-4 rounded-md font-semibold">âœ¨ Generate Weekly Summary</button>
                        <button id="btn-analyze-portfolio" class="btn w-full btn-secondary py-2.5 px-4 rounded-md font-semibold">ðŸ“ˆ Analyze Current Portfolio</button>
                        <button id="btn-describe-holdings" class="btn w-full btn-secondary py-2.5 px-4 rounded-md font-semibold">ðŸ“„ Describe Trade History</button>
                    </div>
                </section>
            </aside>
        </div>

        <section class="mt-8 themed-bg p-4 md:p-6 rounded-lg shadow">
             <h2 class="text-2xl font-bold mb-4">Trade History</h2>
             <div class="overflow-x-auto">
                <table id="trades-table" class="min-w-full">
                    <thead id="trades-head">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider sortable" data-sort="ticker">Ticker</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider sortable" data-sort="entryDate">Entry Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider sortable" data-sort="entryPrice">Entry Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider sortable" data-sort="currentPrice">Current Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider sortable" data-sort="position">Position</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider sortable" data-sort="initialStop">Initial Stop</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider sortable" data-sort="initialR">Initial Risk (Acct. R)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider sortable" data-sort="trailingStop">Trailing Stop</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider sortable" data-sort="plDollars">P/L $</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider sortable" data-sort="plR">P/L (Acct. R)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider sortable" data-sort="status">Status</th>
                        </tr>
                    </thead>
                    <tbody id="trades-body"></tbody>
                </table>
             </div>
        </section>

        <section class="mt-8 themed-bg p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-2xl font-bold mb-4">NAV History</h2>
            <div id="nav-history-container" class="overflow-x-auto"></div>
        </section>
    </main>

    <!-- Modals -->
    <div id="trade-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Trade</h2>
            <form id="trade-form">
                <input type="hidden" id="trade-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="ticker" class="block text-sm font-medium text-secondary">Ticker</label><input type="text" id="ticker" required class="mt-1 block w-full input"></div>
                    <div><label for="entry-date" class="block text-sm font-medium text-secondary">Entry Date</label><input type="date" id="entry-date" required class="mt-1 block w-full input"></div>
                    <div><label for="entry-price" class="block text-sm font-medium text-secondary">Entry Price</label><input type="number" step="any" id="entry-price" required class="mt-1 block w-full input"></div>
                    <div><label for="position" class="block text-sm font-medium text-secondary">Position</label><input type="number" step="any" id="position" required class="mt-1 block w-full input"></div>
                    <div class="md:col-span-2"><label for="initial-stop" class="block text-sm font-medium text-secondary">Initial Stop</label><input type="number" step="any" id="initial-stop" required class="mt-1 block w-full input"></div>
                    <div class="md:col-span-2"><label for="sector" class="block text-sm font-medium text-secondary">Sector</label><div class="flex items-center space-x-2 mt-1"><input type="text" id="sector" class="block w-full input"><button type="button" id="btn-find-sector" class="btn bg-teal-100 text-teal-700 py-2 px-3 rounded-md text-sm whitespace-nowrap">âœ¨ Find Sector</button></div></div>
                    <div class="md:col-span-2"><label for="tags" class="block text-sm font-medium text-secondary">Tags (comma-separated)</label><input type="text" id="tags" class="mt-1 block w-full input"></div>
                </div>
                
                <hr class="my-6" style="border-color: var(--border-color);">
                <h3 class="text-lg font-semibold mb-4">Trade Psychology</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label for="emotional-state" class="block text-sm font-medium text-secondary">Emotional State</label>
                        <select id="emotional-state" class="mt-1 block w-full input">
                            <option>Neutral</option>
                            <option>Confident</option>
                            <option>Anxious</option>
                            <option>Greedy</option>
                            <option>Fearful</option>
                            <option>FOMO</option>
                            <option>Disciplined</option>
                        </select>
                    </div>
                </div>
                 <div class="mt-4">
                    <label for="psychology-notes" class="block text-sm font-medium text-secondary">Psychology Notes</label>
                    <textarea id="psychology-notes" rows="3" class="mt-1 block w-full input"></textarea>
                </div>
                
                <div class="mt-6 flex justify-between items-center">
                    <button type="button" id="btn-analyze-trade" class="btn bg-purple-100 text-purple-700 py-2 px-4 rounded-md">âœ¨ Analyze</button>
                    <div><button type="button" class="btn-cancel py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn-save btn ml-2 btn-primary text-white py-2 px-4 rounded-md">Save</button></div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="exit-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">Exit Trade</h2>
            <form id="exit-form">
                 <div class="space-y-4">
                    <div><label for="exit-select" class="block text-sm font-medium text-secondary">Select Open Trade</label><select id="exit-select" required class="mt-1 block w-full input"></select></div>
                    <div><label for="exit-date" class="block text-sm font-medium text-secondary">Exit Date</label><input type="date" id="exit-date" required class="mt-1 block w-full input"></div>
                    <div><label for="exit-price" class="block text-sm font-medium text-secondary">Exit Price</label><input type="number" step="any" id="exit-price" required class="mt-1 block w-full input"></div>
                    <div><label for="exit-remarks" class="block text-sm font-medium text-secondary">Exit Remarks</label><textarea id="exit-remarks" rows="3" class="mt-1 block w-full input"></textarea></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-cancel py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn btn-secondary py-2 px-4 rounded-md">Save Exit</button></div>
            </form>
        </div>
    </div>
    
     <div id="stop-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">Update Trailing Stop</h2>
            <form id="stop-form">
                 <div class="space-y-4">
                    <div><label for="stop-select" class="block text-sm font-medium text-secondary">Select Open Trade</label><select id="stop-select" required class="mt-1 block w-full input"></select></div>
                    <div><label for="new-stop" class="block text-sm font-medium text-secondary">New Trailing Stop</label><input type="number" step="any" id="new-stop" required class="mt-1 block w-full input"></div>
                    <div><label for="stop-remarks" class="block text-sm font-medium text-secondary">Remarks</label><textarea id="stop-remarks" rows="2" class="mt-1 block w-full input"></textarea></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-cancel py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn btn-primary py-2 px-4 rounded-md">Update Stop</button></div>
            </form>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">Account & Risk Settings</h2>
            <form id="settings-form">
                 <div class="space-y-4">
                    <h3 class="text-lg font-semibold border-b pb-2" style="border-color: var(--border-color);">Account</h3>
                    <div><label for="set-capital" class="block text-sm font-medium text-secondary">Initial Capital</label><input type="number" id="set-capital" step="any" class="mt-1 block w-full input"></div>
                    <div><label for="set-cash" class="block text-sm font-medium text-secondary">Current Cash</label><input type="number" id="set-cash" step="any" class="mt-1 block w-full input"></div>
                    
                    <h3 class="text-lg font-semibold border-b pb-2 pt-4" style="border-color: var(--border-color);">Risk Management</h3>
                    <div><label for="set-risk-percent" class="block text-sm font-medium text-secondary">Risk Per Trade (% of Capital)</label><input type="number" id="set-risk-percent" step="0.1" class="mt-1 block w-full input"></div>
                    <div><label for="set-moderate-dd" class="block text-sm font-medium text-secondary">Moderate Drawdown Threshold (%)</label><input type="number" id="set-moderate-dd" step="0.1" class="mt-1 block w-full input"></div>
                    <div><label for="set-high-risk-dd" class="block text-sm font-medium text-secondary">High-Risk Drawdown Threshold (%)</label><input type="number" id="set-high-risk-dd" step="0.1" class="mt-1 block w-full input"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-cancel py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn btn-primary py-2 px-4 rounded-md">Save</button></div>
            </form>
        </div>
    </div>

    <div id="provider-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Data Provider Settings</h2>
            <form id="provider-form">
                 <div><label for="alphavantage-key" class="block text-sm font-medium text-secondary">Alpha Vantage API Key</label><input type="password" id="alphavantage-key" class="mt-1 block w-full input"></div>
                 <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-cancel py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn btn-primary py-2 px-4 rounded-md">Save</button></div>
            </form>
        </div>
    </div>
    
    <div id="cloud-api-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6">Cloud API Settings</h2>
            
            <form id="cloud-api-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-6 p-4 border rounded-lg" style="border-color: var(--border-color);">
                <input type="hidden" id="cloud-api-id">
                <div><label for="cloud-api-name" class="block text-sm font-medium text-secondary">Name</label><input type="text" id="cloud-api-name" class="mt-1 block w-full input" required></div>
                <div><label for="cloud-api-key" class="block text-sm font-medium text-secondary">API Key</label><input type="password" id="cloud-api-key" class="mt-1 block w-full input" required></div>
                <div><label for="cloud-api-base-url" class="block text-sm font-medium text-secondary">Base URL</label><input type="text" id="cloud-api-base-url" class="mt-1 block w-full input" required></div>
                <div><label for="cloud-api-model" class="block text-sm font-medium text-secondary">Model</label><input type="text" id="cloud-api-model" class="mt-1 block w-full input" required></div>
                <div class="md:col-span-4 flex justify-end mt-2"><button type="submit" class="btn btn-primary py-2 px-4 rounded-md">Add/Update API</button></div>
            </form>

            <div id="cloud-api-list-container" class="overflow-x-auto">
                 <table id="cloud-api-table" class="min-w-full">
                    <thead id="cloud-api-table-head">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">Base URL</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">Model</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cloud-api-body"></tbody>
                </table>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" class="btn-cancel py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>

     <div id="cloud-prompt-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6">Cloud AI Prompt Settings</h2>
             <div id="cloud-prompt-tabs" class="flex border-b" style="border-color: var(--border-color);">
                <button data-tab="weekly-summary" class="tab-button tab-active px-4 py-2 text-sm font-medium focus:outline-none rounded-t-lg">Weekly Summary</button>
                <button data-tab="describe-holdings" class="tab-button tab-inactive px-4 py-2 text-sm font-medium focus:outline-none rounded-t-lg">Describe Holdings</button>
                <button data-tab="portfolio-analysis" class="tab-button tab-inactive px-4 py-2 text-sm font-medium focus:outline-none rounded-t-lg">Portfolio Analysis</button>
                <button data-tab="trade-analysis" class="tab-button tab-inactive px-4 py-2 text-sm font-medium focus:outline-none rounded-t-lg">Trade Analysis</button>
                <button data-tab="find-sector" class="tab-button tab-inactive px-4 py-2 text-sm font-medium focus:outline-none rounded-t-lg">Find Sector</button>
             </div>
            <form id="cloud-prompt-form" class="space-y-4 mt-4">
                <div data-tab-panel="weekly-summary">
                    <label for="prompt-cloud-weekly-summary" class="block text-sm font-medium text-secondary">Weekly Summary Prompt</label>
                    <textarea id="prompt-cloud-weekly-summary" rows="4" class="mt-1 block w-full input"></textarea>
                </div>
                 <div data-tab-panel="describe-holdings" class="hidden">
                    <label for="prompt-cloud-describe-holdings" class="block text-sm font-medium text-secondary">Describe Holdings Prompt</label>
                    <textarea id="prompt-cloud-describe-holdings" rows="4" class="mt-1 block w-full input"></textarea>
                </div>
                <div data-tab-panel="portfolio-analysis" class="hidden">
                    <label for="prompt-cloud-portfolio-analysis" class="block text-sm font-medium text-secondary">Portfolio Analysis Prompt</label>
                    <textarea id="prompt-cloud-portfolio-analysis" rows="4" class="mt-1 block w-full input"></textarea>
                </div>
                 <div data-tab-panel="trade-analysis" class="hidden">
                    <label for="prompt-cloud-trade-analysis" class="block text-sm font-medium text-secondary">Trade Analysis Prompt</label>
                    <textarea id="prompt-cloud-trade-analysis" rows="4" class="mt-1 block w-full input"></textarea>
                </div>
                 <div data-tab-panel="find-sector" class="hidden">
                    <label for="prompt-cloud-find-sector" class="block text-sm font-medium text-secondary">Find Sector Prompt</label>
                    <textarea id="prompt-cloud-find-sector" rows="4" class="mt-1 block w-full input"></textarea>
                </div>
                 <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="btn-cancel py-2 px-4 rounded-md">Cancel</button>
                    <button type="submit" class="btn btn-primary py-2 px-4 rounded-md">Save</button>
                </div>
            </form>
        </div>
    </div>


    <div id="summary-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">âœ¨ Weekly Performance Summary</h2>
            <div id="summary-content" class="prose max-w-none space-y-4 min-h-[100px]"></div>
            <div class="mt-6 flex justify-end items-center">
                <button type="button" id="btn-copy-summary" class="btn bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300">Copy</button>
                <button type="button" class="btn-cancel btn ml-2 bg-slate-500 text-white py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <div id="stats-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Advanced Statistics</h2>
            <div id="stats-content" class="prose max-w-none space-y-4"></div>
            <div class="mt-6 flex justify-end"><button type="button" class="btn-cancel py-2 px-4 rounded-md">Close</button></div>
        </div>
    </div>

    <div id="portfolio-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">ðŸ“ˆ Current Portfolio Analysis</h2>
            <div id="portfolio-content" class="prose max-w-none space-y-4 min-h-[100px]"></div>
            <div class="mt-6 flex justify-end items-center">
                <button type="button" id="btn-copy-portfolio" class="btn bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300">Copy</button>
                <button type="button" class="btn-cancel btn ml-2 btn-primary text-white py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <div id="holdings-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">ðŸ“„ Trade History Description</h2>
            <div id="holdings-content" class="prose max-w-none space-y-4 min-h-[100px]"></div>
            <div class="mt-6 flex justify-between items-center">
                <button type="button" id="btn-copy-holdings" class="btn bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300">Copy</button>
                <button type="button" class="btn-cancel btn bg-slate-500 text-white py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>

    <div id="ai-trade-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">âœ¨ AI Trade Analysis</h2>
            <div id="ai-trade-content" class="prose max-w-none space-y-4 min-h-[100px]"></div>
            <div class="mt-6 flex justify-end space-x-3">
                 <button type="button" id="btn-copy-ai-trade" class="btn bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300">Copy</button>
                <button type="button" class="btn-cancel btn btn-primary text-white py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>

    <div id="sector-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Sector Identified</h2>
            <div id="sector-content" class="text-lg font-semibold text-center"></div>
            <div class="mt-6 flex justify-end"><button type="button" class="btn-cancel py-2 px-4 rounded-md">Close</button></div>
        </div>
    </div>
    
     <div id="stop-history-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6">Trailing Stop History</h2>
            <div class="space-y-4">
                <div><label for="stop-history-select" class="block text-sm font-medium text-secondary">Select Trade</label>
                    <select id="stop-history-select" class="mt-1 block w-full input"></select>
                </div>
                <div id="stop-history-content" class="mt-4"></div>
            </div>
            <div class="mt-6 flex justify-end">
                <button type="button" class="btn-cancel py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <div id="alert-modal" class="alert-modal-overlay">
        <div class="alert-modal-content">
            <p id="alert-msg" class="mb-6 text-lg"></p>
            <div id="alert-ok">
                <button id="btn-alert-ok" class="btn btn-primary py-2 px-6 rounded-md">OK</button>
            </div>
            <div id="alert-confirm" class="hidden justify-center gap-4">
                <button id="btn-confirm-cancel" class="btn-cancel py-2 px-6 rounded-md">Cancel</button>
                <button id="btn-confirm-ok" class="btn btn-secondary py-2 px-6 rounded-md">Proceed</button>
            </div>
        </div>
    </div>

<script>
// --- APP INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    const App = (() => {
        // --- STATE ---
        const state = {
            trades: [],
            navHistory: [],
            navChart: null,
            allocationChart: null,
            settings: { 
                initialCapital: 10, 
                currentCash: 10,
                highWaterMark: 10,
                riskPerTradePercentage: 0.8,
                moderateDrawdownThreshold: 5,
                highRiskDrawdownThreshold: 10,
                alphaVantageKey: '',
                cloudApiConfigs: [
                    { id: 'cloud-1', name: "API1", apiKey: "sk-uhSkLuAGsKmqb5GvoQvNu21KHEBfplRBTINcqhzUcunnBdN0", baseUrl: "http://xingkong.yousebaby.com/v1", model: "[EXPRESS] gemini-2.5-pro-preview-06-05" },
                    { id: 'cloud-2', name: "API2", apiKey: "sk-uhSkLuAGsKmqb5GvoQvNu21KHEBfplRBTINcqhzUcunnBdN0", baseUrl: "http://xingkong.yousebaby.com/v1", model: "grok-3" },
                    { id: 'cloud-3', name: "API3", apiKey: "sk-uhSkLuAGsKmqb5GvoQvNu21KHEBfplRBTINcqhzUcunnBdN0", baseUrl: "http://xingkong.yousebaby.com/v1", model: "grok-3-reasoning" },
                    { id: 'cloud-4', name: "API4", apiKey: "sk-klfaPYWN1J8EiI2X6ZAssgkbKtgmPXCtoCq0VndFZo7fhFN0", baseUrl: "http://121.62.28.36:3002/v1", model: "gemini-2.5-pro-preview-05-06" },
                    { id: 'cloud-5', name: "API5", apiKey: "auth0|6814bb514201ed4536f06592", baseUrl: "https://deepseek.erikpsw.works/v1", model: "qwen3-235b-a22b-non-thinking" },
                    { id: 'cloud-6', name: "API6", apiKey: "sk-7O1ZQWEgyGzFhyQPp2wx2geg2wpjEWojtli60GWdD7mUmgg2", baseUrl: "https://api.sikong.shop/v1", model: "gemini-2.5-pro-preview-05-06" }
                ],
                promptCloudWeeklySummary: 'Generate a weekly trading performance summary based on this data:\n{{DATA}}\n\nProvide brief, insightful commentary on the performance.',
                promptCloudDescribeHoldings: 'Please combine the following sentences into a single, cohesive paragraph without adding any analysis or summary. Present the information in a straightforward, factual manner.\n\nData:\n{{DATA}}',
                promptCloudPortfolioAnalysis: 'Analyze this open portfolio:\n\n**Overview:**\n{{DATA}}\n\n**Request:**\n1. Analyze concentration risk.\n2. Note strengths/weaknesses.\n3. Pose 1-2 insightful questions for me to consider.',
                promptCloudTradeAnalysis: 'Analyze this trade setup:\n- Ticker: {{TICKER}}\n- Entry: {{ENTRY}}\n- Stop: {{STOP}}\n- Psychology Notes: "{{NOTES}}"\n\nWhat is a potential rationale and what are the risks? Be concise.',
                promptCloudFindSector: 'GICS sector for ticker {{TICKER}}? Respond with only the sector name.'
            },
            sort: { key: 'entryDate', dir: 'desc' }
        };

        // --- DOM ELEMENTS ---
        const dom = {};
        const cacheDom = () => {
            const ids = [
                'total-assets', 'current-cash', 'unrealized-pl', 'total-open-r', 'total-open-risk-card',
                'realized-pl', 'win-rate', 'profit-factor', 'nav-chart', 'btn-import', 'file-input', 'btn-load-online',
                'btn-export', 'btn-add-trade', 'btn-update-stop', 'btn-view-stop-history', 'btn-exit-trade', 'btn-refresh', 
                'btn-settings', 'btn-provider-settings', 'btn-cloud-api-settings', 'btn-cloud-ai-prompt', 'btn-view-stats', 
                'btn-gen-summary', 'btn-analyze-portfolio', 'btn-describe-holdings', 
                'allocation-chart', 'allocation-chart-container', 'allocation-placeholder',
                'high-water-mark', 'current-drawdown', 'risk-zone', 'total-open-risk', 'nav-history-container',
                'trades-table', 'trades-head', 'trades-body', 
                'trade-modal', 'modal-title', 'trade-form', 'trade-id', 'ticker', 'entry-date', 'entry-price', 
                'position', 'initial-stop', 'sector', 'tags', 'emotional-state', 'psychology-notes', 
                'btn-find-sector', 'btn-analyze-trade',
                'exit-modal', 'exit-form', 'exit-select', 'exit-date', 'exit-price', 'exit-remarks',
                'stop-modal', 'stop-form', 'stop-select', 'new-stop', 'stop-remarks',
                'stop-history-modal', 'stop-history-select', 'stop-history-content',
                'settings-modal', 'settings-form', 'set-capital', 'set-cash', 'set-risk-percent', 'set-moderate-dd', 'set-high-risk-dd',
                'provider-modal', 'provider-form', 'alphavantage-key', 
                'cloud-api-modal', 'cloud-api-form', 'cloud-api-id', 'cloud-api-name', 'cloud-api-key', 'cloud-api-base-url', 'cloud-api-model',
                'cloud-api-list-container', 'cloud-api-table', 'cloud-api-body',
                'cloud-prompt-modal', 'cloud-prompt-form', 'prompt-cloud-weekly-summary', 'prompt-cloud-describe-holdings', 'prompt-cloud-portfolio-analysis', 'prompt-cloud-trade-analysis', 'prompt-cloud-find-sector',
                'summary-modal', 'summary-content', 'btn-copy-summary',
                'stats-modal', 'stats-content',
                'portfolio-modal', 'portfolio-content', 'btn-copy-portfolio',
                'holdings-modal', 'holdings-content', 'btn-copy-holdings',
                'ai-trade-modal', 'ai-trade-content', 'btn-copy-ai-trade',
                'sector-modal', 'sector-content', 'alert-modal', 'alert-msg', 'alert-ok',
                'btn-alert-ok', 'alert-confirm', 'btn-confirm-cancel', 'btn-confirm-ok',
                'cloud-prompt-tabs'
            ];
            ids.forEach(id => dom[id] = document.getElementById(id));
            dom.modalCancelButtons = document.querySelectorAll('.btn-cancel');
        };

        // --- UTILS ---
        const util = {
            formatCurrency: (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0),
            formatDate: (dateStr) => {
                if (!dateStr) return 'N/A';
                const d = new Date(dateStr);
                return new Date(d.getTime() + d.getTimezoneOffset() * 60000).toLocaleDateString('en-CA');
            },
            formatTime: (isoString) => {
                if (!isoString) return '';
                return new Date(isoString).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            },
            formatDuration: (ms) => {
                if (ms < 0 || isNaN(ms)) return 'N/A';
                const d = Math.floor(ms / 864e5), h = Math.floor(ms % 864e5 / 36e5), m = Math.floor(ms % 36e5 / 6e4);
                return [d && `${d}d`, h && `${h}h`, m && `${m}m`].filter(Boolean).join(' ') || '0m';
            },
            showAlert: (msg, type = 'alert', cb) => {
                dom['alert-msg'].innerHTML = msg;
                const okDiv = dom['alert-ok'];
                const confirmDiv = dom['alert-confirm'];
                if (type === 'confirm') {
                    okDiv.classList.add('hidden');
                    confirmDiv.classList.remove('hidden');
                    confirmDiv.style.display = 'flex';
                    dom['btn-confirm-ok'].onclick = () => { util.closeAlert(); cb?.(true); };
                    dom['btn-confirm-cancel'].onclick = () => { util.closeAlert(); cb?.(false); };
                } else {
                    confirmDiv.classList.add('hidden');
                    okDiv.classList.remove('hidden');
                    dom['btn-alert-ok'].onclick = () => { util.closeAlert(); cb?.(true); };
                }
                dom['alert-modal'].classList.add('visible');
            },
            closeAlert: () => dom['alert-modal'].classList.remove('visible'),
            copyToClipboard: (text, message = 'Copied to clipboard!') => {
                if (!text) { util.showAlert('Nothing to copy.'); return; }
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    util.showAlert(message);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    util.showAlert('Failed to copy text.');
                }
                document.body.removeChild(textArea);
            },
            debounce: (func, delay) => {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }
        };
        
        // --- API ---
        const api = {
            callCloudLlm: async (systemPrompt, userPrompt, targetElId) => {
                 const cloudConfigs = state.settings.cloudApiConfigs;
                if (!cloudConfigs.length) {
                    return `Error: No Cloud APIs configured.`;
                }
                
                let lastError = "No APIs available to try.";

                for (let i = 0; i < cloudConfigs.length; i++) {
                    const config = cloudConfigs[i]; // Start from API1
                    console.log(`Trying Cloud API: ${config.name}`);

                    const result = await api.callOpenAICompatibleLlm(systemPrompt, userPrompt, {
                        name: config.name,
                        BASE_URL: config.baseUrl,
                        API_KEY: config.apiKey,
                        MODEL: config.model
                    });

                    if (!result.startsWith('Error:')) {
                        return result; // Success
                    }
                    lastError = result; // Store the last error
                }
                
                return `Error: All Cloud APIs failed. Last error: ${lastError}`;
            },
            callOpenAICompatibleLlm: async (systemPrompt, userPrompt, apiConfig) => {
                const apiUrl = `${apiConfig.BASE_URL}/chat/completions`;
                const payload = {
                    model: apiConfig.MODEL,
                    messages: [
                        { "role": "system", "content": systemPrompt },
                        { "role": "user", "content": userPrompt }
                    ],
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiConfig.API_KEY}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API Error ${response.status}: ${errorBody}`);
                    }
                    
                    const result = await response.json();
                    if (result.choices && result.choices.length > 0 && result.choices[0].message) {
                        return result.choices[0].message.content;
                    } else {
                        throw new Error('Invalid response structure from API.');
                    }
                } catch (error) {
                    console.error(`Error with ${apiConfig.name}:`, error);
                    return `Error: ${error.message}`;
                }
            },
            refreshPrices: async () => {
                const openTrades = state.trades.filter(t => t.status === 'Open');
                if (!openTrades.length) return util.showAlert('No open trades to refresh.');
                if (!state.settings.alphaVantageKey) return util.showAlert('Alpha Vantage API key is not set.');
                
                ui.setLoading(dom['btn-refresh'], true, 'Refreshing...');
                const errorMessages = new Set();
                for (const trade of openTrades) {
                    try {
                        const symbol = trade.ticker.trim();
                        const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${state.settings.alphaVantageKey}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        const price = data?.['Global Quote']?.['05. price'];
                        if (price) {
                            trade.currentPrice = parseFloat(price);
                        } else {
                            const errorMessage = data.Note || data['Error Message'] || `Could not find price for ${trade.ticker}.`;
                            errorMessages.add(errorMessage);
                            console.warn(`Price fetch issue for ${trade.ticker}:`, data);
                        }
                    } catch (error) {
                        console.error(`Error fetching price for ${trade.ticker}:`, error);
                        errorMessages.add(`Network error for ${trade.ticker}. Check console.`);
                    }
                    if (openTrades.indexOf(trade) < openTrades.length - 1) { await new Promise(resolve => setTimeout(resolve, 12000)); }
                }
                calc.recordNavPoint(); 
                ui.render();
                if (errorMessages.size > 0) { util.showAlert(`Price refresh completed with some issues:<br>- ${Array.from(errorMessages).join('<br>- ')}`); }
                else { util.showAlert('All prices refreshed successfully!'); }
                ui.setLoading(dom['btn-refresh'], false);
            }
        };

        // --- CALCULATIONS ---
        const calc = {
            getTradeMetrics: (trade) => {
                const { initialCapital, riskPerTradePercentage } = state.settings;
                const accountRValue = initialCapital * (riskPerTradePercentage / 100);
                const metrics = { tradeRiskInDollars: 0, initialR: 0, realizedPL: 0, realizedR: 0, unrealizedPL: 0, unrealizedR: 0 };
                if (!trade.entryPrice || !trade.initialStop || !trade.position) { return metrics; }
                metrics.tradeRiskInDollars = (trade.entryPrice - trade.initialStop) * trade.position;
                if (accountRValue > 0) { metrics.initialR = metrics.tradeRiskInDollars / accountRValue; }
                if (trade.status === 'Open' && trade.currentPrice) {
                    metrics.unrealizedPL = (trade.currentPrice - trade.entryPrice) * trade.position;
                    if (accountRValue > 0) metrics.unrealizedR = metrics.unrealizedPL / accountRValue;
                } else if (trade.status === 'Closed' && trade.exitPrice) {
                    metrics.realizedPL = (trade.exitPrice - trade.entryPrice) * trade.position;
                    if (accountRValue > 0) metrics.realizedR = metrics.realizedPL / accountRValue;
                }
                return metrics;
            },
            getCurrentRiskR: (trade) => {
                if (trade.status !== 'Open') return 0;
                const { initialCapital, riskPerTradePercentage } = state.settings;
                const accountRValue = initialCapital * (riskPerTradePercentage / 100);
                if (accountRValue <= 0) return 0;
                let riskInDollars = 0;
                if (trade.trailingStop && trade.currentPrice > 0 && trade.position > 0) {
                    riskInDollars = (trade.currentPrice - trade.trailingStop) * trade.position;
                    return riskInDollars / accountRValue;
                } else { return calc.getTradeMetrics(trade).initialR; }
            },
            getRiskMetrics: () => {
                const openValue = state.trades.filter(t => t.status === 'Open').reduce((s, t) => s + ((t.currentPrice || t.entryPrice) * t.position), 0);
                const nav = state.settings.currentCash + openValue;
                state.settings.highWaterMark = Math.max(state.settings.highWaterMark || nav, nav);
                const drawdownDollars = state.settings.highWaterMark - nav;
                const drawdownPercent = state.settings.highWaterMark > 0 ? (drawdownDollars / state.settings.highWaterMark) * 100 : 0;
                return { nav, hwm: state.settings.highWaterMark, drawdownDollars, drawdownPercent };
            },
            getRiskZone: (totalOpenRiskR) => {
                if (totalOpenRiskR > 6) return 'Red';
                if (totalOpenRiskR > 3) return 'Yellow';
                return 'Green';
            },
            getAdvancedStats: () => {
                const closed = state.trades.filter(t => t.status === 'Closed');
                if (!closed.length) return null;
                const winners = closed.filter(t => calc.getTradeMetrics(t).realizedPL > 0);
                const losers = closed.filter(t => calc.getTradeMetrics(t).realizedPL <= 0);
                const winRate = closed.length ? winners.length / closed.length : 0;
                const totalGains = winners.reduce((s, t) => s + calc.getTradeMetrics(t).realizedPL, 0);
                const avgWin = winners.length ? totalGains / winners.length : 0;
                const totalLosses = losers.reduce((s, t) => s + calc.getTradeMetrics(t).realizedPL, 0);
                const avgLoss = losers.length ? Math.abs(totalLosses / losers.length) : 0;
                return { total: closed.length, expectancy: (winRate * avgWin) - ((1 - winRate) * avgLoss), winners: winners.length, losers: losers.length, avgWin: avgWin, largestWin: winners.reduce((max, t) => Math.max(max, calc.getTradeMetrics(t).realizedPL), 0), avgLoss: avgLoss, largestLoss: losers.reduce((min, t) => Math.min(min, calc.getTradeMetrics(t).realizedPL), 0), avgWinHold: winners.length ? winners.reduce((s, t) => s + (new Date(t.exitDate) - new Date(t.entryDate)), 0) / winners.length : 0, avgLossHold: losers.length ? losers.reduce((s, t) => s + (new Date(t.exitDate) - new Date(t.entryDate)), 0) / losers.length : 0, };
            },
            recordNavPoint: () => {
                const { nav } = calc.getRiskMetrics();
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const timestamp = now.toISOString();
                const idx = state.navHistory.findIndex(e => e.date === today);
                if (idx > -1) {
                    state.navHistory[idx].nav = parseFloat(nav.toFixed(2));
                    state.navHistory[idx].timestamp = timestamp;
                } else {
                    state.navHistory.push({ date: today, nav: parseFloat(nav.toFixed(2)), timestamp: timestamp });
                }
                state.navHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
            }
        };

        const loadDataIntoState = (data) => {
            try {
                if (!data) { throw new Error("Invalid data file"); }
                
                if (data.trades) {
                    state.trades = data.trades;
                }

                if (data.navHistory) {
                     state.navHistory = data.navHistory.map(item => ({ ...item, timestamp: item.timestamp || new Date(item.date).toISOString() }));
                }

                if (data.settings) {
                    // Merge settings, preserving existing if not in imported data
                    for (const key in state.settings) {
                        if (data.settings[key] !== undefined) {
                            state.settings[key] = data.settings[key];
                        }
                    }
                }
                
                ui.applyTheme(state.settings.theme || 'light');
                ui.render();
                util.showAlert('Data loaded successfully!');
            } catch (err) { 
                util.showAlert(`Failed to load data: ${err.message}`); 
                console.error("Data Load Error:", err);
            }
        };

        // --- UI ---
        const ui = {
            render: () => { 
                ui.updateDashboard(); 
                ui.renderTrades(); 
                ui.renderNavChart(); 
                ui.renderAllocationChart();
                ui.renderNavHistory(); 
            },
            applyTheme: () => {
                Chart.defaults.color = '#878A8C';
                Chart.defaults.borderColor = '#CCCCCC';
                ui.renderNavChart();
                ui.renderAllocationChart();
            },
            openModal: (el) => { el.classList.remove('hidden'); setTimeout(() => el.classList.remove('opacity-0'), 10); },
            closeModal: (el) => { el.classList.add('opacity-0'); setTimeout(() => el.classList.add('hidden'), 300); },
            setLoading: (btn, loading, text = '') => {
                if (loading) {
                    btn.originalHTML = btn.innerHTML;
                    btn.innerHTML = `<span class="flex items-center justify-center"><div class="loader-sm"></div><span class="ml-2">${text}</span></span>`;
                    btn.disabled = true;
                } else {
                    if (btn.originalHTML) btn.innerHTML = btn.originalHTML;
                    btn.disabled = false;
                }
            },
            updateDashboard: () => {
                let realizedPL = 0, unrealizedPL = 0, totalOpenPL_R = 0, totalOpenRisk_R = 0, wins = 0, totalGains = 0, totalLossesAbs = 0;
                const closed = state.trades.filter(t => t.status === 'Closed');
                
                state.trades.forEach(t => {
                    const metrics = calc.getTradeMetrics(t);
                    if (t.status === 'Open') {
                        unrealizedPL += metrics.unrealizedPL;
                        totalOpenPL_R += metrics.unrealizedR;
                        totalOpenRisk_R += calc.getCurrentRiskR(t);
                    } else {
                        realizedPL += metrics.realizedPL;
                        if (metrics.realizedPL > 0) { wins++; totalGains += metrics.realizedPL; }
                        else totalLossesAbs += Math.abs(metrics.realizedPL);
                    }
                });
                
                const riskMetrics = calc.getRiskMetrics();
                const riskZone = calc.getRiskZone(totalOpenRisk_R);
                ui.renderRiskDashboard(riskMetrics, totalOpenRisk_R, riskZone);
                
                dom['total-assets'].textContent = util.formatCurrency(riskMetrics.nav);
                dom['current-cash'].textContent = util.formatCurrency(state.settings.currentCash);
                dom['realized-pl'].textContent = util.formatCurrency(realizedPL);
                dom['realized-pl'].classList.toggle('text-red-600', realizedPL < 0);
                dom['unrealized-pl'].textContent = util.formatCurrency(unrealizedPL);
                dom['unrealized-pl'].classList.toggle('text-red-600', unrealizedPL < 0);
                dom['total-open-r'].textContent = `${totalOpenPL_R.toFixed(2)}R`;
                dom['total-open-risk-card'].textContent = `${totalOpenRisk_R.toFixed(2)}R`;
                dom['win-rate'].textContent = `${(closed.length ? (wins / closed.length) * 100 : 0).toFixed(1)}%`;
                dom['profit-factor'].textContent = (totalLossesAbs > 0 ? totalGains / totalLossesAbs : 0).toFixed(2);
            },
            renderRiskDashboard: (riskMetrics, totalOpenRiskR, riskZone) => {
                const { hwm, drawdownDollars, drawdownPercent } = riskMetrics;
                dom['high-water-mark'].textContent = util.formatCurrency(hwm);
                dom['current-drawdown'].textContent = `${util.formatCurrency(drawdownDollars)} (${drawdownPercent.toFixed(2)}%)`;
                dom['total-open-risk'].textContent = `${(totalOpenRiskR || 0).toFixed(2)}R`;
                const zoneEl = dom['risk-zone'];
                zoneEl.textContent = riskZone;
                zoneEl.className = 'px-3 py-1 text-sm font-bold rounded-full';
                if (riskZone === 'Green') zoneEl.classList.add('bg-green-100', 'text-green-800');
                else if (riskZone === 'Yellow') zoneEl.classList.add('bg-yellow-100', 'text-yellow-800');
                else zoneEl.classList.add('bg-red-100', 'text-red-800');
            },
            renderTrades: () => {
                const tradesWithMetrics = state.trades.map(trade => ({ ...trade, metrics: calc.getTradeMetrics(trade) }));
                const { key, dir } = state.sort;
                tradesWithMetrics.sort((a, b) => {
                    const metricsA = a.metrics, metricsB = b.metrics;
                    let valA, valB;
                    switch(key) {
                        case 'plDollars': valA = a.status === 'Closed' ? metricsA.realizedPL : metricsA.unrealizedPL; valB = b.status === 'Closed' ? metricsB.realizedPL : metricsB.unrealizedPL; break;
                        case 'plR': valA = a.status === 'Closed' ? metricsA.realizedR : metricsA.unrealizedR; valB = b.status === 'Closed' ? metricsB.realizedR : metricsB.unrealizedR; break;
                        case 'initialR': valA = metricsA.initialR; valB = metricsB.initialR; break;
                        default: valA = a[key]; valB = b[key];
                    }
                    if (valA === undefined || valA === null) return 1; if (valB === undefined || valB === null) return -1;
                    const comp = key.includes('Date') ? new Date(valA) - new Date(valB) : typeof valA === 'number' ? valA - valB : String(valA).localeCompare(String(valB));
                    return dir === 'asc' ? comp : -comp;
                });
                ui.updateSortIndicators();
                dom['trades-body'].innerHTML = tradesWithMetrics.map(tradeWithMetrics => {
                    const { metrics, ...trade } = tradeWithMetrics;
                    const pl = trade.status === 'Closed' ? metrics.realizedPL : metrics.unrealizedPL;
                    const r = trade.status === 'Closed' ? metrics.realizedR : metrics.unrealizedR;
                    const plClass = pl >= 0 ? 'text-green-600' : 'text-red-600';
                    const statusClass = trade.status === 'Open' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800';
                    return `<tr class="hover:bg-slate-50 cursor-pointer" data-id="${trade.id}">
                            <td data-label="Ticker" class="px-6 py-4 whitespace-nowrap text-sm font-medium">${trade.ticker}</td>
                            <td data-label="Entry Date" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${util.formatDate(trade.entryDate)}</td>
                            <td data-label="Entry Price" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${util.formatCurrency(trade.entryPrice)}</td>
                            <td data-label="Current Price" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${trade.currentPrice ? util.formatCurrency(trade.currentPrice) : 'N/A'}</td>
                            <td data-label="Position" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${trade.position || 'N/A'}</td>
                            <td data-label="Initial Stop" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${trade.initialStop ? util.formatCurrency(trade.initialStop) : 'N/A'}</td>
                            <td data-label="Initial Risk (Acct. R)" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${metrics.initialR.toFixed(2)}R</td>
                            <td data-label="Trailing Stop" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${trade.trailingStop ? util.formatCurrency(trade.trailingStop) : 'N/A'}</td>
                            <td data-label="P/L $" class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${plClass}">${util.formatCurrency(pl)}</td>
                            <td data-label="P/L (Acct. R)" class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${plClass}">${r.toFixed(2)}R</td>
                            <td data-label="Status" class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${trade.status}</span></td>
                        </tr>`;
                }).join('');
                if (!tradesWithMetrics.length) dom['trades-body'].innerHTML = `<tr><td colspan="11" class="text-center py-8 text-secondary">No trades to display.</td></tr>`;
            },
            updateSortIndicators: () => {
                dom['trades-head'].querySelectorAll('th.sortable').forEach(th => {
                    th.removeAttribute('data-sort-dir');
                    if(th.dataset.sort === state.sort.key) th.setAttribute('data-sort-dir', state.sort.dir);
                });
            },
            renderNavChart: () => {
                const ctx = dom['nav-chart'].getContext('2d');
                const data = state.navHistory.map(item => ({ x: new Date(item.date).getTime(), y: item.nav }));
                if (state.navChart) state.navChart.destroy();
                state.navChart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets: [{ label: 'NAV', data, borderColor: '#0079D3', backgroundColor: 'rgba(0, 121, 211, 0.1)', borderWidth: 2, pointRadius: data.length < 50 ? 3 : 0, fill: true, tension: 0.1 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM dd,yyyy' }, grid: { color: 'rgba(204, 204, 204, 0.1)' } }, y: { ticks: { callback: v => util.formatCurrency(v) }, grid: { color: 'rgba(204, 204, 204, 0.1)'} } }, plugins: { tooltip: { callbacks: { label: c => `NAV: ${util.formatCurrency(c.parsed.y)}` } } } }
                });
            },
            renderAllocationChart: () => {
                const canvas = dom['allocation-chart'];
                const placeholder = dom['allocation-placeholder'];
                if (state.allocationChart) { state.allocationChart.destroy(); }
                const openTrades = state.trades.filter(t => t.status === 'Open');
                const allocation = openTrades.reduce((acc, trade) => {
                    const sector = trade.sector || 'Uncategorized';
                    const value = (trade.currentPrice || trade.entryPrice) * trade.position;
                    acc[sector] = (acc[sector] || 0) + value;
                    return acc;
                }, {});
                if (state.settings.currentCash > 0) { allocation['Cash'] = state.settings.currentCash; }
                const labels = Object.keys(allocation);
                if (labels.length === 0) {
                    canvas.style.display = 'none';
                    placeholder.textContent = 'No assets to display.';
                    placeholder.style.display = 'block';
                    return;
                }
                canvas.style.display = 'block';
                placeholder.style.display = 'none';
                const ctx = canvas.getContext('2d');
                const data = Object.values(allocation);
                state.allocationChart = new Chart(ctx, { type: 'pie', data: { labels: labels, datasets: [{ label: 'Portfolio Allocation', data: data, backgroundColor: ['#0079D3', '#FF4500', '#4856a3', '#ffb000', '#7e53c1', '#00a368', '#ff8717', '#a3a3a3'], borderColor: 'var(--bg-secondary)', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15 } }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { label += util.formatCurrency(context.parsed); } return label; } } } } } });
            },
            renderNavHistory: () => {
                const container = dom['nav-history-container'];
                container.innerHTML = '';
                if (!state.navHistory || state.navHistory.length === 0) {
                    container.innerHTML = '<p class="text-center py-4 text-secondary">No NAV history to display.</p>';
                    return;
                }
                const table = document.createElement('table');
                table.id = 'nav-history-table';
                table.className = 'min-w-full';
                table.innerHTML = `
                    <thead id="nav-history-table-head">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">Last Update</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">NAV</th>
                        </tr>
                    </thead>
                    <tbody id="nav-history-body">
                        ${state.navHistory
                            .slice().sort((a, b) => new Date(b.date) - new Date(a.date)) // Use slice to avoid mutating original
                            .map(item => `
                                <tr>
                                    <td data-label="Date" class="px-6 py-4">${util.formatDate(item.date)}</td>
                                    <td data-label="Last Update" class="px-6 py-4 text-sm text-secondary">${util.formatTime(item.timestamp)}</td>
                                    <td data-label="NAV" class="px-6 py-4">${util.formatCurrency(item.nav)}</td>
                                </tr>
                            `).join('')
                        }
                    </tbody>
                `;
                container.appendChild(table);
            },
            renderCloudApiConfigs: () => {
                dom['cloud-api-body'].innerHTML = state.settings.cloudApiConfigs.map(config => `
                    <tr data-id="${config.id}">
                        <td data-label="Name" class="px-6 py-4 text-sm font-medium">${config.name}</td>
                        <td data-label="Base URL" class="px-6 py-4 text-sm text-secondary">${config.baseUrl}</td>
                        <td data-label="Model" class="px-6 py-4 text-sm text-secondary">${config.model}</td>
                        <td data-label="Actions" class="px-6 py-4 text-sm font-medium space-x-2">
                            <button class="text-indigo-600 hover:text-indigo-900" data-action="edit">Edit</button>
                            <button class="text-red-600 hover:text-red-900" data-action="delete">Delete</button>
                        </td>
                    </tr>
                `).join('');
                 if (!state.settings.cloudApiConfigs.length) {
                    dom['cloud-api-body'].innerHTML = `<tr><td colspan="4" class="text-center py-8 text-secondary">No Cloud API configurations.</td></tr>`;
                }
            },
            showAdvancedStats: () => {
                const s = calc.getAdvancedStats();
                dom['stats-content'].innerHTML = !s ? '<p>No closed trades to analyze.</p>' :
                    `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                        <div class="themed-bg p-4 rounded-lg"><h3>Performance</h3><p>Total Trades: ${s.total}</p><p class="${s.expectancy > 0 ? 'text-green-600 dark:text-green-400':'text-red-600 dark:text-red-400'}">Expectancy: ${util.formatCurrency(s.expectancy)}</p></div>
                        <div class="themed-bg p-4 rounded-lg"><h3>Win & Loss</h3><p>Wins: ${s.winners}</p><p>Losses: ${s.losers}</p></div>
                        <div class="bg-green-100 dark:bg-green-900/50 p-4 rounded-lg text-green-800 dark:text-green-300"><h3>Gains</h3><p>Avg Win: ${util.formatCurrency(s.avgWin)}</p><p>Largest Win: ${util.formatCurrency(s.largestWin)}</p></div>
                        <div class="bg-red-100 dark:bg-red-900/50 p-4 rounded-lg text-red-800 dark:text-red-300"><h3>Losses</h3><p>Avg Loss: ${util.formatCurrency(s.avgLoss)}</p><p>Largest Loss: ${util.formatCurrency(s.largestLoss)}</p></div>
                        <div class="themed-bg p-4 rounded-lg md:col-span-2"><h3>Holding Time</h3><p>Avg Win Hold: ${util.formatDuration(s.avgWinHold)}</p><p>Avg Loss Hold: ${util.formatDuration(s.avgLossHold)}</p></div>
                    </div>`;
                ui.openModal(dom['stats-modal']);
            },
            populateOpenTradesDropdown: (selectId) => {
                const sel = dom[selectId];
                sel.innerHTML = '<option value="">Select a trade...</option>';
                state.trades.filter(t => t.status === 'Open').forEach(t => sel.innerHTML += `<option value="${t.id}">${t.ticker} (${util.formatDate(t.entryDate)})</option>`);
            }
        };

        // --- EVENTS ---
        const events = {
            init: () => {
                dom['btn-add-trade'].onclick = events.handleAddTradeClick;
                dom['btn-exit-trade'].onclick = () => { ui.populateOpenTradesDropdown('exit-select'); ui.openModal(dom['exit-modal']); };
                dom['btn-update-stop'].onclick = () => { ui.populateOpenTradesDropdown('stop-select'); ui.openModal(dom['stop-modal']); };
                dom['btn-settings'].onclick = () => {
                    dom['set-capital'].value = state.settings.initialCapital;
                    dom['set-cash'].value = state.settings.currentCash;
                    dom['set-risk-percent'].value = state.settings.riskPerTradePercentage;
                    dom['set-moderate-dd'].value = state.settings.moderateDrawdownThreshold;
                    dom['set-high-risk-dd'].value = state.settings.highRiskDrawdownThreshold;
                    ui.openModal(dom['settings-modal']);
                };
                
                dom['btn-provider-settings'].onclick = () => { 
                    dom['alphavantage-key'].value = state.settings.alphaVantageKey; 
                    ui.openModal(dom['provider-modal']); 
                };
                dom['btn-cloud-api-settings'].onclick = () => {
                    ui.renderCloudApiConfigs();
                    ui.openModal(dom['cloud-api-modal']);
                };
                dom['btn-cloud-ai-prompt'].onclick = () => {
                    dom['prompt-cloud-weekly-summary'].value = state.settings.promptCloudWeeklySummary;
                    dom['prompt-cloud-describe-holdings'].value = state.settings.promptCloudDescribeHoldings;
                    dom['prompt-cloud-portfolio-analysis'].value = state.settings.promptCloudPortfolioAnalysis;
                    dom['prompt-cloud-trade-analysis'].value = state.settings.promptCloudTradeAnalysis;
                    dom['prompt-cloud-find-sector'].value = state.settings.promptCloudFindSector;
                    ui.openModal(dom['cloud-prompt-modal']);
                };
                dom['btn-import'].onclick = () => dom['file-input'].click();
                dom['file-input'].onchange = events.handleImport;
                dom['btn-load-online'].onclick = events.handleLoadOnlineData;
                dom['btn-export'].onclick = events.handleExport;
                dom['btn-refresh'].onclick = api.refreshPrices;
                dom['btn-view-stats'].onclick = ui.showAdvancedStats;
                dom['btn-gen-summary'].onclick = events.handleGenSummary;
                dom['btn-analyze-portfolio'].onclick = events.handleAnalyzePortfolio;
                dom['btn-describe-holdings'].onclick = events.handleDescribeHoldings;
                dom['btn-view-stop-history'].onclick = events.handleViewStopHistory;
                
                dom['trade-form'].onsubmit = events.handleSaveTrade;
                dom['exit-form'].onsubmit = events.handleSaveExit;
                dom['stop-form'].onsubmit = events.handleSaveStop;
                dom['settings-form'].onsubmit = events.handleSaveSettings;
                dom['provider-form'].onsubmit = events.handleSaveProviderKeys;
                dom['cloud-api-form'].onsubmit = events.handleSaveCloudApiConfig;
                dom['cloud-prompt-form'].onsubmit = events.handleSaveCloudPrompt;
                dom['cloud-api-body'].onclick = events.handleCloudApiListClick;
                dom['cloud-prompt-tabs'].addEventListener('click', events.handleCloudPromptTabClick);


                dom['trades-head'].onclick = events.handleSort;
                dom['trades-body'].onclick = events.handleEditTrade;
                
                dom['btn-find-sector'].onclick = events.handleFindSector;
                dom['btn-analyze-trade'].onclick = events.handleAnalyzeTrade;
                
                dom.modalCancelButtons.forEach(btn => btn.onclick = () => ui.closeModal(btn.closest('.modal-overlay')));
                dom['btn-copy-summary'].onclick = () => util.copyToClipboard(dom['summary-content'].innerText);
                dom['btn-copy-portfolio'].onclick = () => util.copyToClipboard(dom['portfolio-content'].innerText);
                dom['btn-copy-holdings'].onclick = () => util.copyToClipboard(dom['holdings-content'].innerText);
                dom['btn-copy-ai-trade'].onclick = () => util.copyToClipboard(dom['ai-trade-content'].innerText);
            },
            handleCloudPromptTabClick: (e) => {
                if(e.target.tagName !== 'BUTTON') return;

                dom['cloud-prompt-tabs'].querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('tab-active');
                    btn.classList.add('tab-inactive');
                });
                
                e.target.classList.add('tab-active');
                e.target.classList.remove('tab-inactive');

                dom['cloud-prompt-form'].querySelectorAll('[data-tab-panel]').forEach(panel => {
                    panel.classList.add('hidden');
                });
                
                const panelId = e.target.dataset.tab;
                dom['cloud-prompt-form'].querySelector(`[data-tab-panel="${panelId}"]`).classList.remove('hidden');
            },
            handleAddTradeClick: () => {
                const totalOpenRisk_R = state.trades.filter(t => t.status === 'Open').reduce((sum, t) => sum + calc.getCurrentRiskR(t), 0);
                const riskZone = calc.getRiskZone(totalOpenRisk_R);

                if (riskZone === 'Red') {
                    util.showAlert('HIGH RISK: Your total open risk exposure exceeds 6R. New trades are restricted.');
                    return;
                }
                if (riskZone === 'Yellow') {
                    util.showAlert('CAUTION: Your total open risk exposure exceeds 3R. Are you sure you want to add a new position?', 'confirm', (proceed) => {
                        if (proceed) {
                            dom['trade-form'].reset(); dom['modal-title'].textContent = 'Add New Trade'; dom['trade-id'].value = ''; 
                            ui.openModal(dom['trade-modal']);
                        }
                    });
                    return;
                }
                dom['trade-form'].reset(); dom['modal-title'].textContent = 'Add New Trade'; dom['trade-id'].value = ''; 
                ui.openModal(dom['trade-modal']);
            },
            handleSaveTrade: (e) => {
                e.preventDefault();
                const id = dom['trade-id'].value;
                const tradeData = {
                    ticker: dom.ticker.value.toUpperCase().trim(),
                    entryDate: dom['entry-date'].value,
                    entryPrice: parseFloat(dom['entry-price'].value),
                    position: parseInt(dom.position.value),
                    initialStop: parseFloat(dom['initial-stop'].value),
                    sector: dom.sector.value,
                    tags: dom.tags.value.split(',').map(t => t.trim()).filter(Boolean),
                    emotionalState: dom['emotional-state'].value,
                    psychologyNotes: dom['psychology-notes'].value,
                    stopHistory: id ? state.trades.find(t=>t.id===id).stopHistory : []
                };
                if (id) {
                    Object.assign(state.trades.find(t => t.id === id), tradeData);
                } else {
                     const cost = tradeData.entryPrice * tradeData.position;
                    if (state.settings.currentCash < cost) {
                        util.showAlert('Not enough cash to open this position.');
                        return;
                    }
                    state.settings.currentCash -= cost;
                    state.trades.push({ ...tradeData, id: `trade-${Date.now()}`, status: 'Open', currentPrice: null, stopHistory: [] });
                }
                ui.closeModal(dom['trade-modal']);
                calc.recordNavPoint();
                ui.render();
            },
            handleSaveExit: (e) => {
                e.preventDefault();
                const trade = state.trades.find(t => t.id === dom['exit-select'].value);
                if (trade) {
                    trade.status = 'Closed';
                    trade.exitDate = dom['exit-date'].value;
                    trade.exitPrice = parseFloat(dom['exit-price'].value);
                    trade.exitRemarks = dom['exit-remarks'].value;
                    const proceeds = trade.exitPrice * trade.position;
                    state.settings.currentCash += proceeds;
                    calc.recordNavPoint();
                    ui.closeModal(dom['exit-modal']);
                    ui.render();
                }
            },
            handleSaveStop: (e) => { 
                e.preventDefault(); 
                const tradeId = dom['stop-select'].value;
                const newStop = parseFloat(dom['new-stop'].value);
                const remarks = dom['stop-remarks'].value;
                const trade = state.trades.find(t => t.id === tradeId); 
                
                if(trade) { 
                    if (!trade.stopHistory) {
                        trade.stopHistory = [];
                    }
                    trade.stopHistory.push({
                        date: new Date().toISOString(),
                        oldStop: trade.trailingStop || trade.initialStop,
                        newStop: newStop,
                        remarks: remarks
                    });
                    trade.trailingStop = newStop;
                    ui.closeModal(dom['stop-modal']); 
                    ui.render(); 
                } 
            },
            handleSaveSettings: (e) => { 
                e.preventDefault(); 
                state.settings.initialCapital = parseFloat(dom['set-capital'].value); 
                state.settings.currentCash = parseFloat(dom['set-cash'].value); 
                state.settings.riskPerTradePercentage = parseFloat(dom['set-risk-percent'].value);
                state.settings.moderateDrawdownThreshold = parseFloat(dom['set-moderate-dd'].value);
                state.settings.highRiskDrawdownThreshold = parseFloat(dom['set-high-risk-dd'].value);
                state.settings.highWaterMark = state.settings.initialCapital;
                calc.recordNavPoint();
                ui.closeModal(dom['settings-modal']); 
                ui.render(); 
            },
            handleSaveProviderKeys: (e) => {
                e.preventDefault();
                state.settings.alphaVantageKey = dom['alphavantage-key'].value.trim();
                ui.closeModal(dom['provider-modal']);
                util.showAlert(`Data provider settings saved.`);
            },
            handleSaveCloudApiConfig: (e) => {
                e.preventDefault();
                const id = dom['cloud-api-id'].value;
                const configData = {
                    name: dom['cloud-api-name'].value,
                    apiKey: dom['cloud-api-key'].value,
                    baseUrl: dom['cloud-api-base-url'].value,
                    model: dom['cloud-api-model'].value
                };

                if (id) {
                    const index = state.settings.cloudApiConfigs.findIndex(c => c.id === id);
                    if (index > -1) {
                        state.settings.cloudApiConfigs[index] = { ...state.settings.cloudApiConfigs[index], ...configData };
                    }
                } else {
                    state.settings.cloudApiConfigs.push({ id: `cloud-${Date.now()}`, ...configData });
                }
                
                ui.renderCloudApiConfigs();
                dom['cloud-api-form'].reset();
                dom['cloud-api-id'].value = '';
            },
            handleSaveCloudPrompt: (e) => {
                e.preventDefault();
                state.settings.promptCloudWeeklySummary = dom['prompt-cloud-weekly-summary'].value;
                state.settings.promptCloudDescribeHoldings = dom['prompt-cloud-describe-holdings'].value;
                state.settings.promptCloudPortfolioAnalysis = dom['prompt-cloud-portfolio-analysis'].value;
                state.settings.promptCloudTradeAnalysis = dom['prompt-cloud-trade-analysis'].value;
                state.settings.promptCloudFindSector = dom['prompt-cloud-find-sector'].value;
                ui.closeModal(dom['cloud-prompt-modal']);
                util.showAlert('Cloud AI prompts saved.');
            },
            handleCloudApiListClick: (e) => {
                const action = e.target.dataset.action;
                if (!action) return;

                const row = e.target.closest('tr');
                const id = row.dataset.id;
                const config = state.settings.cloudApiConfigs.find(c => c.id === id);

                if (action === 'edit' && config) {
                    dom['cloud-api-id'].value = config.id;
                    dom['cloud-api-name'].value = config.name;
                    dom['cloud-api-key'].value = config.apiKey;
                    dom['cloud-api-base-url'].value = config.baseUrl;
                    dom['cloud-api-model'].value = config.model;
                } else if (action === 'delete') {
                    util.showAlert(`Are you sure you want to delete the "${config.name}" API?`, 'confirm', (proceed) => {
                        if (proceed) {
                            state.settings.cloudApiConfigs = state.settings.cloudApiConfigs.filter(c => c.id !== id);
                            ui.renderCloudApiConfigs();
                        }
                    });
                }
            },
            handleImport: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        loadDataIntoState(data);
                    } catch (err) {
                        util.showAlert(`Failed to parse JSON file: ${err.message}`);
                    }
                };
                reader.readAsText(file);
            },
            handleLoadOnlineData: async () => {
                const url = 'https://elclel8888.github.io/TradingJ/trading_journal_backup.json';
                ui.setLoading(dom['btn-load-online'], true, 'Loading...');
                try {
                    const response = await fetch(url, { cache: 'no-cache' }); 
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    loadDataIntoState(data);
                } catch (error) {
                    util.showAlert(`Failed to load online data: ${error.message}. Check the console for more details.`);
                    console.error('Failed to fetch online data:', error);
                } finally {
                    ui.setLoading(dom['btn-load-online'], false);
                }
            },
            handleExport: () => {
                const data = JSON.stringify({ settings: state.settings, trades: state.trades, navHistory: state.navHistory }, null, 2);
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([data], {type: 'application/json'}));
                a.download = `trading_journal_backup.json`;
                a.click();
                URL.revokeObjectURL(a.href);
            },
            handleSort: (e) => {
                const th = e.target.closest('th.sortable');
                if (th) {
                    const key = th.dataset.sort;
                    if (state.sort.key === key) state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
                    else { state.sort.key = key; state.sort.dir = 'desc'; }
                    ui.renderTrades();
                }
            },
            handleEditTrade: (e) => {
                const row = e.target.closest('tr[data-id]');
                if (row) {
                    const trade = state.trades.find(t => t.id === row.dataset.id);
                    if (trade) {
                        dom['modal-title'].textContent = 'Edit Trade';
                        dom['trade-id'].value = trade.id;
                        dom.ticker.value = trade.ticker;
                        dom['entry-date'].value = trade.entryDate;
                        dom['entry-price'].value = trade.entryPrice;
                        dom.position.value = trade.position;
                        dom['initial-stop'].value = trade.initialStop;
                        dom.sector.value = trade.sector || '';
                        dom.tags.value = trade.tags ? trade.tags.join(', ') : '';
                        dom['emotional-state'].value = trade.emotionalState || 'Neutral';
                        dom['psychology-notes'].value = trade.psychologyNotes || '';
                        ui.openModal(dom['trade-modal']);
                    }
                }
            },
            handleGenSummary: async () => {
                ui.openModal(dom['summary-modal']);
                if (dom['summary-content']) dom['summary-content'].innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';
                
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const recentTrades = state.trades.filter(t => t.status === 'Closed' && new Date(t.exitDate) >= oneWeekAgo);
                if (!recentTrades.length) {
                    dom['summary-content'].innerHTML = "<p>No closed trades in the last 7 days to summarize.</p>";
                    return;
                }
                
                const stats = recentTrades.map(calc.getTradeMetrics);
                const totalPL = stats.reduce((sum, s) => sum + s.realizedPL, 0);
                const totalR = stats.reduce((sum, s) => sum + s.realizedR, 0);
                const winRate = (recentTrades.filter(t => calc.getTradeMetrics(t).realizedPL > 0).length / recentTrades.length) * 100;

                const dataString = `- Total Trades: ${recentTrades.length}\n- Total P/L: ${util.formatCurrency(totalPL)}\n- Total R-Multiple: ${totalR.toFixed(2)}R\n- Win Rate: ${winRate.toFixed(1)}%`;
                const systemPrompt = "You are a helpful financial analyst AI.";
                const userPrompt = state.settings.promptCloudWeeklySummary.replace('{{DATA}}', dataString);
                
                const result = await api.callCloudLlm(systemPrompt, userPrompt, 'summary-content');
                dom['summary-content'].innerHTML = result.startsWith('Error:') ? `<p class="text-red-500">${result}</p>` : result;
            },
            handleDescribeHoldings: async () => {
                ui.openModal(dom['holdings-modal']);
                if (dom['holdings-content']) dom['holdings-content'].innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';
                
                const allTrades = state.trades;
                const currentCash = util.formatCurrency(state.settings.currentCash);
                let historyText = `The current cash balance is ${currentCash}. `;

                if (!allTrades.length) {
                    historyText += "There is no trade history to describe.";
                } else {
                    historyText += allTrades.map(t => {
                        const metrics = calc.getTradeMetrics(t);
                        const pl = t.status === 'Closed' ? metrics.realizedPL : metrics.unrealizedPL;
                        const r = t.status === 'Closed' ? metrics.realizedR : metrics.unrealizedR;
                        let exitInfo = `The current price is ${t.currentPrice ? util.formatCurrency(t.currentPrice) : 'N/A'}.`;
                        if (t.status === 'Closed') {
                            exitInfo = `The exit was on ${util.formatDate(t.exitDate)} at ${util.formatCurrency(t.exitPrice)}. My exit remarks were: '${t.exitRemarks || 'None'}'. `;
                        }

                        return `For ticker ${t.ticker}, the trade status is ${t.status}. Entry was on ${util.formatDate(t.entryDate)} at a price of ${util.formatCurrency(t.entryPrice)} with a position size of ${t.position}. The initial stop was ${util.formatCurrency(t.initialStop)}. ` +
                            (t.trailingStop ? `The trailing stop is currently ${util.formatCurrency(t.trailingStop)}. ` : '') +
                            exitInfo +
                            `The final P/L is ${util.formatCurrency(pl)}, which is ${r.toFixed(2)}R. My emotional state was ${t.emotionalState || 'not recorded'}, and my notes were: '${t.psychologyNotes || 'None'}'.`;
                    }).join(' ');
                }

                const systemPrompt = "You are a helpful financial analyst AI.";
                const userPrompt = state.settings.promptCloudDescribeHoldings.replace('{{DATA}}', historyText);
                const result = await api.callCloudLlm(systemPrompt, userPrompt, 'holdings-content');
                dom['holdings-content'].innerHTML = result.startsWith('Error:') ? `<p class="text-red-500">${result}</p>` : result;

            },
            handleAnalyzePortfolio: async () => {
                ui.openModal(dom['portfolio-modal']);
                dom['portfolio-content'].innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';
                const openTrades = state.trades.filter(t => t.status === 'Open');
                if (!openTrades.length) {
                    dom['portfolio-content'].innerHTML = "<p>No open trades to analyze.</p>";
                    return;
                }

                const totalUnrealizedPL = openTrades.reduce((sum, t) => sum + calc.getTradeMetrics(t).unrealizedPL, 0);
                const tradeDetails = openTrades.map(t => {
                    const m = calc.getTradeMetrics(t);
                    return `- ${t.ticker}: P/L ${util.formatCurrency(m.unrealizedPL)} (${m.unrealizedR.toFixed(2)}R). Psychology Notes: "${t.psychologyNotes || 'None'}".`;
                }).join('\n');
                const dataString = `- Positions: ${openTrades.length}\n- Total Unrealized P/L: ${util.formatCurrency(totalUnrealizedPL)}\n\n**Positions:**\n${tradeDetails}`;
                
                const systemPrompt = "You are a helpful financial analyst AI.";
                const userPrompt = state.settings.promptCloudPortfolioAnalysis.replace('{{DATA}}', dataString);
                
                const result = await api.callCloudLlm(systemPrompt, userPrompt, 'portfolio-content');
                dom['portfolio-content'].innerHTML = result.startsWith('Error:') ? `<p class="text-red-500">${result}</p>` : result;
            },
            handleAnalyzeTrade: async () => {
                ui.openModal(dom['ai-trade-modal']);
                dom['ai-trade-content'].innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';
                
                const [ticker, entry, stop, notes] = [dom.ticker.value, dom['entry-price'].value, dom['initial-stop'].value, dom['psychology-notes'].value];
                if (!ticker || !entry || !stop) {
                    dom['ai-trade-content'].innerHTML = "<p>Ticker, Entry, and Stop are required for analysis.</p>";
                    return;
                }
                
                let userPrompt = state.settings.promptCloudTradeAnalysis;
                userPrompt = userPrompt.replace('{{TICKER}}', ticker)
                               .replace('{{ENTRY}}', entry)
                               .replace('{{STOP}}', stop)
                               .replace('{{NOTES}}', notes);

                const systemPrompt = "You are a helpful financial analyst AI.";
                const result = await api.callCloudLlm(systemPrompt, userPrompt, 'ai-trade-content');
                dom['ai-trade-content'].innerHTML = result.startsWith('Error:') ? `<p class="text-red-500">${result}</p>` : result;
            },
            handleFindSector: async () => {
                const ticker = dom.ticker.value;
                if (!ticker) return util.showAlert('Enter a ticker first.');
                ui.setLoading(dom['btn-find-sector'], true, '');

                const systemPrompt = "You are a helpful financial analyst AI.";
                const userPrompt = state.settings.promptCloudFindSector.replace('{{TICKER}}', ticker);
                const result = await api.callCloudLlm(systemPrompt);

                if (result && !result.startsWith('Error:')) {
                    const sector = result.trim().replace(/\.$/, '');
                    dom.sector.value = sector;
                } else {
                    util.showAlert(`Could not find sector. AI analysis failed. Last error: ${result}`);
                }
                ui.setLoading(dom['btn-find-sector'], false);
            },
            handleViewStopHistory: () => {
                const select = dom['stop-history-select'];
                select.innerHTML = '<option value="">Select a trade...</option>';
                state.trades.forEach(t => {
                    select.innerHTML += `<option value="${t.id}">${t.ticker} (${util.formatDate(t.entryDate)})</option>`;
                });
                // Clear previous history
                dom['stop-history-content'].innerHTML = '';

                select.onchange = (e) => {
                    const trade = state.trades.find(t => t.id === e.target.value);
                    const content = dom['stop-history-content'];
                    if (!trade || !trade.stopHistory || trade.stopHistory.length === 0) {
                        content.innerHTML = '<p class="text-secondary text-center py-4">No stop history for this trade.</p>';
                        return;
                    }
                    content.innerHTML = `
                        <table class="min-w-full">
                            <thead><tr>
                                <th class="px-4 py-2 text-left text-sm font-medium text-secondary uppercase">Date</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-secondary uppercase">Old Stop</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-secondary uppercase">New Stop</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-secondary uppercase">Remarks</th>
                            </tr></thead>
                            <tbody>
                                ${trade.stopHistory.map(h => `
                                    <tr>
                                        <td class="px-4 py-2 border-t" style="border-color:var(--border-color)">${util.formatDate(h.date)} ${util.formatTime(h.date)}</td>
                                        <td class="px-4 py-2 border-t" style="border-color:var(--border-color)">${util.formatCurrency(h.oldStop)}</td>
                                        <td class="px-4 py-2 border-t" style="border-color:var(--border-color)">${util.formatCurrency(h.newStop)}</td>
                                        <td class="px-4 py-2 border-t" style="border-color:var(--border-color)">${h.remarks || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                };
                ui.openModal(dom['stop-history-modal']);
            }
        };

        // --- MAIN INIT ---
        const init = () => {
            cacheDom();
            events.init();
            
            ui.applyTheme('light'); // Set light theme by default

            if (state.navHistory.length === 0 && state.settings.initialCapital) {
                const d = new Date();
                d.setDate(d.getDate() - 1);
                state.navHistory.push({ 
                    date: d.toISOString().split('T')[0], 
                    nav: state.settings.initialCapital,
                    timestamp: d.toISOString() 
                });
            }
            ui.render();
        };

        return { init };
    })();

    App.init();
});
</script>

</body>
</html>
