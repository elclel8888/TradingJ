<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Trading Journal - Revised</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/dist/date-fns.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #DAE0E6;
            --bg-secondary: #FFFFFF;
            --text-primary: #1A1A1B;
            --text-secondary: #878A8C;
            --border-color: #CCCCCC;
            --accent-primary: #0079D3;
            --accent-secondary: #FF4500;
        }

        body { 
            font-family: 'IBM Plex Sans', sans-serif;
            background-color: var(--bg-primary); 
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.6;
        }
        .themed-bg, .stat-card, .modal-content, .alert-modal-content {
             background-color: var(--bg-secondary);
             border: 1px solid var(--border-color);
        }
        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-content { 
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out, background-color 0.3s; 
            overscroll-behavior: contain;
            position: relative; /* For positioning the close button */
        }
        .stat-card { transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s; }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--accent-primary); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background-color: var(--accent-primary); color: white; }
        .btn-secondary { background-color: var(--accent-secondary); color: white; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .loader, .loader-sm { border: 2px solid #f3f3f3; border-top: 2px solid var(--accent-primary); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        .loader { width: 30px; height: 30px; border-width: 4px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .alert-modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .alert-modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .alert-modal-content { padding: 2rem; border-radius: 0.5rem; max-width: 90%; width: 400px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease, background-color 0.3s; }
        .alert-modal-overlay.visible .alert-modal-content { transform: scale(1); }
        .tab-active { border-bottom: 2px solid var(--accent-secondary); color: var(--accent-secondary); }
        .tab-inactive { border-bottom: 2px solid transparent; color: var(--text-secondary); }
        
        #trades-table thead, #nav-history-table thead, #cloud-api-table thead {
            background-color: var(--bg-primary);
            border-bottom: 2px solid var(--border-color);
        }
        #trades-table tbody tr.trade-row {
            border-bottom: 1px solid var(--border-color);
        }
         #trades-table tbody tr.trade-details-row {
            display: none;
        }
        #trades-table tbody tr.trade-details-row.is-visible {
            display: table-row;
        }
        .details-cell {
            padding: 1rem;
            background-color: #f7fafc;
        }
        #nav-history-table tbody tr, #cloud-api-table tbody tr {
            border-bottom: 1px solid var(--border-color);
        }
        #trades-table tbody tr:last-child, #nav-history-table tbody tr:last-child, #cloud-api-table tbody tr:last-child {
            border-bottom: none;
        }

        .sortable-header { cursor: pointer; }
        .sortable-header:hover { background-color: #e2e8f0; }
        .sort-indicator { display: inline-block; width: 0; height: 0; margin-left: 5px; vertical-align: middle; transition: transform 0.2s; }
        .sort-asc .sort-indicator { border-left: 4px solid transparent; border-right: 4px solid transparent; border-bottom: 4px solid currentColor; }
        .sort-desc .sort-indicator { border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 4px solid currentColor; }

        @media (max-width: 1023px) {
            #trades-table thead, #nav-history-table thead, #cloud-api-table thead { display: none; }
            #trades-table, #trades-table tbody, #trades-table tr,
            #nav-history-table, #nav-history-table tbody, #nav-history-table tr,
            #cloud-api-table, #cloud-api-table tbody, #cloud-api-table tr { display: block; width: 100%; }
            #trades-table tbody tr.trade-row, #nav-history-table tbody tr, #cloud-api-table tbody tr { margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1rem; background-color: var(--bg-secondary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
            #trades-table tbody tr.trade-details-row { margin-bottom: 1.5rem; border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 0; }
            #trades-table tbody td, #nav-history-table tbody td, #cloud-api-table tbody td { display: flex; justify-content: space-between; align-items: center; text-align: right; padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--border-color); }
            #trades-table tbody td:last-child, #nav-history-table tbody td:last-child, #cloud-api-table tbody td:last-child { border-bottom: none; }
            #trades-table tbody td::before, #nav-history-table tbody td::before, #cloud-api-table tbody td::before { content: attr(data-label); font-weight: 600; text-align: left; padding-right: 1rem; color: var(--text-secondary); }
        }
        
        .input { background-color: #f6f7f8; border: 1px solid #edeff1; color: var(--text-primary); font-size: 1rem; padding: 0.75rem; }
        .input::placeholder { color: #a9a9a9; }
        .btn-cancel { background-color: #edeff1; color: #1c1c1c; }
        .btn-cancel:hover { background-color: #e2e2e2; }
        .prose { color: var(--text-secondary); }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose strong { color: var(--text-primary); }
    </style>
</head>
<body class="antialiased">

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="mb-8 p-4 themed-bg rounded-lg shadow-sm flex justify-between items-center">
            <h1 class="text-3xl sm:text-4xl font-bold" style="color: var(--accent-secondary);">r/TradingJournal</h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="stat-card p-5 rounded-lg sm:col-span-2"><h3 class="text-sm font-medium text-secondary">Total Assets</h3><p id="total-assets" class="text-3xl font-bold mt-1">$0.00</p></div>
                    <div class="stat-card p-5 rounded-lg">
                        <h3 class="text-sm font-medium text-secondary">Current Cash</h3>
                        <div class="flex items-baseline justify-between flex-wrap">
                            <p id="current-cash" class="text-2xl font-bold mt-1">$0.00</p>
                            <span id="cash-percentage" class="text-sm font-semibold text-secondary ml-2">0%</span>
                        </div>
                    </div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Unrealized P/L</h3><p id="unrealized-pl" class="text-2xl font-bold mt-1">$0.00</p></div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Total Open P/L (R)</h3><p id="total-open-r" class="text-2xl font-bold mt-1">0.00R</p></div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Total Open Risk (R)</h3><p id="total-open-risk-card" class="text-2xl font-bold mt-1">0.00R</p></div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Realized P/L</h3><p id="realized-pl" class="text-2xl font-bold mt-1">$0.00</p></div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Win Rate</h3><p id="win-rate" class="text-2xl font-semibold mt-1">0%</p></div>
                    <div class="stat-card p-5 rounded-lg"><h3 class="text-sm font-medium text-secondary">Profit Factor</h3><p id="profit-factor" class="text-xl font-semibold mt-1">0.00</p></div>
                </section>

                <section class="themed-bg p-6 rounded-lg h-80 sm:h-96">
                    <h2 class="text-2xl font-bold mb-4">Net Asset Value (NAV)</h2>
                    <canvas id="nav-chart"></canvas>
                </section>
            </div>

            <aside class="space-y-8">
                 <section id="portfolio-allocation-section" class="themed-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Portfolio Allocation</h2>
                    <div id="allocation-chart-container" class="h-64 flex items-center justify-center">
                        <canvas id="allocation-chart"></canvas>
                        <p id="allocation-placeholder" class="text-slate-400 text-center hidden"></p>
                    </div>
                </section>
                 <section id="risk-exposure-dashboard" class="themed-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Risk Exposure</h2>
                    <div class="space-y-4 text-base">
                        <div class="flex justify-between">
                            <span class="font-medium text-secondary">High-Water Mark</span>
                            <span id="high-water-mark" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-secondary">Current Drawdown</span>
                            <span id="current-drawdown" class="font-semibold">$0.00 (0.00%)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-secondary">Total Open Risk</span>
                            <span id="total-open-risk" class="font-semibold">0.00R</span>
                        </div>
                        <div class="flex justify-between items-center mt-3 pt-3 border-t" style="border-color: var(--border-color);">
                            <span class="font-medium text-secondary">Risk Zone</span>
                            <span id="risk-zone" class="px-3 py-1 text-sm font-bold rounded-full"></span>
                        </div>
                    </div>
                </section>

                <section class="themed-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Data Management</h2>
                    <div class="space-y-4">
                        <button id="btn-import" class="btn w-full btn-primary py-2.5 px-4 rounded-md font-semibold">Import Local Data</button>
                        <input type="file" id="file-input" class="hidden" accept=".json">
                        <button id="btn-load-online" class="btn w-full btn-primary py-2.5 px-4 rounded-md font-semibold">Load Online Data</button>
                        <button id="btn-export" class="btn w-full btn-secondary py-2.5 px-4 rounded-md font-semibold">Export Data</button>
                    </div>
                </section>
                
                <section class="themed-bg p-6 rounded-lg">
                    <h2 class="text-xl font-bold mb-4">Actions</h2>
                    <div class="space-y-4">
                        <button id="btn-add-trade" class="btn w-full btn-primary py-2.5 px-4 rounded-md font-semibold">Add New Trade</button>
                        <button id="btn-update-stop" class="btn w-full btn-primary py-2.5 px-4 rounded-md font-semibold">Update Trailing Stop</button>
                        <button id="btn-view-stop-history" class="btn w-full btn-primary py-2.5 px-4 rounded-md font-semibold">View Trailing Stop History</button>
                        <button id="btn-exit-trade" class="btn w-full btn-secondary py-2.5 px-4 rounded-md font-semibold">Exit Trade</button>
                        <button id="btn-refresh" class="btn w-full btn-primary py-2.5 px-4 rounded-md font-semibold flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 12M20 20l-1.5-1.5A9 9 0 003.5 12"></path></svg>
                            Refresh Prices
                        </button>
                    </div>
                </section>
                
                <section class="themed-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Configuration & Analysis</h2>
                    <div class="space-y-4">
                        <button id="btn-settings" class="btn w-full bg-slate-600 text-white py-2.5 px-4 rounded-md font-semibold">Set Capital & Risk</button>
                        <button id="btn-provider-settings" class="btn w-full bg-slate-600 text-white py-2.5 px-4 rounded-md font-semibold">Data Provider Settings</button>
                        <button id="btn-cloud-api-settings" class="btn w-full bg-slate-600 text-white py-2.5 px-4 rounded-md font-semibold">Cloud API Settings</button>
                        <button id="btn-cloud-ai-prompt" class="btn w-full bg-slate-600 text-white py-2.5 px-4 rounded-md font-semibold">Cloud AI Prompts</button>
                        <button id="btn-view-stats" class="btn w-full bg-slate-600 text-white py-2.5 px-4 rounded-md font-semibold">View Advanced Stats</button>
                        <hr style="border-color: var(--border-color);">
                        <button id="btn-gen-summary" class="btn w-full btn-secondary py-2.5 px-4 rounded-md font-semibold">✨ Generate Weekly Summary</button>
                        <button id="btn-analyze-portfolio" class="btn w-full btn-secondary py-2.5 px-4 rounded-md font-semibold">📈 Analyze Current Portfolio</button>
                        <button id="btn-describe-holdings" class="btn w-full btn-secondary py-2.5 px-4 rounded-md font-semibold">📄 Describe Trade History</button>
                    </div>
                </section>
            </aside>
        </div>

        <section class="mt-8 themed-bg p-4 md:p-6 rounded-lg shadow">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold">Trade History</h2>
                 <div class="flex items-center space-x-2">
                     <span class="text-sm font-medium text-secondary">Show Closed</span>
                     <label for="toggle-closed-trades" class="flex items-center cursor-pointer">
                         <div class="relative">
                             <input type="checkbox" id="toggle-closed-trades" class="sr-only">
                             <div class="block bg-gray-600 w-10 h-6 rounded-full"></div>
                             <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                         </div>
                     </label>
                     <style>
                         #toggle-closed-trades:checked ~ .dot { transform: translateX(100%); }
                         #toggle-closed-trades:checked ~ .block { background-color: var(--accent-secondary); }
                     </style>
                 </div>
            </div>
             <div class="overflow-x-auto">
                <table id="trades-table" class="min-w-full">
                    <thead id="trades-head">
                        <tr>
                            <th data-sort="ticker" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Ticker<span class="sort-indicator"></span></th>
                            <th data-sort="entryDate" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Entry Date<span class="sort-indicator"></span></th>
                            <th data-sort="weightedAverageEntry" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Avg. Entry<span class="sort-indicator"></span></th>
                            <th data-sort="currentPrice" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Current Price<span class="sort-indicator"></span></th>
                            <th data-sort="currentPositionSize" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Position<span class="sort-indicator"></span></th>
                            <th data-sort="percentOfAssets" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">% of Assets<span class="sort-indicator"></span></th>
                            <th data-sort="initialStop" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Initial Stop<span class="sort-indicator"></span></th>
                            <th data-sort="trailingStop" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Trailing Stop<span class="sort-indicator"></span></th>
                            <th data-sort="currentRiskR" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Current Risk (R)<span class="sort-indicator"></span></th>
                            <th data-sort="unrealizedPL" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Unrealized P/L<span class="sort-indicator"></span></th>
                            <th data-sort="realizedPL" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Realized P/L<span class="sort-indicator"></span></th>
                            <th data-sort="totalR" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Total P/L (R)<span class="sort-indicator"></span></th>
                            <th data-sort="status" class="sortable-header px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Status<span class="sort-indicator"></span></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="trades-body"></tbody>
                </table>
             </div>
        </section>

        <section class="mt-8 themed-bg p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-2xl font-bold mb-4">NAV History</h2>
            <div id="nav-history-container" class="overflow-x-auto"></div>
        </section>
    </main>

    <div id="trade-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Trade</h2>
            <form id="trade-form">
                <input type="hidden" id="trade-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="ticker" class="block text-sm font-medium text-secondary">Ticker</label><input type="text" id="ticker" required class="mt-1 block w-full input"></div>
                    <div><label for="entry-date" class="block text-sm font-medium text-secondary">Date</label><input type="date" id="entry-date" required class="mt-1 block w-full input"></div>
                    <div><label for="entry-price" class="block text-sm font-medium text-secondary">Price</label><input type="number" step="any" id="entry-price" required class="mt-1 block w-full input"></div>
                    <div><label for="quantity" class="block text-sm font-medium text-secondary">Quantity</label><input type="number" step="any" id="quantity" required class="mt-1 block w-full input"></div>
                    <div class="md:col-span-2"><label for="initial-stop" class="block text-sm font-medium text-secondary">Initial Stop</label><input type="number" step="any" id="initial-stop" required class="mt-1 block w-full input"></div>
                    <div class="md:col-span-2"><label for="sector" class="block text-sm font-medium text-secondary">Sector</label><div class="flex items-center space-x-2 mt-1"><input type="text" id="sector" class="block w-full input"><button type="button" id="btn-find-sector" class="btn bg-teal-100 text-teal-700 py-2 px-3 rounded-md text-sm whitespace-nowrap">✨ Find Sector</button></div></div>
                    <div class="md:col-span-2"><label for="tags" class="block text-sm font-medium text-secondary">Tags (comma-separated)</label><input type="text" id="tags" class="mt-1 block w-full input"></div>
                    <div class="md:col-span-2"><label for="trade-notes" class="block text-sm font-medium text-secondary">Notes</label><textarea id="trade-notes" rows="2" class="mt-1 block w-full input"></textarea></div>
                </div>
                
                <hr class="my-6" style="border-color: var(--border-color);">
                <h3 class="text-lg font-semibold mb-4">Trade Psychology</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label for="emotional-state" class="block text-sm font-medium text-secondary">Emotional State</label>
                        <select id="emotional-state" class="mt-1 block w-full input">
                            <option>Neutral</option>
                            <option>Confident</option>
                            <option>Anxious</option>
                            <option>Greedy</option>
                            <option>Fearful</option>
                            <option>FOMO</option>
                            <option>Disciplined</option>
                        </select>
                    </div>
                </div>
                 <div class="mt-4">
                    <label for="psychology-notes" class="block text-sm font-medium text-secondary">Psychology Notes</label>
                    <textarea id="psychology-notes" rows="3" class="mt-1 block w-full input"></textarea>
                </div>
                
                <div class="mt-6 flex justify-between items-center">
                    <button type="button" id="btn-analyze-trade" class="btn bg-purple-100 text-purple-700 py-2 px-4 rounded-md">✨ Analyze</button>
                    <div><button type="button" class="btn-cancel py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn-save btn ml-2 btn-primary text-white py-2 px-4 rounded-md">Save</button></div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="exit-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-md">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6">Exit Position</h2>
            <form id="exit-form">
                 <div class="space-y-4">
                    <div><label for="exit-select" class="block text-sm font-medium text-secondary">Select Open Position</label><select id="exit-select" required class="mt-1 block w-full input"></select></div>
                    <div class="text-sm">Current Position: <span id="exit-current-position" class="font-semibold"></span></div>
                    <div><label for="exit-date" class="block text-sm font-medium text-secondary">Exit Date</label><input type="date" id="exit-date" required class="mt-1 block w-full input"></div>
                    <div><label for="exit-price" class="block text-sm font-medium text-secondary">Exit Price</label><input type="number" step="any" id="exit-price" required class="mt-1 block w-full input"></div>
                    <div><label for="exit-quantity" class="block text-sm font-medium text-secondary">Exit Quantity</label><input type="number" step="any" id="exit-quantity" required class="mt-1 block w-full input"></div>
                    <div><label for="exit-remarks" class="block text-sm font-medium text-secondary">Exit Remarks (Notes)</label><textarea id="exit-remarks" rows="3" class="mt-1 block w-full input"></textarea></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-cancel py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn btn-secondary py-2 px-4 rounded-md">Save Exit</button></div>
            </form>
        </div>
    </div>
    
     <div id="stop-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-md">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6">Update Trailing Stop</h2>
            <form id="stop-form">
                 <div class="space-y-4">
                    <div><label for="stop-select" class="block text-sm font-medium text-secondary">Select Open Position</label><select id="stop-select" required class="mt-1 block w-full input"></select></div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-secondary">Current Trailing Stop</label>
                        <p id="current-trailing-stop" class="mt-1 text-lg font-semibold">N/A</p>
                    </div>
                    <div><label for="new-stop" class="block text-sm font-medium text-secondary">New Trailing Stop</label><input type="number" step="any" id="new-stop" required class="mt-1 block w-full input"></div>
                    <div><label for="stop-remarks" class="block text-sm font-medium text-secondary">Remarks</label><textarea id="stop-remarks" rows="2" class="mt-1 block w-full input"></textarea></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-cancel py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn btn-primary py-2 px-4 rounded-md">Update Stop</button></div>
            </form>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-md">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6">Account & Risk Settings</h2>
            <form id="settings-form">
                 <div class="space-y-4">
                    <h3 class="text-lg font-semibold border-b pb-2" style="border-color: var(--border-color);">Account</h3>
                    <div><label for="set-capital" class="block text-sm font-medium text-secondary">Initial Capital</label><input type="number" id="set-capital" step="any" class="mt-1 block w-full input"></div>
                    <div><label for="set-cash" class="block text-sm font-medium text-secondary">Current Cash</label><input type="number" id="set-cash" step="any" class="mt-1 block w-full input"></div>
                    
                    <h3 class="text-lg font-semibold border-b pb-2 pt-4" style="border-color: var(--border-color);">Risk Management</h3>
                    <div><label for="set-risk-percent" class="block text-sm font-medium text-secondary">Risk Per Trade (% of Capital)</label><input type="number" id="set-risk-percent" step="0.1" class="mt-1 block w-full input"></div>
                    <div><label for="set-moderate-dd" class="block text-sm font-medium text-secondary">Moderate Drawdown Threshold (%)</label><input type="number" id="set-moderate-dd" step="0.1" class="mt-1 block w-full input"></div>
                    <div><label for="set-high-risk-dd" class="block text-sm font-medium text-secondary">High-Risk Drawdown Threshold (%)</label><input type="number" id="set-high-risk-dd" step="0.1" class="mt-1 block w-full input"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-cancel py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn btn-primary py-2 px-4 rounded-md">Save</button></div>
            </form>
        </div>
    </div>

    <div id="provider-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-lg">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6">Data Provider Settings</h2>
            <form id="provider-form">
                 <div><label for="alphavantage-key" class="block text-sm font-medium text-secondary">Alpha Vantage API Key</label><input type="password" id="alphavantage-key" class="mt-1 block w-full input"></div>
                 <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-cancel py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn btn-primary py-2 px-4 rounded-md">Save</button></div>
            </form>
        </div>
    </div>
    
    <div id="cloud-api-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6">Cloud API Settings</h2>
            
            <form id="cloud-api-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-6 p-4 border rounded-lg" style="border-color: var(--border-color);">
                <input type="hidden" id="cloud-api-id">
                <div><label for="cloud-api-name" class="block text-sm font-medium text-secondary">Name</label><input type="text" id="cloud-api-name" class="mt-1 block w-full input" required></div>
                <div><label for="cloud-api-key" class="block text-sm font-medium text-secondary">API Key</label><input type="password" id="cloud-api-key" class="mt-1 block w-full input" required></div>
                <div><label for="cloud-api-base-url" class="block text-sm font-medium text-secondary">Base URL</label><input type="text" id="cloud-api-base-url" class="mt-1 block w-full input" required></div>
                <div><label for="cloud-api-model" class="block text-sm font-medium text-secondary">Model</label><input type="text" id="cloud-api-model" class="mt-1 block w-full input" required></div>
                <div class="md:col-span-4 flex justify-end mt-2"><button type="submit" class="btn btn-primary py-2 px-4 rounded-md">Add/Update API</button></div>
            </form>

            <div id="cloud-api-list-container" class="overflow-x-auto">
                 <table id="cloud-api-table" class="min-w-full">
                    <thead id="cloud-api-table-head">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">Base URL</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">Model</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cloud-api-body"></tbody>
                </table>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" class="btn-cancel py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>

     <div id="cloud-prompt-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6">Cloud AI Prompt Settings</h2>
             <div id="cloud-prompt-tabs" class="flex border-b" style="border-color: var(--border-color);">
                <button data-tab="weekly-summary" class="tab-button tab-active px-4 py-2 text-sm font-medium focus:outline-none rounded-t-lg">Weekly Summary</button>
                <button data-tab="describe-holdings" class="tab-button tab-inactive px-4 py-2 text-sm font-medium focus:outline-none rounded-t-lg">Describe Holdings</button>
                <button data-tab="portfolio-analysis" class="tab-button tab-inactive px-4 py-2 text-sm font-medium focus:outline-none rounded-t-lg">Portfolio Analysis</button>
                <button data-tab="trade-analysis" class="tab-button tab-inactive px-4 py-2 text-sm font-medium focus:outline-none rounded-t-lg">Trade Analysis</button>
                <button data-tab="find-sector" class="tab-button tab-inactive px-4 py-2 text-sm font-medium focus:outline-none rounded-t-lg">Find Sector</button>
             </div>
            <form id="cloud-prompt-form" class="space-y-4 mt-4">
                <div data-tab-panel="weekly-summary">
                    <label for="prompt-cloud-weekly-summary" class="block text-sm font-medium text-secondary">Weekly Summary Prompt</label>
                    <textarea id="prompt-cloud-weekly-summary" rows="4" class="mt-1 block w-full input"></textarea>
                </div>
                 <div data-tab-panel="describe-holdings" class="hidden">
                    <label for="prompt-cloud-describe-holdings" class="block text-sm font-medium text-secondary">Describe Holdings Prompt</label>
                    <textarea id="prompt-cloud-describe-holdings" rows="4" class="mt-1 block w-full input"></textarea>
                </div>
                <div data-tab-panel="portfolio-analysis" class="hidden">
                    <label for="prompt-cloud-portfolio-analysis" class="block text-sm font-medium text-secondary">Portfolio Analysis Prompt</label>
                    <textarea id="prompt-cloud-portfolio-analysis" rows="4" class="mt-1 block w-full input"></textarea>
                </div>
                 <div data-tab-panel="trade-analysis" class="hidden">
                    <label for="prompt-cloud-trade-analysis" class="block text-sm font-medium text-secondary">Trade Analysis Prompt</label>
                    <textarea id="prompt-cloud-trade-analysis" rows="4" class="mt-1 block w-full input"></textarea>
                </div>
                 <div data-tab-panel="find-sector" class="hidden">
                    <label for="prompt-cloud-find-sector" class="block text-sm font-medium text-secondary">Find Sector Prompt</label>
                    <textarea id="prompt-cloud-find-sector" rows="4" class="mt-1 block w-full input"></textarea>
                </div>
                 <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="btn-cancel py-2 px-4 rounded-md">Cancel</button>
                    <button type="submit" class="btn btn-primary py-2 px-4 rounded-md">Save</button>
                </div>
            </form>
        </div>
    </div>


    <div id="summary-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4">✨ Weekly Performance Summary</h2>
            <div id="summary-content" class="prose max-w-none space-y-4 min-h-[100px]"></div>
            <div class="mt-6 flex justify-end items-center">
                <button type="button" id="btn-copy-summary" class="btn bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300">Copy</button>
                <button type="button" class="btn-cancel btn ml-2 bg-slate-500 text-white py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <div id="stats-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4">Advanced Statistics</h2>
            <div id="stats-content" class="prose max-w-none space-y-4"></div>
            <div class="mt-6 flex justify-end"><button type="button" class="btn-cancel py-2 px-4 rounded-md">Close</button></div>
        </div>
    </div>

    <div id="portfolio-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4">📈 Current Portfolio Analysis</h2>
            <div id="portfolio-content" class="prose max-w-none space-y-4 min-h-[100px]"></div>
            <div class="mt-6 flex justify-end items-center">
                <button type="button" id="btn-copy-portfolio" class="btn bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300">Copy</button>
                <button type="button" class="btn-cancel btn ml-2 btn-primary text-white py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <div id="holdings-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4">📄 Trade History Description</h2>
            <div id="holdings-content" class="prose max-w-none space-y-4 min-h-[100px]"></div>
            <div class="mt-6 flex justify-between items-center">
                <button type="button" id="btn-copy-holdings" class="btn bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300">Copy</button>
                <button type="button" class="btn-cancel btn bg-slate-500 text-white py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>

    <div id="ai-trade-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4">✨ AI Trade Analysis</h2>
            <div id="ai-trade-content" class="prose max-w-none space-y-4 min-h-[100px]"></div>
            <div class="mt-6 flex justify-end space-x-3">
                 <button type="button" id="btn-copy-ai-trade" class="btn bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300">Copy</button>
                <button type="button" class="btn-cancel btn btn-primary text-white py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>

    <div id="sector-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-sm">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-xl font-bold mb-4">Sector Identified</h2>
            <div id="sector-content" class="text-lg font-semibold text-center"></div>
            <div class="mt-6 flex justify-end"><button type="button" class="btn-cancel py-2 px-4 rounded-md">Close</button></div>
        </div>
    </div>
    
     <div id="stop-history-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <button type="button" class="btn-cancel absolute top-3 right-3 p-1 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6">Trailing Stop History</h2>
            <div class="space-y-4">
                <div><label for="stop-history-select" class="block text-sm font-medium text-secondary">Select Trade</label>
                    <select id="stop-history-select" class="mt-1 block w-full input"></select>
                </div>
                <div id="stop-history-content" class="mt-4"></div>
            </div>
            <div class="mt-6 flex justify-end">
                <button type="button" class="btn-cancel py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <div id="alert-modal" class="alert-modal-overlay">
        <div class="alert-modal-content">
            <p id="alert-msg" class="mb-6 text-lg"></p>
            <div id="alert-ok">
                <button id="btn-alert-ok" class="btn btn-primary py-2 px-6 rounded-md">OK</button>
            </div>
            <div id="alert-confirm" class="hidden justify-center gap-4">
                <button id="btn-confirm-cancel" class="btn-cancel py-2 px-6 rounded-md">Cancel</button>
                <button id="btn-confirm-ok" class="btn btn-secondary py-2 px-6 rounded-md">Proceed</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // =================================================================================
    // MODULE: State
    // Manages the application's data and settings.
    // =================================================================================
    const State = {
        trades: [],
        navHistory: [],
        settings: {},
        ui: {
            showClosedTrades: false,
            sort: {
                key: 'totalR',
                direction: 'desc'
            }
        },
        charts: {
            navChart: null,
            allocationChart: null
        }
    };
    
    const getDefaultSettings = () => ({
        initialCapital: 10, 
        currentCash: 10,
        highWaterMark: 10,
        riskPerTradePercentage: 0.8,
        moderateDrawdownThreshold: 5,
        highRiskDrawdownThreshold: 10,
        alphaVantageKey: '',
        cloudApiConfigs: [
            { id: 'cloud-1', name: "API1", apiKey: "sk-uhSkLuAGsKmqb5GvoQvNu21KHEBfplRBTINcqhzUcunnBdN0", baseUrl: "http://xingkong.yousebaby.com/v1", model: "[EXPRESS] gemini-2.5-pro-preview-06-05" },
            { id: 'cloud-2', name: "API2", apiKey: "sk-uhSkLuAGsKmqb5GvoQvNu21KHEBfplRBTINcqhzUcunnBdN0", baseUrl: "http://xingkong.yousebaby.com/v1", model: "grok-3" },
            { id: 'cloud-3', name: "API3", apiKey: "sk-uhSkLuAGsKmqb5GvoQvNu21KHEBfplRBTINcqhzUcunnBdN0", baseUrl: "http://xingkong.yousebaby.com/v1", model: "grok-3-reasoning" },
            { id: 'cloud-4', name: "API4", apiKey: "sk-klfaPYWN1J8EiI2X6ZAssgkbKtgmPXCtoCq0VndFZo7fhFN0", baseUrl: "http://121.62.28.36:3002/v1", model: "gemini-2.5-pro-preview-05-06" },
            { id: 'cloud-5', name: "API5", apiKey: "auth0|6814bb514201ed4536f06592", baseUrl: "https://deepseek.erikpsw.works/v1", model: "qwen3-235b-a22b-non-thinking" },
            { id: 'cloud-6', name: "API6", apiKey: "sk-7O1ZQWEgyGzFhyQPp2wx2geg2wpjEWojtli60GWdD7mUmgg2", baseUrl: "https://api.sikong.shop/v1", model: "gemini-2.5-pro-preview-05-06" }
        ],
        promptCloudWeeklySummary: 'Generate a weekly trading performance summary based on this data:\n{{DATA}}\n\nProvide brief, insightful commentary on the performance.',
        promptCloudDescribeHoldings: 'Based on the following data for open positions, provide a clear, factual summary of the current trade history. For each position, describe the key metrics like position size, entry price, unrealized P/L, and stop levels. Present the output in a readable format, potentially using bullet points for each ticker.\n\nData:\n{{DATA}}',
        promptCloudPortfolioAnalysis: 'Analyze this open portfolio:\n\n**Overview:**\n{{DATA}}\n\n**Request:**\n1. Analyze concentration risk.\n2. Note strengths/weaknesses.\n3. Pose 1-2 insightful questions for me to consider.',
        promptCloudTradeAnalysis: 'Analyze this trade setup:\n- Ticker: {{TICKER}}\n- Entry: {{ENTRY}}\n- Stop: {{STOP}}\n- Psychology Notes: "{{NOTES}}"\n\nWhat is a potential rationale and what are the risks? Be concise.',
        promptCloudFindSector: 'GICS sector for ticker {{TICKER}}? Respond with only the sector name.'
    });

    // =================================================================================
    // MODULE: DOM
    // Caches references to all DOM elements used in the application.
    // =================================================================================
    const DOM = {};
    const cacheDom = () => {
        const ids = [
            'total-assets', 'current-cash', 'cash-percentage', 'unrealized-pl', 'total-open-r', 'total-open-risk-card',
            'realized-pl', 'win-rate', 'profit-factor', 'nav-chart', 'btn-import', 'file-input', 'btn-load-online',
            'btn-export', 'btn-add-trade', 'btn-update-stop', 'btn-view-stop-history', 'btn-exit-trade', 'btn-refresh', 
            'btn-settings', 'btn-provider-settings', 'btn-cloud-api-settings', 'btn-cloud-ai-prompt', 'btn-view-stats', 
            'btn-gen-summary', 'btn-analyze-portfolio', 'btn-describe-holdings', 
            'allocation-chart', 'allocation-chart-container', 'allocation-placeholder',
            'high-water-mark', 'current-drawdown', 'risk-zone', 'total-open-risk', 'nav-history-container',
            'trades-table', 'trades-head', 'trades-body', 'toggle-closed-trades',
            'trade-modal', 'modal-title', 'trade-form', 'trade-id', 'ticker', 'entry-date', 'entry-price', 
            'quantity', 'initial-stop', 'sector', 'tags', 'trade-notes', 'emotional-state', 'psychology-notes', 
            'btn-find-sector', 'btn-analyze-trade',
            'exit-modal', 'exit-form', 'exit-select', 'exit-current-position', 'exit-date', 'exit-price', 'exit-quantity', 'exit-remarks',
            'stop-modal', 'stop-form', 'stop-select', 'new-stop', 'stop-remarks', 'current-trailing-stop',
            'stop-history-modal', 'stop-history-select', 'stop-history-content',
            'settings-modal', 'settings-form', 'set-capital', 'set-cash', 'set-risk-percent', 'set-moderate-dd', 'set-high-risk-dd',
            'provider-modal', 'provider-form', 'alphavantage-key', 
            'cloud-api-modal', 'cloud-api-form', 'cloud-api-id', 'cloud-api-name', 'cloud-api-key', 'cloud-api-base-url', 'cloud-api-model',
            'cloud-api-list-container', 'cloud-api-table', 'cloud-api-body',
            'cloud-prompt-modal', 'cloud-prompt-form', 'prompt-cloud-weekly-summary', 'prompt-cloud-describe-holdings', 'prompt-cloud-portfolio-analysis', 'prompt-cloud-trade-analysis', 'prompt-cloud-find-sector',
            'summary-modal', 'summary-content', 'btn-copy-summary',
            'stats-modal', 'stats-content',
            'portfolio-modal', 'portfolio-content', 'btn-copy-portfolio',
            'holdings-modal', 'holdings-content', 'btn-copy-holdings',
            'ai-trade-modal', 'ai-trade-content', 'btn-copy-ai-trade',
            'sector-modal', 'sector-content', 'alert-modal', 'alert-msg', 'alert-ok',
            'btn-alert-ok', 'alert-confirm', 'btn-confirm-cancel', 'btn-confirm-ok',
            'cloud-prompt-tabs'
        ];
        ids.forEach(id => DOM[id] = document.getElementById(id));
        DOM.modalCancelButtons = document.querySelectorAll('.btn-cancel');
    };

    // =================================================================================
    // MODULE: Utils
    // Provides utility and helper functions.
    // =================================================================================
    const Utils = {
        formatCurrency: (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0),
        formatDate: (dateStr) => {
            if (!dateStr) return 'N/A';
            const d = new Date(dateStr);
            return new Date(d.getTime() + d.getTimezoneOffset() * 60000).toLocaleDateString('en-CA');
        },
        formatTime: (isoString) => {
            if (!isoString) return '';
            return new Date(isoString).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        },
        formatDuration: (ms) => {
            if (ms < 0 || isNaN(ms)) return 'N/A';
            const d = Math.floor(ms / 864e5), h = Math.floor(ms % 864e5 / 36e5), m = Math.floor(ms % 36e5 / 6e4);
            return [d && `${d}d`, h && `${h}h`, m && `${m}m`].filter(Boolean).join(' ') || '0m';
        },
        showAlert: (msg, type = 'alert', cb) => {
            DOM['alert-msg'].innerHTML = msg;
            const okDiv = DOM['alert-ok'];
            const confirmDiv = DOM['alert-confirm'];
            if (type === 'confirm') {
                okDiv.classList.add('hidden');
                confirmDiv.classList.remove('hidden');
                confirmDiv.style.display = 'flex';
                DOM['btn-confirm-ok'].onclick = () => { Utils.closeAlert(); cb?.(true); };
                DOM['btn-confirm-cancel'].onclick = () => { Utils.closeAlert(); cb?.(false); };
            } else {
                confirmDiv.classList.add('hidden');
                okDiv.classList.remove('hidden');
                DOM['btn-alert-ok'].onclick = () => { Utils.closeAlert(); cb?.(true); };
            }
            DOM['alert-modal'].classList.add('visible');
        },
        closeAlert: () => DOM['alert-modal'].classList.remove('visible'),
        copyToClipboard: (text, message = 'Copied to clipboard!') => {
            if (!text) { Utils.showAlert('Nothing to copy.'); return; }
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                Utils.showAlert(message);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                Utils.showAlert('Failed to copy text.');
            }
            document.body.removeChild(textArea);
        },
    };
    
    // =================================================================================
    // MODULE: API
    // Handles interactions with external APIs like Alpha Vantage and Cloud LLMs.
    // =================================================================================
    const API = {
        callCloudLlm: async (systemPrompt, userPrompt) => {
            const cloudConfigs = State.settings.cloudApiConfigs;
            if (!cloudConfigs.length) return `Error: No Cloud APIs configured.`;
            
            let lastError = "No APIs available to try.";
            for (const config of cloudConfigs) {
                console.log(`Trying Cloud API: ${config.name}`);
                const result = await API.callOpenAICompatibleLlm(systemPrompt, userPrompt, {
                    name: config.name,
                    BASE_URL: config.baseUrl,
                    API_KEY: config.apiKey,
                    MODEL: config.model
                });
                if (!result.startsWith('Error:')) return result;
                lastError = result;
            }
            return `Error: All Cloud APIs failed. Last error: ${lastError}`;
        },
        callOpenAICompatibleLlm: async (systemPrompt, userPrompt, apiConfig) => {
            const apiUrl = `${apiConfig.BASE_URL}/chat/completions`;
            const payload = { model: apiConfig.MODEL, messages: [{ "role": "system", "content": systemPrompt }, { "role": "user", "content": userPrompt }] };
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiConfig.API_KEY}` },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorBody}`);
                }
                const result = await response.json();
                if (result.choices?.[0]?.message) return result.choices[0].message.content;
                throw new Error('Invalid response structure from API.');
            } catch (error) {
                console.error(`Error with ${apiConfig.name}:`, error);
                return `Error: ${error.message}`;
            }
        },
        refreshPrices: async () => {
            const openTrades = State.trades.filter(t => t.status === 'Open');
            if (!openTrades.length) return Utils.showAlert('No open positions to refresh.');
            if (!State.settings.alphaVantageKey) return Utils.showAlert('Alpha Vantage API key is not set.');
            
            UI.setLoading(DOM['btn-refresh'], true, 'Refreshing...');
            const errorMessages = new Set();
            for (const trade of openTrades) {
                try {
                    const symbol = trade.ticker.trim();
                    const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${State.settings.alphaVantageKey}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    const price = data?.['Global Quote']?.['05. price'];
                    if (price) {
                        trade.currentPrice = parseFloat(price);
                    } else {
                        errorMessages.add(data.Note || data['Error Message'] || `Could not find price for ${trade.ticker}.`);
                    }
                } catch (error) {
                    errorMessages.add(`Network error for ${trade.ticker}.`);
                }
                if (openTrades.indexOf(trade) < openTrades.length - 1) await new Promise(resolve => setTimeout(resolve, 15000));
            }
            Calc.recordNavPoint(); 
            UI.renderAll();
            const message = errorMessages.size > 0 ? `Price refresh completed with issues:<br>- ${Array.from(errorMessages).join('<br>- ')}` : 'All prices refreshed successfully!';
            Utils.showAlert(message);
            UI.setLoading(DOM['btn-refresh'], false);
        }
    };

    // =================================================================================
    // MODULE: Calc
    // Handles all business logic and financial calculations.
    // =================================================================================
    const Calc = {
        getTradeMetrics: (trade) => {
            const totalEntryQty = trade.entries.reduce((sum, e) => sum + e.quantity, 0);
            if (totalEntryQty === 0) return { unrealizedPL: 0, realizedPL: 0, totalR: 0, currentPositionSize: 0, weightedAverageEntry: 0 };
            
            const totalEntryValue = trade.entries.reduce((sum, e) => sum + (e.price * e.quantity), 0);
            const weightedAverageEntry = totalEntryValue / totalEntryQty;

            const totalExitQty = trade.exits.reduce((sum, e) => sum + e.quantity, 0);
            const currentPositionSize = totalEntryQty - totalExitQty;
            
            let realizedPL = trade.exits.reduce((sum, exit) => sum + (exit.price - weightedAverageEntry) * exit.quantity, 0);
            
            let unrealizedPL = (currentPositionSize > 1e-9 && trade.currentPrice) // Use epsilon for check
                ? (trade.currentPrice - weightedAverageEntry) * currentPositionSize 
                : 0;

            realizedPL = parseFloat(realizedPL.toFixed(2));
            unrealizedPL = parseFloat(unrealizedPL.toFixed(2));

            const { initialCapital, riskPerTradePercentage } = State.settings;
            const accountRValue = initialCapital * (riskPerTradePercentage / 100);
            const totalPL = realizedPL + unrealizedPL;
            const totalR = accountRValue > 0 ? totalPL / accountRValue : 0;

            return { unrealizedPL, realizedPL, totalR, currentPositionSize, weightedAverageEntry };
        },
        getCurrentRiskR: (trade) => {
            if (trade.status !== 'Open') return 0;
            
            const { currentPositionSize, weightedAverageEntry } = Calc.getTradeMetrics(trade);
            if (currentPositionSize <= 0) return 0;

            const { initialCapital, riskPerTradePercentage } = State.settings;
            const accountRValue = initialCapital * (riskPerTradePercentage / 100);
            if (accountRValue <= 0) return 0;
            
            const activeStop = trade.trailingStop || trade.initialStop;
            if (!activeStop) return 0;
            
            const riskInDollars = (weightedAverageEntry - activeStop) * currentPositionSize;
            return riskInDollars / accountRValue;
        },
        getRiskMetrics: () => {
            const openValue = State.trades.filter(t => t.status === 'Open').reduce((sum, t) => {
                const { currentPositionSize, weightedAverageEntry } = Calc.getTradeMetrics(t);
                return sum + ((t.currentPrice || weightedAverageEntry) * currentPositionSize);
            }, 0);
            
            const nav = parseFloat((State.settings.currentCash + openValue).toFixed(2));

            State.settings.highWaterMark = Math.max(State.settings.highWaterMark || nav, nav);
            const drawdownDollars = State.settings.highWaterMark - nav;
            const drawdownPercent = State.settings.highWaterMark > 0 ? (drawdownDollars / State.settings.highWaterMark) * 100 : 0;
            
            return { nav, hwm: State.settings.highWaterMark, drawdownDollars, drawdownPercent };
        },
        getRiskZone: (totalOpenRiskR) => {
            if (totalOpenRiskR > 6) return 'Red';
            if (totalOpenRiskR > 3) return 'Yellow';
            return 'Green';
        },
        getAdvancedStats: () => {
            const closed = State.trades.filter(t => t.status === 'Closed');
            if (!closed.length) return null;

            const winners = closed.filter(t => Calc.getTradeMetrics(t).realizedPL > 0);
            const losers = closed.filter(t => Calc.getTradeMetrics(t).realizedPL <= 0);
            
            const winRate = closed.length ? winners.length / closed.length : 0;
            const totalGains = winners.reduce((s, t) => s + Calc.getTradeMetrics(t).realizedPL, 0);
            const avgWin = winners.length ? totalGains / winners.length : 0;
            const totalLosses = losers.reduce((s, t) => s + Calc.getTradeMetrics(t).realizedPL, 0);
            const avgLoss = losers.length ? Math.abs(totalLosses / losers.length) : 0;
            const largestWin = winners.reduce((max, t) => Math.max(max, Calc.getTradeMetrics(t).realizedPL), 0);
            const largestLoss = losers.reduce((min, t) => Math.min(min, Calc.getTradeMetrics(t).realizedPL), 0);
            
            const getHoldingTime = (trade) => {
                const firstEntry = trade.entries[0]?.date;
                const lastExit = trade.exits[trade.exits.length - 1]?.date;
                return (firstEntry && lastExit) ? new Date(lastExit) - new Date(firstEntry) : 0;
            };

            const avgWinHold = winners.length ? winners.reduce((s, t) => s + getHoldingTime(t), 0) / winners.length : 0;
            const avgLossHold = losers.length ? losers.reduce((s, t) => s + getHoldingTime(t), 0) / losers.length : 0;

            return { total: closed.length, expectancy: (winRate * avgWin) - ((1 - winRate) * avgLoss), winners: winners.length, losers: losers.length, avgWin, avgLoss, largestWin, largestLoss, avgWinHold, avgLossHold };
        },
        recordNavPoint: () => {
            const { nav } = Calc.getRiskMetrics();
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const timestamp = now.toISOString();
            const idx = State.navHistory.findIndex(e => e.date === today);
            
            if (idx > -1) {
                State.navHistory[idx].nav = parseFloat(nav.toFixed(2));
                State.navHistory[idx].timestamp = timestamp;
            } else {
                State.navHistory.push({ date: today, nav: parseFloat(nav.toFixed(2)), timestamp: timestamp });
            }
            State.navHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
        }
    };

    // =================================================================================
    // MODULE: UI
    // Manages all rendering and DOM manipulation.
    // =================================================================================
    const UI = {
        renderAll: () => { 
            const riskMetrics = Calc.getRiskMetrics();
            UI.updateDashboard(riskMetrics); 
            UI.renderTrades(riskMetrics.nav); 
            UI.renderNavChart(); 
            UI.renderAllocationChart(riskMetrics.nav);
            UI.renderNavHistory(); 
        },
        setLoading: (btn, loading, text = '') => {
            if (loading) {
                btn.originalHTML = btn.innerHTML;
                btn.innerHTML = `<span class="flex items-center justify-center"><div class="loader-sm"></div><span class="ml-2">${text}</span></span>`;
                btn.disabled = true;
            } else {
                if (btn.originalHTML) btn.innerHTML = btn.originalHTML;
                btn.disabled = false;
            }
        },
        openModal: (el) => { el.classList.remove('hidden'); setTimeout(() => el.classList.remove('opacity-0'), 10); },
        closeModal: (el) => { el.classList.add('opacity-0'); setTimeout(() => el.classList.add('hidden'), 300); },
        updateDashboard: (riskMetrics) => {
            let totalRealizedPL = 0, totalUnrealizedPL = 0, totalOpenPL_R = 0, totalOpenRisk_R = 0, totalWins = 0, totalGains = 0, totalLossesAbs = 0;
            const closedTrades = State.trades.filter(t => t.status === 'Closed');

            State.trades.forEach(trade => {
                const metrics = Calc.getTradeMetrics(trade);
                totalRealizedPL += metrics.realizedPL;
                if(trade.status === 'Open') {
                    totalUnrealizedPL += metrics.unrealizedPL;
                    totalOpenPL_R += metrics.totalR;
                    totalOpenRisk_R += Calc.getCurrentRiskR(trade);
                }
            });

            const closedMetrics = closedTrades.map(Calc.getTradeMetrics);
            totalWins = closedMetrics.filter(m => m.realizedPL > 0).length;
            totalGains = closedMetrics.filter(m => m.realizedPL > 0).reduce((sum, m) => sum + m.realizedPL, 0);
            totalLossesAbs = Math.abs(closedMetrics.filter(m => m.realizedPL < 0).reduce((sum, m) => sum + m.realizedPL, 0));

            UI.renderRiskDashboard(riskMetrics, totalOpenRisk_R);
            
            DOM['total-assets'].textContent = Utils.formatCurrency(riskMetrics.nav);
            DOM['current-cash'].textContent = Utils.formatCurrency(State.settings.currentCash);
            const cashPercentage = riskMetrics.nav > 0 ? (State.settings.currentCash / riskMetrics.nav) * 100 : 0;
            DOM['cash-percentage'].textContent = `${cashPercentage.toFixed(1)}%`;

            DOM['realized-pl'].textContent = Utils.formatCurrency(totalRealizedPL);
            DOM['realized-pl'].classList.toggle('text-red-600', totalRealizedPL < 0);
            DOM['realized-pl'].classList.toggle('text-green-600', totalRealizedPL >= 0);

            DOM['unrealized-pl'].textContent = Utils.formatCurrency(totalUnrealizedPL);
            DOM['unrealized-pl'].classList.toggle('text-red-600', totalUnrealizedPL < 0);
            DOM['unrealized-pl'].classList.toggle('text-green-600', totalUnrealizedPL >= 0);

            DOM['total-open-r'].textContent = `${totalOpenPL_R.toFixed(2)}R`;
            DOM['total-open-risk-card'].textContent = `${totalOpenRisk_R.toFixed(2)}R`;
            DOM['win-rate'].textContent = `${(closedTrades.length ? (totalWins / closedTrades.length) * 100 : 0).toFixed(1)}%`;
            DOM['profit-factor'].textContent = (totalLossesAbs > 0 ? totalGains / totalLossesAbs : 0).toFixed(2);
        },
        renderRiskDashboard: (riskMetrics, totalOpenRiskR) => {
            const { hwm, drawdownDollars, drawdownPercent } = riskMetrics;
            const riskZone = Calc.getRiskZone(totalOpenRiskR);
            DOM['high-water-mark'].textContent = Utils.formatCurrency(hwm);
            DOM['current-drawdown'].textContent = `${Utils.formatCurrency(drawdownDollars)} (${drawdownPercent.toFixed(2)}%)`;
            DOM['total-open-risk'].textContent = `${(totalOpenRiskR || 0).toFixed(2)}R`;
            const zoneEl = DOM['risk-zone'];
            zoneEl.textContent = riskZone;
            zoneEl.className = 'px-3 py-1 text-sm font-bold rounded-full';
            if (riskZone === 'Green') zoneEl.classList.add('bg-green-100', 'text-green-800');
            else if (riskZone === 'Yellow') zoneEl.classList.add('bg-yellow-100', 'text-yellow-800');
            else zoneEl.classList.add('bg-red-100', 'text-red-800');
        },
        renderTrades: (totalNav) => {
            DOM['trades-head'].querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === State.ui.sort.key) {
                    th.classList.add(State.ui.sort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });

            const tradesWithMetrics = State.trades.map(trade => {
                const metrics = Calc.getTradeMetrics(trade);
                const positionValue = (trade.currentPrice || metrics.weightedAverageEntry) * metrics.currentPositionSize;
                return {
                    ...trade,
                    metrics: {
                        ...metrics,
                        entryDate: trade.entries[0]?.date || '',
                        percentOfAssets: (trade.status === 'Open' && totalNav > 0) ? (positionValue / totalNav * 100) : 0,
                        currentRiskR: trade.status === 'Open' ? Calc.getCurrentRiskR(trade) : -Infinity,
                    }
                };
            });

            let displayedTrades = tradesWithMetrics.filter(t => t.status === 'Open' || State.ui.showClosedTrades);

            const { key, direction } = State.ui.sort;
            const sortDir = direction === 'asc' ? 1 : -1;

            displayedTrades.sort((a, b) => {
                const valA = a.metrics[key] !== undefined ? a.metrics[key] : a[key];
                const valB = b.metrics[key] !== undefined ? b.metrics[key] : b[key];
                
                const valAIsNum = typeof valA === 'number';
                const valBIsNum = typeof valB === 'number';

                if (valAIsNum && valBIsNum) {
                    return (valA - valB) * sortDir;
                }
                
                const strA = String(valA ?? '').toLowerCase();
                const strB = String(valB ?? '').toLowerCase();

                return strA.localeCompare(strB) * sortDir;
            });
            
            DOM['trades-body'].innerHTML = displayedTrades.map(tradeWithMetrics => {
                const { metrics, ...trade } = tradeWithMetrics;
                const { unrealizedPL, realizedPL, totalR, currentPositionSize, weightedAverageEntry } = metrics;
                
                const plClass = (unrealizedPL + realizedPL) >= 0 ? 'text-green-600' : 'text-red-600';
                const statusClass = trade.status === 'Open' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800';
                const currentRiskR = trade.status === 'Open' ? metrics.currentRiskR.toFixed(2) + 'R' : 'N/A';
                const percentOfAssets = (trade.status === 'Open' && totalNav > 0) ? `${metrics.percentOfAssets.toFixed(2)}%` : 'N/A';
                
                const mainRowHTML = `
                    <tr class="trade-row hover:bg-slate-50 cursor-pointer" data-id="${trade.id}">
                        <td data-label="Ticker" class="px-6 py-4 whitespace-nowrap text-sm font-medium">${trade.ticker}</td>
                        <td data-label="Entry Date" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${Utils.formatDate(trade.entries[0]?.date)}</td>
                        <td data-label="Avg. Entry" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${Utils.formatCurrency(weightedAverageEntry)}</td>
                        <td data-label="Current Price" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${trade.currentPrice ? Utils.formatCurrency(trade.currentPrice) : 'N/A'}</td>
                        <td data-label="Position" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${currentPositionSize || '0'}</td>
                        <td data-label="% of Assets" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${percentOfAssets}</td>
                        <td data-label="Initial Stop" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${trade.initialStop ? Utils.formatCurrency(trade.initialStop) : 'N/A'}</td>
                        <td data-label="Trailing Stop" class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${trade.trailingStop ? Utils.formatCurrency(trade.trailingStop) : 'N/A'}</td>
                        <td data-label="Current Risk (R)" class="px-6 py-4 whitespace-nowrap text-sm font-semibold">${currentRiskR}</td>
                        <td data-label="Unrealized P/L" class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${unrealizedPL >= 0 ? 'text-green-600' : 'text-red-600'}">${Utils.formatCurrency(unrealizedPL)}</td>
                        <td data-label="Realized P/L" class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${realizedPL >= 0 ? 'text-green-600' : 'text-red-600'}">${Utils.formatCurrency(realizedPL)}</td>
                        <td data-label="Total P/L (R)" class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${plClass}">${totalR.toFixed(2)}R</td>
                        <td data-label="Status" class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${trade.status}</span></td>
                        <td data-label="Actions" class="px-6 py-4 whitespace-nowrap text-sm"><button data-action="edit-trade" class="text-indigo-600 hover:text-indigo-900 text-xs">Edit</button></td>
                    </tr>`;

                const entriesHTML = trade.entries.map(e => `<tr><td class="px-2 py-1">Entry</td><td class="px-2 py-1">${Utils.formatDate(e.date)}</td><td class="px-2 py-1">${e.quantity}</td><td class="px-2 py-1">${Utils.formatCurrency(e.price)}</td><td class="px-2 py-1 text-xs">${e.notes || ''}</td></tr>`).join('');
                const exitsHTML = trade.exits.map(e => `<tr><td class="px-2 py-1 text-red-500">Exit</td><td class="px-2 py-1">${Utils.formatDate(e.date)}</td><td class="px-2 py-1">${e.quantity}</td><td class="px-2 py-1">${Utils.formatCurrency(e.price)}</td><td class="px-2 py-1 text-xs">${e.notes || ''}</td></tr>`).join('');
                
                const detailsRowHTML = `
                    <tr class="trade-details-row" data-details-for="${trade.id}">
                        <td colspan="14" class="details-cell">
                            <h4 class="font-bold text-sm mb-2">Transaction History</h4>
                            <table class="min-w-full text-xs">
                                <thead class="bg-slate-100"><tr>
                                    <th class="px-2 py-1 text-left">Type</th><th class="px-2 py-1 text-left">Date</th><th class="px-2 py-1 text-left">Qty</th><th class="px-2 py-1 text-left">Price</th><th class="px-2 py-1 text-left">Notes</th>
                                </tr></thead>
                                <tbody>${entriesHTML}${exitsHTML}</tbody>
                            </table>
                        </td>
                    </tr>`;

                return mainRowHTML + detailsRowHTML;
            }).join('');
            if (!displayedTrades.length) DOM['trades-body'].innerHTML = `<tr><td colspan="14" class="text-center py-8 text-secondary">No trades to display.</td></tr>`;
        },
        renderNavChart: () => {
            const ctx = DOM['nav-chart'].getContext('2d');
            if (State.charts.navChart) State.charts.navChart.destroy();
            const chartData = {
                datasets: [{
                    label: 'NAV',
                    data: State.navHistory.map(item => ({ x: new Date(item.date).getTime(), y: item.nav })),
                    borderColor: '#0079D3',
                    backgroundColor: 'rgba(0, 121, 211, 0.1)',
                    borderWidth: 2,
                    pointRadius: State.navHistory.length < 50 ? 3 : 0,
                    fill: true,
                    tension: 0.1
                }]
            };
            const options = { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } }, y: { ticks: { callback: v => Utils.formatCurrency(v) } } } };
            State.charts.navChart = new Chart(ctx, { type: 'line', data: chartData, options: options });
        },
        renderAllocationChart: (totalNav) => {
            if (State.charts.allocationChart) State.charts.allocationChart.destroy();
            
            const openTrades = State.trades.filter(t => t.status === 'Open');
            const allocation = openTrades.reduce((acc, trade) => {
                const sector = trade.sector || 'Uncategorized';
                const { currentPositionSize, weightedAverageEntry } = Calc.getTradeMetrics(trade);
                acc[sector] = (acc[sector] || 0) + (trade.currentPrice || weightedAverageEntry) * currentPositionSize;
                return acc;
            }, {});
            if (State.settings.currentCash > 0) allocation['Cash'] = State.settings.currentCash;
            
            const labels = Object.keys(allocation);
            if (labels.length === 0 || totalNav <= 0) {
                DOM['allocation-chart'].style.display = 'none';
                DOM['allocation-placeholder'].textContent = 'No assets to display.';
                DOM['allocation-placeholder'].style.display = 'block';
                return;
            }
            DOM['allocation-chart'].style.display = 'block';
            DOM['allocation-placeholder'].style.display = 'none';
            
            const ctx = DOM['allocation-chart'].getContext('2d');
            const chartData = {
                labels: labels,
                datasets: [{
                    data: Object.values(allocation),
                    backgroundColor: ['#0079D3', '#FF4500', '#4856a3', '#ffb000', '#7e53c1', '#00a368', '#ff8717', '#a3a3a3'],
                    borderColor: 'var(--bg-secondary)',
                    borderWidth: 2
                }]
            };

            const isMobile = window.innerWidth < 768;

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: !isMobile,
                        position: 'bottom',
                        labels: {
                            generateLabels: (chart) => {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const percentage = totalNav > 0 ? (value / totalNav * 100) : 0;
                                        return {
                                            text: `${label}: ${percentage.toFixed(2)}%`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: isNaN(value),
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.label}: ${Utils.formatCurrency(context.parsed)} (${(context.parsed / totalNav * 100).toFixed(2)}%)`
                        }
                    }
                }
            };
            State.charts.allocationChart = new Chart(ctx, { type: 'pie', data: chartData, options: options });
        },
        renderNavHistory: () => {
            const container = DOM['nav-history-container'];
            if (!State.navHistory || State.navHistory.length === 0) {
                container.innerHTML = '<p class="text-center py-4 text-secondary">No NAV history.</p>';
                return;
            }
            container.innerHTML = `<table id="nav-history-table" class="min-w-full">
                <thead><tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">Last Update</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase">NAV</th>
                </tr></thead>
                <tbody>${State.navHistory.slice().reverse().map(item => `
                    <tr>
                        <td data-label="Date" class="px-6 py-4">${Utils.formatDate(item.date)}</td>
                        <td data-label="Last Update" class="px-6 py-4">${Utils.formatTime(item.timestamp)}</td>
                        <td data-label="NAV" class="px-6 py-4">${Utils.formatCurrency(item.nav)}</td>
                    </tr>`).join('')}
                </tbody></table>`;
        },
        renderCloudApiConfigs: () => {
            DOM['cloud-api-body'].innerHTML = State.settings.cloudApiConfigs.map(config => `
                <tr data-id="${config.id}">
                    <td data-label="Name" class="px-6 py-4">${config.name}</td>
                    <td data-label="Base URL" class="px-6 py-4">${config.baseUrl}</td>
                    <td data-label="Model" class="px-6 py-4">${config.model}</td>
                    <td data-label="Actions" class="px-6 py-4 space-x-2">
                        <button class="text-indigo-600 hover:text-indigo-900" data-action="edit">Edit</button>
                        <button class="text-red-600 hover:text-red-900" data-action="delete">Delete</button>
                    </td>
                </tr>`).join('');
        },
        populateOpenTradesDropdown: (selectId) => {
            const sel = DOM[selectId];
            sel.innerHTML = '<option value="">Select a position...</option>';
            State.trades.filter(t => t.status === 'Open').forEach(t => {
                 sel.innerHTML += `<option value="${t.id}">${t.ticker} (Opened: ${Utils.formatDate(t.entries[0]?.date)})</option>`
            });
        }
    };

    // =================================================================================
    // MODULE: Events
    // Handles all event listeners and user interactions.
    // =================================================================================
    const Events = {
        init: () => {
            DOM['btn-add-trade'].onclick = Events.handleAddTradeClick;
            DOM['btn-exit-trade'].onclick = () => { UI.populateOpenTradesDropdown('exit-select'); DOM['exit-current-position'].textContent = 'N/A'; UI.openModal(DOM['exit-modal']); };
            DOM['btn-update-stop'].onclick = () => { UI.populateOpenTradesDropdown('stop-select'); DOM['current-trailing-stop'].textContent = 'N/A'; DOM['new-stop'].value = ''; DOM['stop-remarks'].value = ''; UI.openModal(DOM['stop-modal']); };
            DOM['btn-refresh'].onclick = API.refreshPrices;
            
            DOM['btn-import'].onclick = () => DOM['file-input'].click();
            DOM['file-input'].onchange = Events.handleImport;
            DOM['btn-load-online'].onclick = Events.handleLoadOnlineData;
            DOM['btn-export'].onclick = Events.handleExport;

            DOM['btn-settings'].onclick = Events.handleOpenSettings;
            DOM['btn-provider-settings'].onclick = () => { DOM['alphavantage-key'].value = State.settings.alphaVantageKey; UI.openModal(DOM['provider-modal']); };
            
            DOM['btn-cloud-api-settings'].onclick = () => { 
                if (!State.settings.cloudApiConfigs) State.settings.cloudApiConfigs = [];
                UI.renderCloudApiConfigs(); 
                UI.openModal(DOM['cloud-api-modal']); 
            };
            
            DOM['btn-cloud-ai-prompt'].onclick = Events.handleOpenCloudPrompts;

            DOM['btn-view-stats'].onclick = Events.handleViewAdvancedStats;
            DOM['btn-gen-summary'].onclick = Events.handleGenSummary;
            DOM['btn-analyze-portfolio'].onclick = Events.handleAnalyzePortfolio;
            DOM['btn-describe-holdings'].onclick = Events.handleDescribeHoldings;
            DOM['btn-view-stop-history'].onclick = Events.handleViewStopHistory;

            DOM['trade-form'].onsubmit = Events.handleSaveTrade;
            DOM['exit-form'].onsubmit = Events.handleSaveExit;
            DOM['stop-form'].onsubmit = Events.handleSaveStop;
            DOM['settings-form'].onsubmit = Events.handleSaveSettings;
            DOM['provider-form'].onsubmit = Events.handleSaveProviderKeys;
            DOM['cloud-api-form'].onsubmit = Events.handleSaveCloudApiConfig;
            DOM['cloud-prompt-form'].onsubmit = Events.handleSaveCloudPrompt;

            DOM['toggle-closed-trades'].onchange = e => { State.ui.showClosedTrades = e.target.checked; UI.renderAll(); };
            DOM['trades-head'].onclick = Events.handleSortTrades;
            DOM['trades-body'].onclick = Events.handleTradesTableClick;
            DOM['cloud-api-body'].onclick = Events.handleCloudApiListClick;
            DOM['cloud-prompt-tabs'].onclick = Events.handleCloudPromptTabClick;
            DOM['stop-select'].onchange = Events.handleStopSelectChange;
            DOM['exit-select'].onchange = Events.handleExitSelectChange;
            DOM.modalCancelButtons.forEach(btn => btn.onclick = () => UI.closeModal(btn.closest('.modal-overlay')));
            
            DOM['btn-find-sector'].onclick = Events.handleFindSector;
            DOM['btn-analyze-trade'].onclick = Events.handleAnalyzeTrade;
            
            DOM['btn-copy-summary'].onclick = () => Utils.copyToClipboard(DOM['summary-content'].innerText);
            DOM['btn-copy-portfolio'].onclick = () => Utils.copyToClipboard(DOM['portfolio-content'].innerText);
            DOM['btn-copy-holdings'].onclick = () => Utils.copyToClipboard(DOM['holdings-content'].innerText);
            DOM['btn-copy-ai-trade'].onclick = () => Utils.copyToClipboard(DOM['ai-trade-content'].innerText);
        },

        handleSortTrades: (e) => {
            const header = e.target.closest('th');
            if (!header || !header.dataset.sort) return;

            const newKey = header.dataset.sort;
            const currentSort = State.ui.sort;

            if (newKey === currentSort.key) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = newKey;
                currentSort.direction = 'desc';
            }
            
            UI.renderAll();
        },

        handleAddTradeClick: () => {
            const totalOpenRisk_R = State.trades.filter(t => t.status === 'Open').reduce((sum, t) => sum + Calc.getCurrentRiskR(t), 0);
            const riskZone = Calc.getRiskZone(totalOpenRisk_R);

            if (riskZone === 'Red') {
                Utils.showAlert('HIGH RISK: Your total open risk exposure exceeds 6R. New trades are restricted.');
                return;
            }
            if (riskZone === 'Yellow') {
                Utils.showAlert('CAUTION: Your total open risk exposure exceeds 3R. Are you sure you want to add a new position?', 'confirm', (proceed) => {
                    if (proceed) Events.openTradeModal();
                });
                return;
            }
            Events.openTradeModal();
        },

        openTradeModal: (tradeId = null) => {
            DOM['trade-form'].reset();
            DOM['trade-id'].value = tradeId || '';

            if(tradeId) {
                const trade = State.trades.find(t => t.id === tradeId);
                DOM['modal-title'].textContent = `Edit Position: ${trade.ticker}`;
                DOM.ticker.value = trade.ticker;
                DOM.ticker.disabled = true;
                DOM['initial-stop'].value = trade.initialStop;
                DOM.sector.value = trade.sector || '';
                DOM.tags.value = trade.tags ? trade.tags.join(', ') : '';
                 ['entry-date', 'entry-price', 'quantity'].forEach(id => DOM[id].closest('div').style.display = 'none');
            } else {
                DOM['modal-title'].textContent = 'Add New Trade / Entry';
                DOM.ticker.disabled = false;
                ['entry-date', 'entry-price', 'quantity', 'initial-stop'].forEach(id => DOM[id].closest('div').style.display = 'block');
            }
            UI.openModal(DOM['trade-modal']);
        },
        
        handleSaveTrade: (e) => {
            e.preventDefault();
            const tradeId = DOM['trade-id'].value;
            const ticker = DOM.ticker.value.toUpperCase().trim();

            if (tradeId) { // EDIT mode
                const trade = State.trades.find(t => t.id === tradeId);
                if (trade) {
                    trade.sector = DOM.sector.value;
                    trade.tags = DOM.tags.value.split(',').map(t => t.trim()).filter(Boolean);
                    trade.initialStop = parseFloat(DOM['initial-stop'].value);
                }
            } else { // ADD mode
                const entryPrice = parseFloat(DOM['entry-price'].value);
                const quantity = parseFloat(DOM.quantity.value);
                const initialStop = parseFloat(DOM['initial-stop'].value);

                if (isNaN(entryPrice) || isNaN(quantity) || isNaN(initialStop) || entryPrice <= 0 || quantity <= 0 || initialStop <= 0) {
                    return Utils.showAlert('Price, Quantity, and Initial Stop must be positive numbers.');
                }
                if (initialStop >= entryPrice) {
                    return Utils.showAlert('Initial Stop must be below the Entry Price for a long position.');
                }

                const entryData = {
                    date: DOM['entry-date'].value,
                    price: entryPrice,
                    quantity: quantity,
                    notes: DOM['trade-notes'].value,
                };
                
                const cost = entryData.price * entryData.quantity;
                if (State.settings.currentCash < cost) return Utils.showAlert('Not enough cash for this transaction.');

                let existingTrade = State.trades.find(t => t.ticker === ticker && t.status === 'Open');
                
                if (existingTrade) {
                    existingTrade.entries.push(entryData);
                    
                    const newPsychologyNotes = DOM['psychology-notes'].value;
                    if (newPsychologyNotes) {
                        existingTrade.psychology.notes += `\n\n--- Entry on ${entryData.date} ---\n${newPsychologyNotes}`;
                    }
                    existingTrade.psychology.emotionalState = DOM['emotional-state'].value;

                    const newInitialStop = parseFloat(DOM['initial-stop'].value);
                    if (!isNaN(newInitialStop) && newInitialStop > 0) {
                        existingTrade.initialStop = newInitialStop;
                    }

                } else {
                     State.trades.push({
                        id: `trade-${Date.now()}`,
                        ticker: ticker,
                        status: 'Open',
                        initialStop: initialStop,
                        trailingStop: null,
                        currentPrice: null,
                        sector: DOM.sector.value,
                        tags: DOM.tags.value.split(',').map(t => t.trim()).filter(Boolean),
                        entries: [entryData],
                        exits: [],
                        stopHistory: [],
                        psychology: {
                            emotionalState: DOM['emotional-state'].value,
                            notes: DOM['psychology-notes'].value
                        }
                    });
                }
                State.settings.currentCash -= cost;
                State.settings.currentCash = parseFloat(State.settings.currentCash.toFixed(2));
            }
            
            UI.closeModal(DOM['trade-modal']);
            Calc.recordNavPoint();
            UI.renderAll();
        },

        handleSaveExit: (e) => {
            e.preventDefault();
            const trade = State.trades.find(t => t.id === DOM['exit-select'].value);
            if (!trade) return Utils.showAlert('Please select a position to exit.');
            
            const exitPrice = parseFloat(DOM['exit-price'].value);
            const exitQuantity = parseFloat(DOM['exit-quantity'].value);
            const exitDate = DOM['exit-date'].value;
            const firstEntryDate = trade.entries[0]?.date;

            if (isNaN(exitPrice) || isNaN(exitQuantity) || exitPrice <= 0 || exitQuantity <= 0) {
                return Utils.showAlert('Exit Price and Quantity must be positive numbers.');
            }
            if (firstEntryDate && exitDate < firstEntryDate) {
                return Utils.showAlert(`Exit Date (${Utils.formatDate(exitDate)}) cannot be before the first entry date (${Utils.formatDate(firstEntryDate)}).`);
            }
            
            const exitData = {
                date: exitDate,
                price: exitPrice,
                quantity: exitQuantity,
                notes: DOM['exit-remarks'].value
            };
            
            const { currentPositionSize } = Calc.getTradeMetrics(trade);
            const epsilon = 1e-9;

            if (exitData.quantity > currentPositionSize + epsilon) {
                return Utils.showAlert(`Cannot exit more than the current position size of ${currentPositionSize}. You tried to exit ${exitData.quantity}.`);
            }

            const actualExitQuantity = Math.min(exitData.quantity, currentPositionSize);

            trade.exits.push({ ...exitData, quantity: actualExitQuantity });
            State.settings.currentCash += exitData.price * actualExitQuantity;
            State.settings.currentCash = parseFloat(State.settings.currentCash.toFixed(2));
            
            const newPositionSize = currentPositionSize - actualExitQuantity;
            if(newPositionSize <= epsilon) {
                trade.status = 'Closed';
            }
            
            Calc.recordNavPoint();
            UI.closeModal(DOM['exit-modal']);
            UI.renderAll();
        },

        handleSaveStop: (e) => {
            e.preventDefault();
            const trade = State.trades.find(t => t.id === DOM['stop-select'].value);
            if(trade) {
                const newStop = parseFloat(DOM['new-stop'].value);
                if (isNaN(newStop) || newStop <= 0) {
                    return Utils.showAlert('New Stop must be a positive number.');
                }

                if (!trade.stopHistory) trade.stopHistory = [];
                trade.stopHistory.push({
                    date: new Date().toISOString(),
                    oldStop: trade.trailingStop || trade.initialStop,
                    newStop: newStop,
                    remarks: DOM['stop-remarks'].value
                });
                trade.trailingStop = newStop;
                UI.closeModal(DOM['stop-modal']);
                UI.renderAll();
            }
        },
        
        handleOpenSettings: () => {
            DOM['set-capital'].value = State.settings.initialCapital;
            DOM['set-cash'].value = State.settings.currentCash;
            DOM['set-risk-percent'].value = State.settings.riskPerTradePercentage;
            DOM['set-moderate-dd'].value = State.settings.moderateDrawdownThreshold;
            DOM['set-high-risk-dd'].value = State.settings.highRiskDrawdownThreshold;
            UI.openModal(DOM['settings-modal']);
        },

        handleSaveSettings: (e) => {
            e.preventDefault();
            State.settings.initialCapital = parseFloat(DOM['set-capital'].value);
            State.settings.currentCash = parseFloat(DOM['set-cash'].value);
            State.settings.riskPerTradePercentage = parseFloat(DOM['set-risk-percent'].value);
            State.settings.moderateDrawdownThreshold = parseFloat(DOM['set-moderate-dd'].value);
            State.settings.highRiskDrawdownThreshold = parseFloat(DOM['set-high-risk-dd'].value);
            State.settings.highWaterMark = State.settings.initialCapital;
            Calc.recordNavPoint();
            UI.closeModal(DOM['settings-modal']);
            UI.renderAll();
        },

        handleSaveProviderKeys: (e) => {
            e.preventDefault();
            State.settings.alphaVantageKey = DOM['alphavantage-key'].value.trim();
            UI.closeModal(DOM['provider-modal']);
            Utils.showAlert(`Data provider settings saved.`);
        },

        handleExport: () => {
            const data = JSON.stringify({ settings: State.settings, trades: State.trades, navHistory: State.navHistory }, null, 2);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([data], {type: 'application/json'}));
            a.download = `trading_journal_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        },

        handleImport: (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    App.loadData(data);
                } catch (err) {
                    Utils.showAlert(`Failed to parse JSON file: ${err.message}`);
                }
            };
            reader.readAsText(file);
        },

        handleLoadOnlineData: async () => {
            const url = 'https://elclel8888.github.io/TradingJ/trading_journal_backup.json';
            UI.setLoading(DOM['btn-load-online'], true, 'Loading...');
            try {
                const response = await fetch(url, { cache: 'no-cache' }); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                App.loadData(data);
            } catch (error) {
                Utils.showAlert(`Failed to load online data: ${error.message}.`);
            } finally {
                UI.setLoading(DOM['btn-load-online'], false);
            }
        },
        
        handleGenSummary: async () => {
            UI.openModal(DOM['summary-modal']);
            DOM['summary-content'].innerHTML = '<div class="flex justify-center p-4"><div class="loader"></div></div>';
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const recentExits = State.trades.flatMap(t => t.exits.filter(exit => new Date(exit.date) >= oneWeekAgo));

            if (!recentExits.length) {
                DOM['summary-content'].innerHTML = "<p>No exits in the last 7 days to summarize.</p>";
                return;
            }
            
            const summaryStats = State.trades.map(Calc.getTradeMetrics);
            const totalPL = summaryStats.reduce((sum, s) => sum + s.realizedPL, 0);
            const totalR = summaryStats.reduce((sum, s) => sum + s.totalR, 0);

            const dataString = `- Total Trades with Exits: ${recentExits.length}\n- Approx Realized P/L: ${Utils.formatCurrency(totalPL)}\n- Approx Total R: ${totalR.toFixed(2)}R`;
            const systemPrompt = "You are a helpful financial analyst AI.";
            const userPrompt = State.settings.promptCloudWeeklySummary.replace('{{DATA}}', dataString);
            
            const result = await API.callCloudLlm(systemPrompt, userPrompt);
            DOM['summary-content'].innerHTML = result.startsWith('Error:') ? `<p class="text-red-500">${result}</p>` : result;
        },

        handleDescribeHoldings: async () => {
            UI.openModal(DOM['holdings-modal']);
            DOM['holdings-content'].innerHTML = '<div class="flex justify-center p-4"><div class="loader"></div></div>';
            const openTrades = State.trades.filter(t => t.status === 'Open');
            if (openTrades.length === 0) {
                 DOM['holdings-content'].innerHTML = '<p>No open holdings to describe.</p>';
                 return;
            }

            const dataString = openTrades.map(t => {
                const m = Calc.getTradeMetrics(t);
                const riskR = Calc.getCurrentRiskR(t);
                const entryDetails = t.entries.map(e => `Entry on ${Utils.formatDate(e.date)}: ${e.quantity} shares at ${Utils.formatCurrency(e.price)} with notes: '${e.notes || 'N/A'}'`).join('; ');
                const exitDetails = t.exits.map(e => `Exit on ${Utils.formatDate(e.date)}: ${e.quantity} shares at ${Utils.formatCurrency(e.price)} with notes: '${e.notes || 'N/A'}'`).join('; ');
                const stopHistoryDetails = t.stopHistory.map(h => `Stop moved to ${Utils.formatCurrency(h.newStop)} on ${Utils.formatDate(h.date)} (${h.remarks || 'N/A'})`).join('; ');
                const psychology = t.psychology ? `Emotional State: ${t.psychology.emotionalState}, Notes: ${t.psychology.notes}`: 'N/A';

                return `- **Ticker: ${t.ticker}** (Trade ID: ${t.id})
  - **Status**: ${t.status}
  - **Position & Pricing**:
    - Current Position Size: ${m.currentPositionSize} shares
    - Weighted Average Entry: ${Utils.formatCurrency(m.weightedAverageEntry)}
    - Current Price: ${t.currentPrice ? Utils.formatCurrency(t.currentPrice) : 'N/A'}
  - **Performance**:
    - Unrealized P/L: ${Utils.formatCurrency(m.unrealizedPL)}
    - Realized P/L: ${Utils.formatCurrency(m.realizedPL)}
    - Total P/L (R): ${m.totalR.toFixed(2)}R
  - **Risk Management**:
    - Initial Stop: ${Utils.formatCurrency(t.initialStop)}
    - Trailing Stop: ${t.trailingStop ? Utils.formatCurrency(t.trailingStop) : 'N/A'}
    - Current Risk (R): ${riskR.toFixed(2)}R
  - **Trade Details & History**:
    - Sector: ${t.sector || 'N/A'}
    - Tags: ${t.tags ? t.tags.join(', ') : 'N/A'}
    - Entry History: ${entryDetails || 'No entries'}
    - Exit History: ${exitDetails || 'No exits'}
    - Stop History: ${stopHistoryDetails || 'No stop changes'}
  - **Psychology**: ${psychology}
`;
            }).join('\n');

            const systemPrompt = "You are a helpful financial writer AI.";
            const userPrompt = State.settings.promptCloudDescribeHoldings.replace('{{DATA}}', dataString);
            
            const result = await API.callCloudLlm(systemPrompt, userPrompt);
            DOM['holdings-content'].innerHTML = result.startsWith('Error:') ? `<p class="text-red-500">${result}</p>` : result.replace(/\n/g, '<br>');
        },
        handleAnalyzePortfolio: async () => {
            UI.openModal(DOM['portfolio-modal']);
            DOM['portfolio-content'].innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';
            const openTrades = State.trades.filter(t => t.status === 'Open');
            if (!openTrades.length) {
                DOM['portfolio-content'].innerHTML = "<p>No open trades to analyze.</p>";
                return;
            }

            const totalUnrealizedPL = openTrades.reduce((sum, t) => sum + Calc.getTradeMetrics(t).unrealizedPL, 0);
            const tradeDetails = openTrades.map(t => {
                const m = Calc.getTradeMetrics(t);
                return `- ${t.ticker}: P/L ${Utils.formatCurrency(m.unrealizedPL)} (${m.totalR.toFixed(2)}R). Position: ${m.currentPositionSize} shares. Sector: ${t.sector || 'N/A'}`;
            }).join('\n');
            const dataString = `- Positions: ${openTrades.length}\n- Total Unrealized P/L: ${Utils.formatCurrency(totalUnrealizedPL)}\n\n**Positions:**\n${tradeDetails}`;
            
            const systemPrompt = "You are a helpful financial analyst AI.";
            const userPrompt = State.settings.promptCloudPortfolioAnalysis.replace('{{DATA}}', dataString);
            
            const result = await API.callCloudLlm(systemPrompt, userPrompt);
            DOM['portfolio-content'].innerHTML = result.startsWith('Error:') ? `<p class="text-red-500">${result}</p>` : result;
        },

        handleAnalyzeTrade: async () => {
            UI.openModal(DOM['ai-trade-modal']);
            DOM['ai-trade-content'].innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';
            
            const [ticker, entry, stop, notes] = [DOM.ticker.value, DOM['entry-price'].value, DOM['initial-stop'].value, DOM['psychology-notes'].value];
            if (!ticker || !entry || !stop) {
                DOM['ai-trade-content'].innerHTML = "<p>Ticker, Price, and Stop are required for analysis.</p>";
                return;
            }
            
            let userPrompt = State.settings.promptCloudTradeAnalysis.replace('{{TICKER}}', ticker).replace('{{ENTRY}}', entry).replace('{{STOP}}', stop).replace('{{NOTES}}', notes);
            const result = await API.callCloudLlm("You are a helpful financial analyst AI.", userPrompt);
            DOM['ai-trade-content'].innerHTML = result.startsWith('Error:') ? `<p class="text-red-500">${result}</p>` : result;
        },

        handleFindSector: async () => {
            const ticker = DOM.ticker.value;
            if (!ticker) return Utils.showAlert('Enter a ticker first.');
            UI.setLoading(DOM['btn-find-sector'], true, '');
            const userPrompt = State.settings.promptCloudFindSector.replace('{{TICKER}}', ticker);
            const result = await API.callCloudLlm("You are a helpful financial analyst AI.", userPrompt);
            if (result && !result.startsWith('Error:')) {
                DOM.sector.value = result.trim().replace(/\.$/, '');
            } else {
                Utils.showAlert(`Could not find sector. AI analysis failed. Last error: ${result}`);
            }
            UI.setLoading(DOM['btn-find-sector'], false);
        },

        handleViewStopHistory: () => {
            const select = DOM['stop-history-select'];
            select.innerHTML = '<option value="">Select a trade...</option>';
            State.trades.forEach(t => {
                select.innerHTML += `<option value="${t.id}">${t.ticker} (${Utils.formatDate(t.entries[0]?.date)})</option>`;
            });
            DOM['stop-history-content'].innerHTML = '';

            select.onchange = (e) => {
                const trade = State.trades.find(t => t.id === e.target.value);
                const content = DOM['stop-history-content'];
                if (!trade || !trade.stopHistory || trade.stopHistory.length === 0) {
                    content.innerHTML = '<p class="text-secondary text-center py-4">No stop history for this trade.</p>';
                    return;
                }
                content.innerHTML = `<table class="min-w-full">
                    <thead class="themed-bg"><tr>
                        <th class="px-4 py-2 text-left">Date</th><th class="px-4 py-2 text-left">Old Stop</th><th class="px-4 py-2 text-left">New Stop</th><th class="px-4 py-2 text-left">Remarks</th>
                    </tr></thead>
                    <tbody>${trade.stopHistory.map(h => `
                        <tr>
                            <td class="px-4 py-2 border-t">${Utils.formatDate(h.date)} ${Utils.formatTime(h.date)}</td>
                            <td class="px-4 py-2 border-t">${Utils.formatCurrency(h.oldStop)}</td>
                            <td class="px-4 py-2 border-t">${Utils.formatCurrency(h.newStop)}</td>
                            <td class="px-4 py-2 border-t">${h.remarks || 'N/A'}</td>
                        </tr>`).join('')}
                    </tbody></table>`;
            };
            UI.openModal(DOM['stop-history-modal']);
        },
        
        handleViewAdvancedStats: () => {
            const s = Calc.getAdvancedStats();
            DOM['stats-content'].innerHTML = !s ? '<p>No closed trades to analyze.</p>' :
                `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                    <div class="themed-bg p-4 rounded-lg"><h3>Performance</h3><p>Total Trades: ${s.total}</p><p class="${s.expectancy > 0 ? 'text-green-600':'text-red-600'}">Expectancy: ${Utils.formatCurrency(s.expectancy)}</p></div>
                    <div class="themed-bg p-4 rounded-lg"><h3>Win & Loss</h3><p>Wins: ${s.winners}</p><p>Losses: ${s.losers}</p></div>
                    <div class="bg-green-100 p-4 rounded-lg text-green-800"><h3>Gains</h3><p>Avg Win: ${Utils.formatCurrency(s.avgWin)}</p><p>Largest Win: ${Utils.formatCurrency(s.largestWin)}</p></div>
                    <div class="bg-red-100 p-4 rounded-lg text-red-800"><h3>Losses</h3><p>Avg Loss: ${Utils.formatCurrency(s.avgLoss)}</p><p>Largest Loss: ${Utils.formatCurrency(s.largestLoss)}</p></div>
                    <div class="themed-bg p-4 rounded-lg md:col-span-2"><h3>Holding Time</h3><p>Avg Win Hold: ${Utils.formatDuration(s.avgWinHold)}</p><p>Avg Loss Hold: ${Utils.formatDuration(s.avgLossHold)}</p></div>
                </div>`;
            UI.openModal(DOM['stats-modal']);
        },
        
        handleTradesTableClick: (e) => {
            const row = e.target.closest('tr.trade-row');
            const editButton = e.target.closest('[data-action="edit-trade"]');

            if (editButton && row) {
                e.stopPropagation();
                Events.openTradeModal(row.dataset.id);
                return;
            }

            if (row) {
                const detailsRow = row.nextElementSibling;
                if (detailsRow && detailsRow.classList.contains('trade-details-row')) {
                    detailsRow.classList.toggle('is-visible');
                    if(window.innerWidth < 1024) {
                       detailsRow.style.display = detailsRow.classList.contains('is-visible') ? 'block' : 'none';
                    }
                }
            }
        },

        handleCloudApiListClick: (e) => {
            if (!State.settings.cloudApiConfigs) State.settings.cloudApiConfigs = [];
            const action = e.target.dataset.action;
            if (!action) return;
            const row = e.target.closest('tr');
            const id = row.dataset.id;
            const config = State.settings.cloudApiConfigs.find(c => c.id === id);
            if (action === 'edit' && config) {
                DOM['cloud-api-id'].value = config.id;
                DOM['cloud-api-name'].value = config.name;
                DOM['cloud-api-key'].value = config.apiKey;
                DOM['cloud-api-base-url'].value = config.baseUrl;
                DOM['cloud-api-model'].value = config.model;
            } else if (action === 'delete') {
                Utils.showAlert(`Delete "${config.name}" API?`, 'confirm', (proceed) => {
                    if (proceed) {
                        State.settings.cloudApiConfigs = State.settings.cloudApiConfigs.filter(c => c.id !== id);
                        UI.renderCloudApiConfigs();
                    }
                });
            }
        },

        handleSaveCloudApiConfig: (e) => {
            e.preventDefault();
            const id = DOM['cloud-api-id'].value;
            const configData = {
                name: DOM['cloud-api-name'].value,
                apiKey: DOM['cloud-api-key'].value,
                baseUrl: DOM['cloud-api-base-url'].value,
                model: DOM['cloud-api-model'].value
            };
            if (id) {
                const index = State.settings.cloudApiConfigs.findIndex(c => c.id === id);
                if (index > -1) State.settings.cloudApiConfigs[index] = { ...State.settings.cloudApiConfigs[index], ...configData };
            } else {
                if (!State.settings.cloudApiConfigs) State.settings.cloudApiConfigs = [];
                State.settings.cloudApiConfigs.push({ id: `cloud-${Date.now()}`, ...configData });
            }
            UI.renderCloudApiConfigs();
            DOM['cloud-api-form'].reset();
            DOM['cloud-api-id'].value = '';
        },
        
        handleOpenCloudPrompts: () => {
            const defaults = getDefaultSettings();
            DOM['prompt-cloud-weekly-summary'].value = State.settings.promptCloudWeeklySummary || defaults.promptCloudWeeklySummary;
            DOM['prompt-cloud-describe-holdings'].value = State.settings.promptCloudDescribeHoldings || defaults.promptCloudDescribeHoldings;
            DOM['prompt-cloud-portfolio-analysis'].value = State.settings.promptCloudPortfolioAnalysis || defaults.promptCloudPortfolioAnalysis;
            DOM['prompt-cloud-trade-analysis'].value = State.settings.promptCloudTradeAnalysis || defaults.promptCloudTradeAnalysis;
            DOM['prompt-cloud-find-sector'].value = State.settings.promptCloudFindSector || defaults.promptCloudFindSector;
            
            UI.openModal(DOM['cloud-prompt-modal']);
        },
        
        handleSaveCloudPrompt: (e) => {
            e.preventDefault();
            State.settings.promptCloudWeeklySummary = DOM['prompt-cloud-weekly-summary'].value;
            State.settings.promptCloudDescribeHoldings = DOM['prompt-cloud-describe-holdings'].value;
            State.settings.promptCloudPortfolioAnalysis = DOM['prompt-cloud-portfolio-analysis'].value;
            State.settings.promptCloudTradeAnalysis = DOM['prompt-cloud-trade-analysis'].value;
            State.settings.promptCloudFindSector = DOM['prompt-cloud-find-sector'].value;
            UI.closeModal(DOM['cloud-prompt-modal']);
            Utils.showAlert('Cloud AI prompts saved.');
        },
        
        handleCloudPromptTabClick: (e) => {
            if(e.target.tagName !== 'BUTTON') return;
            DOM['cloud-prompt-tabs'].querySelectorAll('button').forEach(btn => btn.classList.replace('tab-active', 'tab-inactive'));
            e.target.classList.replace('tab-inactive', 'tab-active');
            DOM['cloud-prompt-form'].querySelectorAll('[data-tab-panel]').forEach(panel => panel.classList.add('hidden'));
            DOM['cloud-prompt-form'].querySelector(`[data-tab-panel="${e.target.dataset.tab}"]`).classList.remove('hidden');
        },
        
        handleStopSelectChange: (e) => {
            const tradeId = e.target.value;
            const trade = State.trades.find(t => t.id === tradeId);
            DOM['current-trailing-stop'].textContent = trade ? Utils.formatCurrency(trade.trailingStop || trade.initialStop) : 'N/A';
        },
        
        handleExitSelectChange: (e) => {
            const tradeId = e.target.value;
            const trade = State.trades.find(t => t.id === tradeId);
            if (trade) {
                const { currentPositionSize } = Calc.getTradeMetrics(trade);
                DOM['exit-current-position'].textContent = `${currentPositionSize} shares`;
                DOM['exit-quantity'].value = currentPositionSize;
            } else {
                DOM['exit-current-position'].textContent = 'N/A';
            }
        },
    };
    // =================================================================================
    // MODULE: App
    // Main application controller.
    // =================================================================================
    const App = {
        init: () => {
            cacheDom();
            Events.init();
            
            Chart.defaults.color = '#878A8C';
            Chart.defaults.borderColor = '#CCCCCC';

            if (State.navHistory.length === 0 && State.settings.initialCapital) {
                const d = new Date();
                d.setDate(d.getDate() - 1);
                State.navHistory.push({ 
                    date: d.toISOString().split('T')[0], 
                    nav: State.settings.initialCapital,
                    timestamp: d.toISOString() 
                });
            }
            UI.renderAll();
        },
        loadData: (data) => {
            const defaultSettings = getDefaultSettings();

            if (data.settings) {
                State.settings = { ...defaultSettings, ...data.settings };
            } else {
                State.settings = { ...defaultSettings };
            }

            if (data.trades) {
                State.trades = data.trades.map(t => ({
                    ...t,
                    entries: t.entries || [{ date: t.entryDate, price: t.entryPrice, quantity: t.position, notes: t.psychologyNotes || '' }],
                    exits: t.exits || (t.status === 'Closed' ? [{date: t.exitDate, price: t.exitPrice, quantity: t.position, notes: t.exitRemarks || ''}] : []),
                    psychology: t.psychology || { emotionalState: t.emotionalState, notes: t.psychologyNotes },
                    stopHistory: t.stopHistory || [],
                }));
            } else {
                 State.trades = [];
            }

            if (data.navHistory) {
                 State.navHistory = data.navHistory.map(item => ({ ...item, timestamp: item.timestamp || new Date(item.date).toISOString() }));
            } else {
                 State.navHistory = [];
            }
            
            if (State.navHistory.length === 0 && State.settings.initialCapital) {
                 const d = new Date();
                 d.setDate(d.getDate() - 1);
                 State.navHistory.push({ 
                     date: d.toISOString().split('T')[0], 
                     nav: State.settings.initialCapital,
                     timestamp: d.toISOString() 
                 });
            }
            
            UI.renderAll();
            Utils.showAlert('Data loaded successfully!');
        }
    };

    App.init();
});
</script>

</body>
</html>
