<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Trading Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/dist/date-fns.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; overscroll-behavior: contain; }
        .stat-card { transition: transform 0.2s ease, box-shadow 0.2s ease; border-left-width: 4px; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(-1px) scale(0.98); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .loader, .loader-sm { border: 2px solid #f3f3f3; border-top: 2px solid #3b82f6; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        .loader { width: 30px; height: 30px; border-width: 4px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .gradient-text { background: linear-gradient(to right, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .alert-modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .alert-modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .alert-modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); max-width: 90%; width: 400px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
        .alert-modal-overlay.visible .alert-modal-content { transform: scale(1); }
        
        /* Responsive Table */
        @media (max-width: 1023px) {
            #trades-table thead { display: none; }
            #trades-table, #trades-table tbody, #trades-table tr { display: block; width: 100%; }
            #trades-table tbody tr { margin-bottom: 1.5rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; background-color: #ffffff; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); cursor: pointer; }
            #trades-table tbody td { display: flex; justify-content: space-between; align-items: center; text-align: right; padding: 0.75rem 0.5rem; border-bottom: 1px solid #f1f5f9; }
            #trades-table tbody td:last-child { border-bottom: none; }
            #trades-table tbody td::before { content: attr(data-label); font-weight: 600; text-align: left; padding-right: 1rem; color: #475569; }
        }
    </style>
</head>
<body class="text-slate-800">

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="mb-8 p-6 bg-white rounded-xl shadow-md">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-slate-900 gradient-text">Trading Journal</h1>
            <p class="mt-2 text-slate-500">Track your trades, analyze your performance, and refine your strategy.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <!-- Stat Cards Grid -->
                <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="stat-card bg-white p-4 rounded-lg shadow border-blue-500 sm:col-span-2"><h3 class="text-sm font-medium text-slate-500">Total Assets</h3><p id="total-assets" class="text-2xl font-semibold mt-1">$0.00</p></div>
                    <div class="stat-card bg-white p-4 rounded-lg shadow border-slate-500"><h3 class="text-sm font-medium text-slate-500">Current Cash</h3><p id="current-cash" class="text-xl font-semibold mt-1">$0.00</p></div>
                    <div class="stat-card bg-white p-4 rounded-lg shadow border-purple-500"><h3 class="text-sm font-medium text-slate-500">Unrealized P/L</h3><p id="unrealized-pl" class="text-xl font-semibold mt-1">$0.00</p></div>
                    <div class="stat-card bg-white p-4 rounded-lg shadow border-purple-500"><h3 class="text-sm font-medium text-slate-500">Total Open P/L (R)</h3><p id="total-open-r" class="text-xl font-semibold mt-1">0.00R</p></div>
                    <div class="stat-card bg-white p-4 rounded-lg shadow border-orange-500"><h3 class="text-sm font-medium text-slate-500">Total Open Risk (R)</h3><p id="total-open-risk-card" class="text-xl font-semibold mt-1">0.00R</p></div>
                    <div class="stat-card bg-white p-4 rounded-lg shadow border-green-500"><h3 class="text-sm font-medium text-slate-500">Realized P/L</h3><p id="realized-pl" class="text-xl font-semibold mt-1">$0.00</p></div>
                    <div class="stat-card bg-white p-4 rounded-lg shadow border-green-500"><h3 class="text-sm font-medium text-slate-500">Win Rate</h3><p id="win-rate" class="text-xl font-semibold mt-1">0%</p></div>
                    <div class="stat-card bg-white p-4 rounded-lg shadow border-green-500"><h3 class="text-sm font-medium text-slate-500">Profit Factor</h3><p id="profit-factor" class="text-xl font-semibold mt-1">0.00</p></div>
                </section>

                <!-- NAV Chart -->
                <section class="bg-white p-4 md:p-6 rounded-lg shadow h-64 sm:h-80 lg:h-96">
                    <h2 class="text-xl font-bold mb-4 text-slate-800">Net Asset Value (NAV)</h2>
                    <canvas id="nav-chart"></canvas>
                </section>
            </div>

            <!-- Side Column -->
            <aside class="space-y-8">
                 <!-- Risk Exposure Dashboard -->
                <section id="risk-exposure-dashboard" class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 text-slate-800">Risk Exposure</h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="font-medium text-slate-500">High-Water Mark</span>
                            <span id="high-water-mark" class="font-semibold text-slate-800">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-slate-500">Current Drawdown</span>
                            <span id="current-drawdown" class="font-semibold text-slate-800">$0.00 (0.00%)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-slate-500">Total Open Risk</span>
                            <span id="total-open-risk" class="font-semibold text-slate-800">0.00R</span>
                        </div>
                        <div class="flex justify-between items-center mt-2 pt-3 border-t">
                            <span class="font-medium text-slate-500">Risk Zone</span>
                            <span id="risk-zone" class="px-3 py-1 text-sm font-bold rounded-full"></span>
                        </div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 text-slate-800">Data Management</h2>
                    <div class="space-y-4">
                        <button id="btn-import" class="btn w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 px-4 rounded-md">Import Data</button>
                        <input type="file" id="file-input" class="hidden" accept=".json">
                        <button id="btn-export" class="btn w-full bg-gradient-to-r from-emerald-500 to-emerald-600 text-white py-2 px-4 rounded-md">Export Data</button>
                    </div>
                </section>
                
                <section class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 text-slate-800">Actions</h2>
                    <div class="space-y-4">
                        <button id="btn-add-trade" class="btn w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-2 px-4 rounded-md">Add New Trade</button>
                        <button id="btn-update-stop" class="btn w-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-white py-2 px-4 rounded-md">Update Trailing Stop</button>
                        <button id="btn-exit-trade" class="btn w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-2 px-4 rounded-md">Exit Trade</button>
                        <button id="btn-refresh" class="btn w-full bg-gradient-to-r from-cyan-500 to-cyan-600 text-white py-2 px-4 rounded-md flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 12M20 20l-1.5-1.5A9 9 0 003.5 12"></path></svg>
                            Refresh Prices
                        </button>
                    </div>
                </section>
                
                <section class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 text-slate-800">Configuration & Analysis</h2>
                    <div class="space-y-4">
                        <button id="btn-settings" class="btn w-full bg-gradient-to-r from-indigo-500 to-indigo-600 text-white py-2 px-4 rounded-md">Set Capital & Risk</button>
                        <button id="btn-api-keys" class="btn w-full bg-slate-600 text-white py-2 px-4 rounded-md">API Key Settings</button>
                        <button id="btn-view-stats" class="btn w-full bg-gradient-to-r from-teal-500 to-teal-600 text-white py-2 px-4 rounded-md">View Advanced Stats</button>
                        <hr>
                        <button id="btn-gen-summary" class="btn w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white py-2 px-4 rounded-md">✨ Generate Weekly Summary</button>
                        <button id="btn-analyze-portfolio" class="btn w-full bg-gradient-to-r from-sky-500 to-sky-600 text-white py-2 px-4 rounded-md">📈 Analyze Current Portfolio</button>
                        <button id="btn-describe-holdings" class="btn w-full bg-gradient-to-r from-pink-500 to-rose-500 text-white py-2 px-4 rounded-md">📄 Describe Trade History</button>
                    </div>
                </section>
            </aside>
        </div>

        <section class="mt-8 bg-white p-4 md:p-6 rounded-lg shadow">
             <h2 class="text-xl font-bold mb-4 text-slate-800">Trade History</h2>
             <div class="overflow-x-auto">
                <table id="trades-table" class="min-w-full">
                    <thead id="trades-head" class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort="ticker">Ticker</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort="entryDate">Entry Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort="entryPrice">Entry Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort="currentPrice">Current Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort="position">Position</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort="initialStop">Initial Stop</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort="initialR">Initial Risk (Acct. R)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort="trailingStop">Trailing Stop</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort="plDollars">P/L $</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort="plR">P/L (Acct. R)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort="status">Status</th>
                        </tr>
                    </thead>
                    <tbody id="trades-body" class="bg-white divide-y divide-slate-200"></tbody>
                </table>
             </div>
        </section>

        <section class="mt-8 bg-white p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-4 text-slate-800">NAV History</h2>
            <nav id="nav-history-tabs" class="-mb-px flex space-x-6 border-b border-slate-200" aria-label="Tabs"></nav>
            <div id="nav-history-content" class="mt-4"></div>
        </section>
    </main>

    <!-- Modals -->
    <div id="trade-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Trade</h2>
            <form id="trade-form">
                <input type="hidden" id="trade-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="ticker" class="block text-sm font-medium">Ticker</label><input type="text" id="ticker" required class="mt-1 block w-full input"></div>
                    <div><label for="entry-date" class="block text-sm font-medium">Entry Date</label><input type="date" id="entry-date" required class="mt-1 block w-full input"></div>
                    <div><label for="entry-price" class="block text-sm font-medium">Entry Price</label><input type="number" step="any" id="entry-price" required class="mt-1 block w-full input"></div>
                    <div><label for="position" class="block text-sm font-medium">Position</label><input type="number" step="any" id="position" required class="mt-1 block w-full input"></div>
                    <div class="md:col-span-2"><label for="initial-stop" class="block text-sm font-medium">Initial Stop</label><input type="number" step="any" id="initial-stop" required class="mt-1 block w-full input"></div>
                    <div class="md:col-span-2"><label for="sector" class="block text-sm font-medium">Sector</label><div class="flex items-center space-x-2 mt-1"><input type="text" id="sector" class="block w-full input"><button type="button" id="btn-find-sector" class="btn bg-teal-100 text-teal-700 py-2 px-3 rounded-md text-sm whitespace-nowrap">✨ Find Sector</button></div></div>
                    <div class="md:col-span-2"><label for="tags" class="block text-sm font-medium">Tags (comma-separated)</label><input type="text" id="tags" class="mt-1 block w-full input"></div>
                    <div class="md:col-span-2"><label for="remarks" class="block text-sm font-medium">Remarks</label><textarea id="remarks" rows="3" class="mt-1 block w-full input"></textarea></div>
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <button type="button" id="btn-analyze-trade" class="btn bg-purple-100 text-purple-700 py-2 px-4 rounded-md">✨ Analyze</button>
                    <div><button type="button" class="btn-cancel btn bg-slate-200 py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn-save btn ml-2 bg-indigo-600 text-white py-2 px-4 rounded-md">Save</button></div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="exit-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">Exit Trade</h2>
            <form id="exit-form">
                 <div class="space-y-4">
                    <div><label for="exit-select" class="block text-sm font-medium">Select Open Trade</label><select id="exit-select" required class="mt-1 block w-full input"></select></div>
                    <div><label for="exit-date" class="block text-sm font-medium">Exit Date</label><input type="date" id="exit-date" required class="mt-1 block w-full input"></div>
                    <div><label for="exit-price" class="block text-sm font-medium">Exit Price</label><input type="number" step="any" id="exit-price" required class="mt-1 block w-full input"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-cancel btn bg-slate-200 py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn bg-red-600 text-white py-2 px-4 rounded-md">Save Exit</button></div>
            </form>
        </div>
    </div>
    
     <div id="stop-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">Update Trailing Stop</h2>
            <form id="stop-form">
                 <div class="space-y-4">
                    <div><label for="stop-select" class="block text-sm font-medium">Select Open Trade</label><select id="stop-select" required class="mt-1 block w-full input"></select></div>
                    <div><label for="new-stop" class="block text-sm font-medium">New Trailing Stop</label><input type="number" step="any" id="new-stop" required class="mt-1 block w-full input"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-cancel btn bg-slate-200 py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn bg-yellow-500 text-white py-2 px-4 rounded-md">Update Stop</button></div>
            </form>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">Account & Risk Settings</h2>
            <form id="settings-form">
                 <div class="space-y-4">
                    <h3 class="text-lg font-semibold border-b pb-2">Account</h3>
                    <div><label for="set-capital" class="block text-sm font-medium">Initial Capital</label><input type="number" id="set-capital" step="any" class="mt-1 block w-full input"></div>
                    <div><label for="set-cash" class="block text-sm font-medium">Current Cash</label><input type="number" id="set-cash" step="any" class="mt-1 block w-full input"></div>
                    
                    <h3 class="text-lg font-semibold border-b pb-2 pt-4">Risk Management</h3>
                    <div><label for="set-risk-percent" class="block text-sm font-medium">Risk Per Trade (% of Capital)</label><input type="number" id="set-risk-percent" step="0.1" class="mt-1 block w-full input"></div>
                    <div><label for="set-moderate-dd" class="block text-sm font-medium">Moderate Drawdown Threshold (%)</label><input type="number" id="set-moderate-dd" step="0.1" class="mt-1 block w-full input"></div>
                    <div><label for="set-high-risk-dd" class="block text-sm font-medium">High-Risk Drawdown Threshold (%)</label><input type="number" id="set-high-risk-dd" step="0.1" class="mt-1 block w-full input"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-cancel btn bg-slate-200 py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn bg-indigo-600 text-white py-2 px-4 rounded-md">Save</button></div>
            </form>
        </div>
    </div>
    
    <div id="api-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">API Key Settings</h2>
            <form id="api-form">
                 <div><label for="alphavantage-key" class="block text-sm font-medium">Alpha Vantage API Key</label><input type="password" id="alphavantage-key" class="mt-1 block w-full input"></div>
                 <div class="mt-4"><label for="gemini-model" class="block text-sm font-medium">Gemini AI Model</label>
                    <select id="gemini-model" class="mt-1 block w-full input">
                        <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash</option>
                        <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option>
                        <option value="gemini-1.0-pro">Gemini 1.0 Pro</option>
                    </select>
                </div>
                 <div class="mt-4"><label for="gemini-keys" class="block text-sm font-medium">Gemini API Keys (comma-separated)</label><textarea id="gemini-keys" rows="8" class="mt-1 block w-full input" placeholder="key1,key2,key3"></textarea></div>
                 <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-cancel btn bg-slate-200 py-2 px-4 rounded-md">Cancel</button><button type="submit" class="btn bg-indigo-600 text-white py-2 px-4 rounded-md">Save</button></div>
            </form>
        </div>
    </div>

    <div id="summary-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">✨ Weekly Performance Summary</h2>
            <div id="summary-content" class="prose max-w-none text-slate-700 space-y-4"></div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="btn-copy-summary" class="btn bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300">Copy</button>
                <button type="button" class="btn-cancel btn bg-indigo-600 text-white py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <div id="stats-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Advanced Statistics</h2>
            <div id="stats-content" class="prose max-w-none text-slate-700 space-y-4"></div>
            <div class="mt-6 flex justify-end"><button type="button" class="btn-cancel btn bg-indigo-600 text-white py-2 px-4 rounded-md">Close</button></div>
        </div>
    </div>

    <div id="portfolio-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">📈 Current Portfolio Analysis</h2>
            <div id="portfolio-content" class="prose max-w-none text-slate-700 space-y-4"></div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="btn-copy-portfolio" class="btn bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300">Copy</button>
                <button type="button" class="btn-cancel btn bg-indigo-600 text-white py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <div id="holdings-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">📄 Trade History Description</h2>
            <div id="holdings-content" class="prose max-w-none text-slate-700 space-y-4"></div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="btn-copy-holdings" class="btn bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300">Copy</button>
                <button type="button" class="btn-cancel btn bg-indigo-600 text-white py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>

    <div id="ai-trade-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">✨ AI Trade Analysis</h2>
            <div id="ai-trade-content" class="prose max-w-none text-slate-700 space-y-4"></div>
            <div class="mt-6 flex justify-end space-x-3">
                 <button type="button" id="btn-copy-ai-trade" class="btn bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300">Copy</button>
                <button type="button" class="btn-cancel btn bg-indigo-600 text-white py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>

    <div id="sector-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Sector Identified</h2>
            <div id="sector-content" class="text-slate-700 text-lg font-semibold text-center"></div>
            <div class="mt-6 flex justify-end"><button type="button" class="btn-cancel btn bg-indigo-600 text-white py-2 px-4 rounded-md">Close</button></div>
        </div>
    </div>
    
    <div id="alert-modal" class="alert-modal-overlay">
        <div class="alert-modal-content">
            <p id="alert-msg" class="mb-6 text-lg"></p>
            <div id="alert-ok">
                <button id="btn-alert-ok" class="btn bg-indigo-600 text-white py-2 px-6 rounded-md">OK</button>
            </div>
            <div id="alert-confirm" class="hidden justify-center gap-4">
                <button id="btn-confirm-cancel" class="btn bg-slate-200 py-2 px-6 rounded-md">Cancel</button>
                <button id="btn-confirm-ok" class="btn bg-red-600 text-white py-2 px-6 rounded-md">Proceed</button>
            </div>
        </div>
    </div>

<script>
// --- APP INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    const App = (() => {
        // --- STATE ---
        const state = {
            trades: [],
            navHistory: [],
            navChart: null,
            settings: { 
                initialCapital: 10, 
                currentCash: 10,
                highWaterMark: 10,
                riskPerTradePercentage: 0.8,      // Default: 0.8% risk per trade
                moderateDrawdownThreshold: 5,   // Default: 5%
                highRiskDrawdownThreshold: 10,  // Default: 10%
                apiKeys: [],
                alphaVantageKey: '',
                currentApiKeyIndex: 0, // Start with the first key
                geminiModel: 'gemini-1.5-flash-latest' // Aligned with UI
            },
            sort: { key: 'entryDate', dir: 'desc' }
        };

        // --- DOM ELEMENTS ---
        const dom = {};
        const cacheDom = () => {
            const ids = [
                'total-assets', 'current-cash', 'unrealized-pl', 'total-open-r', 'total-open-risk-card',
                'realized-pl', 'win-rate', 'profit-factor', 'nav-chart', 'btn-import', 'file-input', 
                'btn-export', 'btn-add-trade', 'btn-update-stop', 'btn-exit-trade', 'btn-refresh', 
                'btn-settings', 'btn-api-keys', 'btn-view-stats', 'btn-gen-summary', 'btn-analyze-portfolio',
                'btn-describe-holdings',
                'high-water-mark', 'current-drawdown', 'risk-zone', 'total-open-risk',
                'trades-table', 'trades-head', 'trades-body', 'nav-history-tabs', 'nav-history-content',
                'trade-modal', 'modal-title', 'trade-form', 'trade-id', 'ticker', 'entry-date', 'entry-price', 
                'position', 'initial-stop', 'sector', 'tags', 'remarks', 'btn-find-sector', 'btn-analyze-trade',
                'exit-modal', 'exit-form', 'exit-select', 'exit-date', 'exit-price',
                'stop-modal', 'stop-form', 'stop-select', 'new-stop',
                'settings-modal', 'settings-form', 'set-capital', 'set-cash', 'set-risk-percent', 'set-moderate-dd', 'set-high-risk-dd',
                'api-modal', 'api-form', 'alphavantage-key', 'gemini-model', 'gemini-keys',
                'summary-modal', 'summary-content', 'stats-modal', 'stats-content',
                'portfolio-modal', 'portfolio-content', 'holdings-modal', 'holdings-content', 'btn-copy-holdings',
                'ai-trade-modal', 'ai-trade-content',
                'sector-modal', 'sector-content', 'alert-modal', 'alert-msg', 'alert-ok',
                'btn-alert-ok', 'alert-confirm', 'btn-confirm-cancel', 'btn-confirm-ok',
                'btn-copy-summary', 'btn-copy-portfolio', 'btn-copy-ai-trade'
            ];
            ids.forEach(id => dom[id] = document.getElementById(id));
            dom.modalCancelButtons = document.querySelectorAll('.btn-cancel');
        };

        // --- UTILS ---
        const util = {
            formatCurrency: (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0),
            formatDate: (dateStr) => {
                if (!dateStr) return 'N/A';
                const d = new Date(dateStr);
                return new Date(d.getTime() + d.getTimezoneOffset() * 60000).toLocaleDateString('en-CA');
            },
            formatTime: (isoString) => {
                if (!isoString) return '';
                return new Date(isoString).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            },
            formatDuration: (ms) => {
                if (ms < 0 || isNaN(ms)) return 'N/A';
                const d = Math.floor(ms / 864e5), h = Math.floor(ms % 864e5 / 36e5), m = Math.floor(ms % 36e5 / 6e4);
                return [d && `${d}d`, h && `${h}h`, m && `${m}m`].filter(Boolean).join(' ') || '0m';
            },
            showAlert: (msg, type = 'alert', cb) => {
                dom['alert-msg'].innerHTML = msg;
                const okDiv = dom['alert-ok'];
                const confirmDiv = dom['alert-confirm'];
                
                if (type === 'confirm') {
                    okDiv.classList.add('hidden');
                    confirmDiv.classList.remove('hidden');
                    confirmDiv.style.display = 'flex';
                    dom['btn-confirm-ok'].onclick = () => { util.closeAlert(); cb?.(true); };
                    dom['btn-confirm-cancel'].onclick = () => { util.closeAlert(); cb?.(false); };
                } else {
                    confirmDiv.classList.add('hidden');
                    okDiv.classList.remove('hidden');
                    dom['btn-alert-ok'].onclick = () => { util.closeAlert(); cb?.(true); };
                }
                dom['alert-modal'].classList.add('visible');
            },
            closeAlert: () => dom['alert-modal'].classList.remove('visible'),
            copyToClipboard: (text, message = 'Copied to clipboard!') => {
                if (!text) {
                    util.showAlert('Nothing to copy.');
                    return;
                }
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    util.showAlert(message);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    util.showAlert('Failed to copy text.');
                }
                document.body.removeChild(textArea);
            }
        };
        
        // --- API ---
        const api = {
            callGemini: async (prompt, targetElId) => {
                const { apiKeys, geminiModel } = state.settings;
                if (apiKeys.length === 0) {
                    util.showAlert('Please configure your Gemini API keys in Settings.');
                    return "No API Key configured.";
                }

                if (dom[targetElId]) dom[targetElId].innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';
                
                const initialKeyIndex = state.settings.currentApiKeyIndex;

                for (let i = 0; i < apiKeys.length; i++) {
                    const keyIndex = (initialKeyIndex + i) % apiKeys.length;
                    const key = apiKeys[keyIndex];
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${key}`;
                    
                    try {
                        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                        
                        if (res.ok) {
                            const result = await res.json();
                            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (text) {
                                state.settings.currentApiKeyIndex = (keyIndex + 1) % apiKeys.length;
                                return text; 
                            }
                        }
                        const errorData = await res.json().catch(() => ({}));
                        console.error(`Key index ${keyIndex} (...${key.slice(-4)}): Status ${res.status}. ${errorData?.error?.message || 'Unknown error.'}`);

                    } catch (error) {
                        console.error(`Key index ${keyIndex} (...${key.slice(-4)}): Network Error - ${error.message}`);
                    }
                }
                
                const finalUserMessage = `All API keys failed. Please check your keys or the browser console for details.`;
                if (dom[targetElId]) dom[targetElId].innerHTML = `<p class="text-red-500">${finalUserMessage}</p>`;
                util.showAlert(finalUserMessage);
                return "All API keys failed.";
            },
            refreshPrices: async () => {
                const openTrades = state.trades.filter(t => t.status === 'Open');
                if (!openTrades.length) return util.showAlert('No open trades to refresh.');
                if (!state.settings.alphaVantageKey) return util.showAlert('Alpha Vantage API key is not set.');
                
                ui.setLoading(dom['btn-refresh'], true, 'Refreshing...');
                const errorMessages = new Set();

                for (const trade of openTrades) {
                    try {
                        const symbol = trade.ticker.trim();
                        const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${state.settings.alphaVantageKey}`;
                        
                        const res = await fetch(url);
                        const data = await res.json();
                        
                        const price = data?.['Global Quote']?.['05. price'];
                        if (price) {
                            trade.currentPrice = parseFloat(price);
                        } else {
                            const errorMessage = data.Note || data['Error Message'] || `Could not find price for ${trade.ticker}.`;
                            errorMessages.add(errorMessage);
                            console.warn(`Price fetch issue for ${trade.ticker}:`, data);
                        }
                    } catch (error) {
                        console.error(`Error fetching price for ${trade.ticker}:`, error);
                        errorMessages.add(`Network error for ${trade.ticker}. Check console.`);
                    }

                    if (openTrades.indexOf(trade) < openTrades.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 12000));
                    }
                }

                calc.recordNavPoint(); // Record NAV once after all prices are fetched
                ui.render();
                
                if (errorMessages.size > 0) {
                    util.showAlert(`Price refresh completed with some issues:<br>- ${Array.from(errorMessages).join('<br>- ')}`);
                } else {
                    util.showAlert('All prices refreshed successfully!');
                }
                
                ui.setLoading(dom['btn-refresh'], false);
            }
        };

        // --- CALCULATIONS ---
        const calc = {
            getTradeMetrics: (trade) => {
                const { initialCapital, riskPerTradePercentage } = state.settings;
                // Standard 1R value for the entire account
                const accountRValue = initialCapital * (riskPerTradePercentage / 100);

                const metrics = {
                    tradeRiskInDollars: 0,
                    initialR: 0, // This will be the R-multiple of the trade's risk relative to account R
                    realizedPL: 0, 
                    realizedR: 0, // P/L expressed as a multiple of the standard Account R
                    unrealizedPL: 0, 
                    unrealizedR: 0 // P/L expressed as a multiple of the standard Account R
                };

                if (!trade.entryPrice || !trade.initialStop || !trade.position) {
                    return metrics;
                }

                // The actual dollar risk taken on this specific trade
                metrics.tradeRiskInDollars = (trade.entryPrice - trade.initialStop) * trade.position;
                
                // Calculate the trade's risk as a multiple of the standard Account R
                if (accountRValue > 0) {
                    metrics.initialR = metrics.tradeRiskInDollars / accountRValue;
                }
                
                if (trade.status === 'Open' && trade.currentPrice) {
                    metrics.unrealizedPL = (trade.currentPrice - trade.entryPrice) * trade.position;
                     // P/L as a multiple of the standard Account R value
                    if (accountRValue > 0) metrics.unrealizedR = metrics.unrealizedPL / accountRValue;
                } else if (trade.status === 'Closed' && trade.exitPrice) {
                    metrics.realizedPL = (trade.exitPrice - trade.entryPrice) * trade.position;
                    // P/L as a multiple of the standard Account R value
                    if (accountRValue > 0) metrics.realizedR = metrics.realizedPL / accountRValue;
                }
                return metrics;
            },
            getCurrentRiskR: (trade) => {
                if (trade.status !== 'Open') return 0;

                const { initialCapital, riskPerTradePercentage } = state.settings;
                const accountRValue = initialCapital * (riskPerTradePercentage / 100);
                if (accountRValue <= 0) return 0;

                let riskInDollars = 0;

                // If a valid trailing stop and current price exist, calculate risk from current price to trailing stop.
                if (trade.trailingStop && trade.currentPrice > 0 && trade.position > 0) {
                    riskInDollars = (trade.currentPrice - trade.trailingStop) * trade.position;
                    return riskInDollars / accountRValue;
                } else { 
                    // Otherwise, fall back to the initial risk of the trade.
                    return calc.getTradeMetrics(trade).initialR;
                }
            },
            getRiskMetrics: () => {
                const openValue = state.trades.filter(t => t.status === 'Open').reduce((s, t) => s + ((t.currentPrice || t.entryPrice) * t.position), 0);
                const nav = state.settings.currentCash + openValue;
                
                state.settings.highWaterMark = Math.max(state.settings.highWaterMark || nav, nav);

                const drawdownDollars = state.settings.highWaterMark - nav;
                const drawdownPercent = state.settings.highWaterMark > 0 ? (drawdownDollars / state.settings.highWaterMark) * 100 : 0;

                return {
                    nav,
                    hwm: state.settings.highWaterMark,
                    drawdownDollars,
                    drawdownPercent,
                };
            },
            getRiskZone: (totalOpenRiskR) => {
                if (totalOpenRiskR > 6) return 'Red';
                if (totalOpenRiskR > 3) return 'Yellow';
                return 'Green';
            },
            getAdvancedStats: () => {
                const closed = state.trades.filter(t => t.status === 'Closed');
                if (!closed.length) return null;
                const winners = closed.filter(t => calc.getTradeMetrics(t).realizedPL > 0);
                const losers = closed.filter(t => calc.getTradeMetrics(t).realizedPL <= 0);
                const winRate = closed.length ? winners.length / closed.length : 0;
                const totalGains = winners.reduce((s, t) => s + calc.getTradeMetrics(t).realizedPL, 0);
                const avgWin = winners.length ? totalGains / winners.length : 0;
                const totalLosses = losers.reduce((s, t) => s + calc.getTradeMetrics(t).realizedPL, 0);
                const avgLoss = losers.length ? Math.abs(totalLosses / losers.length) : 0;
                return {
                    total: closed.length,
                    expectancy: (winRate * avgWin) - ((1 - winRate) * avgLoss),
                    winners: winners.length,
                    losers: losers.length,
                    avgWin: avgWin,
                    largestWin: winners.reduce((max, t) => Math.max(max, calc.getTradeMetrics(t).realizedPL), 0),
                    avgLoss: avgLoss,
                    largestLoss: losers.reduce((min, t) => Math.min(min, calc.getTradeMetrics(t).realizedPL), 0),
                    avgWinHold: winners.length ? winners.reduce((s, t) => s + (new Date(t.exitDate) - new Date(t.entryDate)), 0) / winners.length : 0,
                    avgLossHold: losers.length ? losers.reduce((s, t) => s + (new Date(t.exitDate) - new Date(t.entryDate)), 0) / losers.length : 0,
                };
            },
            recordNavPoint: () => {
                const { nav } = calc.getRiskMetrics();
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const timestamp = now.toISOString();

                const idx = state.navHistory.findIndex(e => e.date === today);
                if (idx > -1) {
                    // Update the latest NAV and timestamp for the day
                    state.navHistory[idx].nav = parseFloat(nav.toFixed(2));
                    state.navHistory[idx].timestamp = timestamp;
                } else {
                    // Add a new entry for the day
                    state.navHistory.push({ date: today, nav: parseFloat(nav.toFixed(2)), timestamp: timestamp });
                }
                // Sort by date, which is sufficient as there's only one entry per date
                state.navHistory.sort((a,b) => new Date(a.date) - new Date(b.date));
            }
        };

        // --- UI ---
        const ui = {
            render: () => { ui.updateDashboard(); ui.renderTrades(); ui.renderNavChart(); ui.renderNavHistory(); },
            openModal: (el) => { el.classList.remove('hidden'); setTimeout(() => el.classList.remove('opacity-0'), 10); },
            closeModal: (el) => { el.classList.add('opacity-0'); setTimeout(() => el.classList.add('hidden'), 300); },
            setLoading: (btn, loading, text = '') => {
                if (loading) {
                    btn.originalHTML = btn.innerHTML;
                    btn.innerHTML = `<span class="flex items-center justify-center"><div class="loader-sm"></div><span class="ml-2">${text}</span></span>`;
                    btn.disabled = true;
                } else {
                    if (btn.originalHTML) btn.innerHTML = btn.originalHTML;
                    btn.disabled = false;
                }
            },
            updateDashboard: () => {
                let realizedPL = 0, unrealizedPL = 0, totalOpenPL_R = 0, totalOpenRisk_R = 0, wins = 0, totalGains = 0, totalLossesAbs = 0;
                const closed = state.trades.filter(t => t.status === 'Closed');
                
                state.trades.forEach(t => {
                    const metrics = calc.getTradeMetrics(t);
                    if (t.status === 'Open') {
                        unrealizedPL += metrics.unrealizedPL;
                        totalOpenPL_R += metrics.unrealizedR;
                        totalOpenRisk_R += calc.getCurrentRiskR(t);
                    } else {
                        realizedPL += metrics.realizedPL;
                        if (metrics.realizedPL > 0) { wins++; totalGains += metrics.realizedPL; }
                        else totalLossesAbs += Math.abs(metrics.realizedPL);
                    }
                });
                
                const riskMetrics = calc.getRiskMetrics();
                const riskZone = calc.getRiskZone(totalOpenRisk_R);
                ui.renderRiskDashboard(riskMetrics, totalOpenRisk_R, riskZone);
                
                dom['total-assets'].textContent = util.formatCurrency(riskMetrics.nav);
                dom['current-cash'].textContent = util.formatCurrency(state.settings.currentCash);
                dom['realized-pl'].textContent = util.formatCurrency(realizedPL);
                dom['realized-pl'].classList.toggle('text-red-600', realizedPL < 0);
                dom['unrealized-pl'].textContent = util.formatCurrency(unrealizedPL);
                dom['unrealized-pl'].classList.toggle('text-red-600', unrealizedPL < 0);
                dom['total-open-r'].textContent = `${totalOpenPL_R.toFixed(2)}R`;
                dom['total-open-risk-card'].textContent = `${totalOpenRisk_R.toFixed(2)}R`;
                dom['win-rate'].textContent = `${(closed.length ? (wins / closed.length) * 100 : 0).toFixed(1)}%`;
                dom['profit-factor'].textContent = (totalLossesAbs > 0 ? totalGains / totalLossesAbs : 0).toFixed(2);
            },
            renderRiskDashboard: (riskMetrics, totalOpenRiskR, riskZone) => {
                const { hwm, drawdownDollars, drawdownPercent } = riskMetrics;
                dom['high-water-mark'].textContent = util.formatCurrency(hwm);
                dom['current-drawdown'].textContent = `${util.formatCurrency(drawdownDollars)} (${drawdownPercent.toFixed(2)}%)`;
                dom['total-open-risk'].textContent = `${(totalOpenRiskR || 0).toFixed(2)}R`;

                const zoneEl = dom['risk-zone'];
                zoneEl.textContent = riskZone;
                zoneEl.className = 'px-3 py-1 text-sm font-bold rounded-full'; // Reset classes
                if (riskZone === 'Green') zoneEl.classList.add('bg-green-100', 'text-green-800');
                else if (riskZone === 'Yellow') zoneEl.classList.add('bg-yellow-100', 'text-yellow-800');
                else zoneEl.classList.add('bg-red-100', 'text-red-800');
            },
            renderTrades: () => {
                const tradesWithMetrics = state.trades.map(trade => ({
                    ...trade,
                    metrics: calc.getTradeMetrics(trade)
                }));

                const { key, dir } = state.sort;
                tradesWithMetrics.sort((a, b) => {
                    const metricsA = a.metrics;
                    const metricsB = b.metrics;
                    let valA, valB;

                    switch(key) {
                        case 'plDollars':
                            valA = a.status === 'Closed' ? metricsA.realizedPL : metricsA.unrealizedPL;
                            valB = b.status === 'Closed' ? metricsB.realizedPL : metricsB.unrealizedPL;
                            break;
                        case 'plR':
                            valA = a.status === 'Closed' ? metricsA.realizedR : metricsA.unrealizedR;
                            valB = b.status === 'Closed' ? metricsB.realizedR : metricsB.unrealizedR;
                            break;
                        case 'initialR':
                            valA = metricsA.initialR;
                            valB = metricsB.initialR;
                            break;
                        default:
                            valA = a[key];
                            valB = b[key];
                    }
                    
                    if (valA === undefined || valA === null) return 1; if (valB === undefined || valB === null) return -1;
                    const comp = key.includes('Date') ? new Date(valA) - new Date(valB) : typeof valA === 'number' ? valA - valB : String(valA).localeCompare(String(valB));
                    return dir === 'asc' ? comp : -comp;
                });

                ui.updateSortIndicators();

                dom['trades-body'].innerHTML = tradesWithMetrics.map(tradeWithMetrics => {
                    const { metrics, ...trade } = tradeWithMetrics;
                    const pl = trade.status === 'Closed' ? metrics.realizedPL : metrics.unrealizedPL;
                    const r = trade.status === 'Closed' ? metrics.realizedR : metrics.unrealizedR;
                    const plClass = pl >= 0 ? 'text-green-600' : 'text-red-600';
                    const statusClass = trade.status === 'Open' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800';
                    return `
                        <tr data-id="${trade.id}" class="hover:bg-slate-50 cursor-pointer">
                            <td data-label="Ticker" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${trade.ticker}</td>
                            <td data-label="Entry Date" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${util.formatDate(trade.entryDate)}</td>
                            <td data-label="Entry Price" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${util.formatCurrency(trade.entryPrice)}</td>
                            <td data-label="Current Price" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${trade.currentPrice ? util.formatCurrency(trade.currentPrice) : 'N/A'}</td>
                            <td data-label="Position" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${trade.position || 'N/A'}</td>
                            <td data-label="Initial Stop" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${trade.initialStop ? util.formatCurrency(trade.initialStop) : 'N/A'}</td>
                            <td data-label="Initial Risk (Acct. R)" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${metrics.initialR.toFixed(2)}R</td>
                            <td data-label="Trailing Stop" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${trade.trailingStop ? util.formatCurrency(trade.trailingStop) : 'N/A'}</td>
                            <td data-label="P/L $" class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${plClass}">${util.formatCurrency(pl)}</td>
                            <td data-label="P/L (Acct. R)" class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${plClass}">${r.toFixed(2)}R</td>
                            <td data-label="Status" class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${trade.status}</span></td>
                        </tr>
                    `;
                }).join('');

                if (!tradesWithMetrics.length) dom['trades-body'].innerHTML = `<tr><td colspan="11" class="text-center py-8 text-slate-500">No trades to display.</td></tr>`;
            },
            updateSortIndicators: () => {
                dom['trades-head'].querySelectorAll('th.sortable').forEach(th => {
                    th.removeAttribute('data-sort-dir');
                    if(th.dataset.sort === state.sort.key) th.setAttribute('data-sort-dir', state.sort.dir);
                });
            },
            renderNavChart: () => {
                const ctx = dom['nav-chart'].getContext('2d');
                const data = state.navHistory.map(item => ({ x: new Date(item.date).getTime(), y: item.nav }));
                if (state.navChart) state.navChart.destroy();
                state.navChart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets: [{ label: 'NAV', data, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', borderWidth: 2, pointRadius: data.length < 50 ? 3 : 0, fill: true, tension: 0.1 }] },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { 
                            x: { 
                                type: 'time', 
                                time: { 
                                    unit: 'day', 
                                    tooltipFormat: 'MMM dd,yyyy' 
                                }
                            }, 
                            y: { 
                                ticks: { 
                                    callback: v => util.formatCurrency(v) 
                                }
                            }
                        }, 
                        plugins: { 
                            tooltip: { 
                                callbacks: { 
                                    label: c => `NAV: ${util.formatCurrency(c.parsed.y)}` 
                                }
                            }
                        } 
                    }
                });
            },
            renderNavHistory: () => {
                if (typeof window.dateFns === 'undefined') {
                    console.warn("date-fns library not loaded yet, skipping NAV history render.");
                    return; 
                }

                const tabsContainer = dom['nav-history-tabs'];
                const contentContainer = dom['nav-history-content'];
                tabsContainer.innerHTML = '';
                contentContainer.innerHTML = '';
                
                if (state.navHistory.length === 0) {
                    contentContainer.innerHTML = '<p class="text-center py-4 text-slate-500">NAV history starts recording after closing trades or refreshing prices.</p>';
                    return;
                }

                const grouped = state.navHistory.reduce((acc, item) => {
                    const monthKey = window.dateFns.format(new Date(item.date), 'yyyy-MM');
                    if (!acc[monthKey]) acc[monthKey] = [];
                    acc[monthKey].push(item);
                    return acc;
                }, {});

                const sortedMonthKeys = Object.keys(grouped).sort().reverse();

                sortedMonthKeys.forEach((key, index) => {
                    const monthDisplay = window.dateFns.format(new Date(key), 'MMM yy');
                    const isActive = index === 0;
                    tabsContainer.innerHTML += `<a href="#" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${isActive ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}" data-month="${key}">${monthDisplay}</a>`;
                    
                    const tableRows = grouped[key].sort((a,b) => new Date(b.date) - new Date(a.date)).map(item => `<tr><td class="px-6 py-4">${util.formatDate(item.date)}</td><td class="px-6 py-4 text-sm text-slate-500">${util.formatTime(item.timestamp)}</td><td class="px-6 py-4">${util.formatCurrency(item.nav)}</td></tr>`).join('');
                    contentContainer.innerHTML += `
                        <div id="nav-content-${key}" class="overflow-x-auto ${isActive ? '' : 'hidden'}">
                            <table class="min-w-full divide-y divide-slate-200 mt-4">
                                <thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Date</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Last Update</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">NAV</th></tr></thead>
                                <tbody class="bg-white divide-y divide-slate-200">${tableRows}</tbody>
                            </table>
                        </div>
                    `;
                });

                tabsContainer.addEventListener('click', events.handleNavTabClick);
            },
            showAdvancedStats: () => {
                const s = calc.getAdvancedStats();
                dom['stats-content'].innerHTML = !s ? '<p>No closed trades to analyze.</p>' :
                    `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                        <div class="bg-slate-50 p-4 rounded-lg"><h3>Performance</h3><p>Total Trades: ${s.total}</p><p class="${s.expectancy > 0 ? 'text-green-600':'text-red-600'}">Expectancy: ${util.formatCurrency(s.expectancy)}</p></div>
                        <div class="bg-slate-50 p-4 rounded-lg"><h3>Win & Loss</h3><p>Wins: ${s.winners}</p><p>Losses: ${s.losers}</p></div>
                        <div class="bg-green-50 p-4 rounded-lg text-green-800"><h3>Gains</h3><p>Avg Win: ${util.formatCurrency(s.avgWin)}</p><p>Largest Win: ${util.formatCurrency(s.largestWin)}</p></div>
                        <div class="bg-red-50 p-4 rounded-lg text-red-800"><h3>Losses</h3><p>Avg Loss: ${util.formatCurrency(s.avgLoss)}</p><p>Largest Loss: ${util.formatCurrency(s.largestLoss)}</p></div>
                        <div class="bg-slate-50 p-4 rounded-lg md:col-span-2"><h3>Holding Time</h3><p>Avg Win Hold: ${util.formatDuration(s.avgWinHold)}</p><p>Avg Loss Hold: ${util.formatDuration(s.avgLossHold)}</p></div>
                    </div>`;
                ui.openModal(dom['stats-modal']);
            },
            populateOpenTradesDropdown: (selectId) => {
                const sel = dom[selectId];
                sel.innerHTML = '<option value="">Select a trade...</option>';
                state.trades.filter(t => t.status === 'Open').forEach(t => sel.innerHTML += `<option value="${t.id}">${t.ticker} (${util.formatDate(t.entryDate)})</option>`);
            }
        };

        // --- EVENTS ---
        const events = {
            init: () => {
                // Main action buttons
                dom['btn-add-trade'].onclick = events.handleAddTradeClick;
                dom['btn-exit-trade'].onclick = () => { ui.populateOpenTradesDropdown('exit-select'); ui.openModal(dom['exit-modal']); };
                dom['btn-update-stop'].onclick = () => { ui.populateOpenTradesDropdown('stop-select'); ui.openModal(dom['stop-modal']); };
                dom['btn-settings'].onclick = () => {
                    dom['set-capital'].value = state.settings.initialCapital;
                    dom['set-cash'].value = state.settings.currentCash;
                    dom['set-risk-percent'].value = state.settings.riskPerTradePercentage;
                    dom['set-moderate-dd'].value = state.settings.moderateDrawdownThreshold;
                    dom['set-high-risk-dd'].value = state.settings.highRiskDrawdownThreshold;
                    ui.openModal(dom['settings-modal']);
                };
                dom['btn-api-keys'].onclick = () => { 
                    dom['alphavantage-key'].value = state.settings.alphaVantageKey; 
                    dom['gemini-model'].value = state.settings.geminiModel; 
                    dom['gemini-keys'].value = state.settings.apiKeys.join(', '); // Join with comma and space
                    ui.openModal(dom['api-modal']); 
                };

                // Data & Analysis buttons
                dom['btn-import'].onclick = () => dom['file-input'].click();
                dom['file-input'].onchange = events.handleImport;
                dom['btn-export'].onclick = events.handleExport;
                dom['btn-refresh'].onclick = api.refreshPrices;
                dom['btn-view-stats'].onclick = ui.showAdvancedStats;
                dom['btn-gen-summary'].onclick = events.handleGenSummary;
                dom['btn-analyze-portfolio'].onclick = events.handleAnalyzePortfolio;
                dom['btn-describe-holdings'].onclick = events.handleDescribeHoldings;
                
                // Form submissions
                dom['trade-form'].onsubmit = events.handleSaveTrade;
                dom['exit-form'].onsubmit = events.handleSaveExit;
                dom['stop-form'].onsubmit = events.handleSaveStop;
                dom['settings-form'].onsubmit = events.handleSaveSettings;
                dom['api-form'].onsubmit = events.handleSaveApiKeys;

                // Table interactions
                dom['trades-head'].onclick = events.handleSort;
                dom['trades-body'].onclick = events.handleEditTrade;

                // Modal specific buttons
                dom['btn-find-sector'].onclick = events.handleFindSector;
                dom['btn-analyze-trade'].onclick = events.handleAnalyzeTrade;
                dom.modalCancelButtons.forEach(btn => btn.onclick = () => ui.closeModal(btn.closest('.modal-overlay')));
                dom['btn-copy-summary'].onclick = () => util.copyToClipboard(dom['summary-content'].innerText);
                dom['btn-copy-portfolio'].onclick = () => util.copyToClipboard(dom['portfolio-content'].innerText);
                dom['btn-copy-holdings'].onclick = () => util.copyToClipboard(dom['holdings-content'].innerText);
                dom['btn-copy-ai-trade'].onclick = () => util.copyToClipboard(dom['ai-trade-content'].innerText);
            },
            handleAddTradeClick: () => {
                const totalOpenRisk_R = state.trades.filter(t => t.status === 'Open').reduce((sum, t) => sum + calc.getCurrentRiskR(t), 0);
                const riskZone = calc.getRiskZone(totalOpenRisk_R);

                if (riskZone === 'Red') {
                    util.showAlert('HIGH RISK: Your total open risk exposure exceeds 6R. New trades are restricted.');
                    return;
                }
                if (riskZone === 'Yellow') {
                    util.showAlert('CAUTION: Your total open risk exposure exceeds 3R. Are you sure you want to add a new position?', 'confirm', (proceed) => {
                        if (proceed) {
                            dom['trade-form'].reset(); 
                            dom['modal-title'].textContent = 'Add New Trade'; 
                            dom['trade-id'].value = ''; 
                            ui.openModal(dom['trade-modal']);
                        }
                    });
                    return;
                }
                // Green Zone: proceed as normal
                dom['trade-form'].reset(); 
                dom['modal-title'].textContent = 'Add New Trade'; 
                dom['trade-id'].value = ''; 
                ui.openModal(dom['trade-modal']);
            },
            handleNavTabClick: (e) => {
                e.preventDefault();
                const clickedButton = e.target.closest('a');
                if (!clickedButton) return;
                
                dom['nav-history-tabs'].querySelectorAll('a').forEach(btn => {
                    btn.classList.remove('border-indigo-500', 'text-indigo-600');
                    btn.classList.add('border-transparent', 'text-slate-500');
                });
                dom['nav-history-content'].querySelectorAll('div[id^="nav-content-"]').forEach(div => div.classList.add('hidden'));

                clickedButton.classList.add('border-indigo-500', 'text-indigo-600');
                dom[`nav-content-${clickedButton.dataset.month}`].classList.remove('hidden');
            },
            handleSaveTrade: (e) => {
                e.preventDefault();
                const id = dom['trade-id'].value;
                const tradeData = {
                    ticker: dom.ticker.value.toUpperCase().trim(),
                    entryDate: dom['entry-date'].value,
                    entryPrice: parseFloat(dom['entry-price'].value),
                    position: parseInt(dom.position.value),
                    initialStop: parseFloat(dom['initial-stop'].value),
                    sector: dom.sector.value,
                    remarks: dom.remarks.value,
                    tags: dom.tags.value.split(',').map(t => t.trim()).filter(Boolean)
                };
                if (id) {
                    Object.assign(state.trades.find(t => t.id === id), tradeData);
                } else {
                    state.trades.push({ ...tradeData, id: `trade-${Date.now()}`, status: 'Open', currentPrice: null });
                }
                ui.closeModal(dom['trade-modal']);
                calc.recordNavPoint();
                ui.render();
            },
            handleSaveExit: (e) => {
                e.preventDefault();
                const trade = state.trades.find(t => t.id === dom['exit-select'].value);
                if (trade) {
                    trade.status = 'Closed';
                    trade.exitDate = dom['exit-date'].value;
                    trade.exitPrice = parseFloat(dom['exit-price'].value);
                    const metrics = calc.getTradeMetrics(trade);
                    state.settings.currentCash += metrics.realizedPL;
                    calc.recordNavPoint();
                    ui.closeModal(dom['exit-modal']);
                    ui.render();
                }
            },
            handleSaveStop: (e) => { 
                e.preventDefault(); 
                const trade = state.trades.find(t => t.id === dom['stop-select'].value); 
                if(trade) { 
                    trade.trailingStop = parseFloat(dom['new-stop'].value); 
                    ui.closeModal(dom['stop-modal']); 
                    ui.render(); 
                } 
            },
            handleSaveSettings: (e) => { 
                e.preventDefault(); 
                state.settings.initialCapital = parseFloat(dom['set-capital'].value); 
                state.settings.currentCash = parseFloat(dom['set-cash'].value); 
                state.settings.riskPerTradePercentage = parseFloat(dom['set-risk-percent'].value);
                state.settings.moderateDrawdownThreshold = parseFloat(dom['set-moderate-dd'].value);
                state.settings.highRiskDrawdownThreshold = parseFloat(dom['set-high-risk-dd'].value);
                
                // Reset High Water Mark if initial capital changes
                state.settings.highWaterMark = state.settings.initialCapital;
                calc.recordNavPoint();

                ui.closeModal(dom['settings-modal']); 
                ui.render(); 
            },
            handleSaveApiKeys: (e) => { 
                e.preventDefault(); 
                state.settings.alphaVantageKey = dom['alphavantage-key'].value.trim(); 
                state.settings.geminiModel = dom['gemini-model'].value; 
                state.settings.apiKeys = dom['gemini-keys'].value.split(',').map(k => k.trim()).filter(Boolean); // Split by comma
                state.settings.currentApiKeyIndex = 0; 
                ui.closeModal(dom['api-modal']); 
                util.showAlert(`API keys saved.`); 
            },
            handleImport: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data || !data.settings || !data.trades || !data.navHistory) throw new Error("Invalid or incomplete data format");
                        
                        const defaultSettings = {
                            highWaterMark: data.settings.initialCapital,
                            riskPerTradePercentage: 1.0,
                            moderateDrawdownThreshold: 5,
                            highRiskDrawdownThreshold: 10,
                        };
                        state.settings = { ...defaultSettings, ...data.settings };
                        
                        state.trades = data.trades;
                        state.navHistory = data.navHistory.map(item => {
                            if (!item.timestamp) {
                                return { ...item, timestamp: new Date(item.date).toISOString() };
                            }
                            return item;
                        });

                        ui.render();
                        util.showAlert('Data imported successfully!');
                    } catch (err) { 
                        util.showAlert(`Import failed: ${err.message}`); 
                        console.error("Import Error:", err);
                    }
                };
                reader.readAsText(file);
            },
            handleExport: () => {
                const data = JSON.stringify({
                    settings: state.settings,
                    trades: state.trades,
                    navHistory: state.navHistory
                }, null, 2);
                
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([data], {type: 'application/json'}));
                a.download = `trading_journal_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
            },
            handleSort: (e) => {
                const th = e.target.closest('th.sortable');
                if (th) {
                    const key = th.dataset.sort;
                    if (state.sort.key === key) state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
                    else { state.sort.key = key; state.sort.dir = 'desc'; }
                    ui.renderTrades();
                }
            },
            handleEditTrade: (e) => {
                const row = e.target.closest('tr[data-id]');
                if (row) {
                    const trade = state.trades.find(t => t.id === row.dataset.id);
                    if (trade) {
                        dom['modal-title'].textContent = 'Edit Trade';
                        dom['trade-id'].value = trade.id;
                        dom.ticker.value = trade.ticker;
                        dom['entry-date'].value = trade.entryDate;
                        dom['entry-price'].value = trade.entryPrice;
                        dom.position.value = trade.position;
                        dom['initial-stop'].value = trade.initialStop;
                        dom.sector.value = trade.sector || '';
                        dom.tags.value = trade.tags ? trade.tags.join(', ') : '';
                        dom.remarks.value = trade.remarks || '';
                        ui.openModal(dom['trade-modal']);
                    }
                }
            },
            handleGenSummary: async () => {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const recentTrades = state.trades.filter(t => t.status === 'Closed' && new Date(t.exitDate) >= oneWeekAgo);
                if (!recentTrades.length) return util.showAlert("No closed trades in the last 7 days.");
                
                const stats = recentTrades.map(calc.getTradeMetrics);
                const totalPL = stats.reduce((sum, s) => sum + s.realizedPL, 0);
                const totalR = stats.reduce((sum, s) => sum + s.realizedR, 0);
                const winRate = (recentTrades.filter(t => calc.getTradeMetrics(t).realizedPL > 0).length / recentTrades.length) * 100;
                
                const prompt = `Generate a weekly trading performance summary based on this data:\n- Total Trades: ${recentTrades.length}\n- Total P/L: ${util.formatCurrency(totalPL)}\n- Total R-Multiple: ${totalR.toFixed(2)}R\n- Win Rate: ${winRate.toFixed(1)}%\n\nProvide brief, insightful commentary on the performance.`;
                ui.openModal(dom['summary-modal']);
                dom['summary-content'].innerHTML = await api.callGemini(prompt, 'summary-content');
            },
            handleAnalyzePortfolio: async () => {
                const openTrades = state.trades.filter(t => t.status === 'Open');
                if (!openTrades.length) return util.showAlert("No open trades to analyze.");

                const totalUnrealizedPL = openTrades.reduce((sum, t) => sum + calc.getTradeMetrics(t).unrealizedPL, 0);
                const tradeDetails = openTrades.map(t => {
                    const m = calc.getTradeMetrics(t);
                    return `- ${t.ticker}: P/L ${util.formatCurrency(m.unrealizedPL)} (${m.unrealizedR.toFixed(2)}R). Remarks: "${t.remarks || 'None'}".`;
                }).join('\n');
                const prompt = `Analyze this open portfolio:\n\n**Overview:**\n- Positions: ${openTrades.length}\n- Total Unrealized P/L: ${util.formatCurrency(totalUnrealizedPL)}\n\n**Positions:**\n${tradeDetails}\n\n**Request:**\n1. Analyze concentration risk.\n2. Note strengths/weaknesses.\n3. Pose 1-2 insightful questions for me to consider.`;

                ui.openModal(dom['portfolio-modal']);
                dom['portfolio-content'].innerHTML = await api.callGemini(prompt, 'portfolio-content');
            },
             handleDescribeHoldings: async () => {
                const allTrades = state.trades;
                if (!allTrades.length) return util.showAlert("No trade history to describe.");

                const tradeDetails = allTrades.map(t => {
                    const metrics = calc.getTradeMetrics(t);
                    const pl = t.status === 'Closed' ? metrics.realizedPL : metrics.unrealizedPL;
                    const r = t.status === 'Closed' ? metrics.realizedR : metrics.unrealizedR;
                    return `For ticker ${t.ticker}, the trade status is ${t.status}. Entry was on ${util.formatDate(t.entryDate)} at a price of ${util.formatCurrency(t.entryPrice)} with a position size of ${t.position}. The initial stop was ${util.formatCurrency(t.initialStop)}. ` +
                           (t.trailingStop ? `The trailing stop is currently ${util.formatCurrency(t.trailingStop)}. ` : '') +
                           (t.status === 'Closed' ? `The exit was on ${util.formatDate(t.exitDate)} at ${util.formatCurrency(t.exitPrice)}. ` : `The current price is ${t.currentPrice ? util.formatCurrency(t.currentPrice) : 'N/A'}. `) +
                           `The final P/L is ${util.formatCurrency(pl)}, which is ${r.toFixed(2)}R. My remarks were: '${t.remarks || 'None'}'.`;
                }).join(' ');

                const prompt = `Please combine the following sentences into a single, cohesive paragraph without adding any analysis or summary. Present the information in a straightforward, factual manner.\n\nData:\n${tradeDetails}`;
                
                ui.openModal(dom['holdings-modal']);
                dom['holdings-modal'].querySelector('h2').textContent = '📄 Trade History Description';
                dom['holdings-content'].innerHTML = await api.callGemini(prompt, 'holdings-content');
            },
            handleAnalyzeTrade: async () => {
                const [ticker, entry, stop, remarks] = [dom.ticker.value, dom['entry-price'].value, dom['initial-stop'].value, dom.remarks.value];
                if (!ticker || !entry || !stop) return util.showAlert("Ticker, Entry, and Stop are required for analysis.");
                
                const prompt = `Analyze this trade setup:\n- Ticker: ${ticker}\n- Entry: ${entry}\n- Stop: ${stop}\n- Remarks: "${remarks}"\n\nWhat is a potential rationale and what are the risks? Be concise.`;
                ui.openModal(dom['ai-trade-modal']);
                dom['ai-trade-content'].innerHTML = await api.callGemini(prompt, 'ai-trade-content');
            },
            handleFindSector: async () => {
                const ticker = dom.ticker.value;
                if (!ticker) return util.showAlert('Enter a ticker first.');
                ui.setLoading(dom['btn-find-sector'], true, '');
                const prompt = `GICS sector for ticker ${ticker}? Respond with only the sector name.`;
                const result = await api.callGemini(prompt, 'sector-content');
                const sector = result.trim().replace(/\.$/, '');
                dom.sector.value = sector;
                dom['sector-content'].textContent = sector;
                ui.openModal(dom['sector-modal']);
                ui.setLoading(dom['btn-find-sector'], false);
            }
        };

        // --- MAIN INIT ---
        const init = () => {
            cacheDom();
            events.init();
            if (state.navHistory.length === 0 && state.settings.initialCapital) {
                const d = new Date();
                d.setDate(d.getDate() - 1);
                const dateStr = d.toISOString().split('T')[0];
                state.navHistory.push({ date: dateStr, nav: state.settings.initialCapital, timestamp: d.toISOString() });
            }
            ui.render();
        };

        return { init };
    })();

    App.init();
});
</script>

</body>
</html>
